<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="Scripts to unpack Android applications protected by Tencent Legu"><meta name=keywords content="android"><meta property="og:type" content="article"><meta property="og:description" content="Scripts to unpack Android applications protected by Tencent Legu"><meta property="og:title" content="Tencent Legu Unpacker | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/project/legu_unpacker/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/project/legu_unpacker/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2020-01-23T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content="android"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Tencent Legu Unpacker | Romain Thomas"><meta name=twitter:description content="Scripts to unpack Android applications protected by Tencent Legu"><meta name=twitter:domain content="https://www.romainthomas.fr/project/legu_unpacker/"><meta property="twitter:image" content="https://www.romainthomas.fr/project/legu_unpacker/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/project/legu_unpacker/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="min-vh-100 d-flex align-items-center section-image overlay-soft-dark bg-primary"><div class=container><div class="row justify-content-center"><div class="col-12 align-items-center justify-content-center"><div class="me-4 mt-6 m-lg-6 bg-white shadow-soft border rounded border-gray-300 p-4 p-lg-5 fmxw-md-100"><div class="col-12 ext-center mb-4"><h2 class=display-3>Tencent Legu Unpacker</h2><p class=mb-0>January 23, 2020</p></div><div class="col-12 col-md-10"><a href=https://github.com/quarkslab/legu_unpacker_2019 target=_blank><button class="btn btn-pill btn-outline-primary mb-2" type=button>
<span class=me-1><span class="fab fa-github"></span></span> Sources</button></a>
<a href=https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/ target=_blank><button class="btn btn-pill btn-outline-primary mb-2" type=button>
<span class=me-1><span class="fas fa-link"></span></span> Blog Post</button></a></div><article class="container mt-4"><h1 id=legu-unpacker>Legu Unpacker</h1><p>Scripts to unpack Android applications protected by Tencent Legu. It only works with versions
<strong>4.1.0.15</strong> and <strong>4.1.0.18</strong> of Legu.</p><p>Blog post: https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/</p><h2 id=overview>Overview</h2><p>The original DEX files are located in <code>assets/0OO00l111l1l</code> with the following layout:</p><p align=center><img src=packed_file.png><br></p><p>One can find the details of this structure in the Kaitai file: <a href=https://github.com/quarkslab/legu_unpacker_2019/tree/7b4aec6d223dfb24a60bb99151b15d0df76ea6fa/legu_packed_file.ksy>legu_packed_file.ks</a></p><p>The <em>hashmap</em> embedded in the second part is described in the <a href=https://github.com/quarkslab/legu_unpacker_2019/tree/7b4aec6d223dfb24a60bb99151b15d0df76ea6fa/>legu_hashmap.ks</a> file:</p><p align=center><img src=hashmap.png><br></p><h2 id=pylegu>pylegu</h2><p><a href=https://github.com/quarkslab/legu_unpacker_2019/tree/7b4aec6d223dfb24a60bb99151b15d0df76ea6fa/pylegu>pylegu</a> contains the Python bindings to decrypt and uncompress the data embedded in <code>assets/0OO00l111l1l</code>.</p><p>To compile and install <code>pylegu</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:green>cd</span> pylegu
</span></span><span style=display:flex><span>$ python3.7 ./setup.py build -j4 install --user
</span></span><span style=display:flex><span>$ python -c <span style=color:#ba2121>&#34;import pylegu&#34;</span>
</span></span></code></pre></div><p>One could also use <a href=https://github.com/jap/pyucl>jap/pyucl</a> to decompress the data and <a href=https://github.com/aguinet/dragonffi>aguinet/dragonffi</a> to bind the custom implementation of XTEA.</p><h2 id=get-started>Get Started</h2><p>The sample <a href=./samples/com.intotherain.voicechange.apk>com.intotherain.voicechange.apk</a> is a <a href=https://www.virustotal.com/gui/file/708e6967920dcf2789b7183d714e73ab79a2f8b3ca71929b12aadeb2c58c2867/detection>suspicious application</a>
that can be unpacked as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python ./unpack.py ./samples/com.intotherain.voicechange.apk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Legu version: 4.1.0.15
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Password is <span style=color:#ba2121>&#39;IPk2Hw7AKTuIQBlc&#39;</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Number of dex files: <span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Unpacking <span style=color:#408080;font-style:italic>#1 DEX files ...</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> dex <span style=color:#666>0</span> compressed size:   0x1619a3
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> dex <span style=color:#666>0</span> uncompressed size: 0x5671f8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Unpacking <span style=color:#408080;font-style:italic>#1 hashmap ...</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> hashmap <span style=color:#666>0</span> compressed size:   0x4399c
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> hashmap <span style=color:#666>0</span> uncompressed size: 0x95558
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Unpacking <span style=color:#408080;font-style:italic>#1 packed methods ...</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> packed methods <span style=color:#666>0</span> compressed_size:   0xf4636
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> packed methods <span style=color:#666>0</span> uncompressed_size: 0x1e3072
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Stage 2: Patching DEX files
</span></span><span style=display:flex><span><span style=color:#666>[</span>+<span style=color:#666>]</span> Unpacked APK: unpacked.apk
</span></span></code></pre></div><p>The unpacked DEX files are located in the <code>unpacked.apk</code> file.</p><h2 id=requirements>Requirements</h2><ul><li>Python >= 3.7</li><li>Kaitai Struct</li><li>LIEF</li><li>pylegu</li></ul></article></div></div></div></div></section></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script>function katex_load(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})}</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=katex_load()></script></body></html>