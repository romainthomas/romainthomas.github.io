<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO."><meta name=keywords content="Android,reverse engineering,obfuscation"><meta property="og:type" content="article"><meta property="og:description" content="This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO."><meta property="og:title" content="PGSharp: Analysis of a Cheating App for PokemonGO | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-11-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="reverse engineering"><meta property="article:tag" content="obfuscation"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="PGSharp: Analysis of a Cheating App for PokemonGO | Romain Thomas"><meta name=twitter:description content="This blog post is about the internal mechanisms of PGSharp, a cheat engine for PokemonGO."><meta name=twitter:domain content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/21-11-pgsharp-analysis/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/post/21-11-pgsharp-analysis/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4><a href=/categories/android/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Android</span>
</a><a href=/categories/reverse-engineering/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Reverse Engineering</span></a></div><h1 class="display-3 mb-4 px-lg-5">PGSharp: Analysis of a Cheating App for PokemonGO</h1><div class=post-meta><span class="fw-bold me-3">Romain Thomas</span>
<span class="post-date me-3">November 7, 2021</span>
<span class=fw-bold>25 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/21-11-pgsharp-analysis/featured.png class="rounded img-fluid" alt=featured.png></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><style>.green{color:green;font-family:fira code,monospace}.blue{color:blue;font-family:fira code,monospace}.orange{color:tomato;font-family:fira code,monospace}.red{color:#c02032;font-family:fira code,monospace}a.ul{color:#c02032!important}.hl-comment{color:#df2b04;font-family:fira code,monospace}.hl-keyword{color:#a90d91;font-family:fira code,monospace}.hl-literal{color:#1c01ce;font-family:fira code,monospace}.hl-preproc{color:#633820;font-family:fira code,monospace}.hl-strings{color:#c41a16;font-family:fira code,monospace}.yellow{color:#cc7000;font-family:fira code,monospace}</style><h2 id=introduction>Introduction</h2><p>A few days after the release of the blog post <a href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/><em>Gotta Catch &lsquo;Em All: Frida & jailbreak detection</em></a>, someone on <a href=https://www.reddit.com/r/ReverseEngineering/comments/on6ya9/comment/h5rhkoc/>reddit - r/ReverseEngineering</a>
caught my attention on a cheating app for the Android version of PokemonGO:</p><p><img src=reddit.png alt="reddit comment about PGSharp"></p><p>So here it is!</p><p>PGSharp belongs to the family of PokemonGO&rsquo;s cheating app that is not (yet) banned by Niantic.
This cheat provides an <em>enhanced</em> game experience with interesting functionalities such as:</p><ul><li>GPS Spoofing</li><li>Quick Catch</li><li>Pokemon Feed</li><li>Nearby Radar</li><li>&mldr;</li></ul><p>Last but not least, PGSharp runs on regular devices, <strong>rooted or not</strong>.</p><p>This cheat made my weekends for the last 4 months and, from a technical point of view, it was worth it.
As will be discussed through this blog post, PGSharp uses several interesting tricks.</p><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=border:none!important;background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fas fa-circle-info" style=color:#084298></span></div></div><div class=ps-4 style=color:#084298><h3 class="h5 m-0 mb-1" style=color:#084298>Note</h3><p>The content of this blog post is based on <strong>PGSharp 1.33.0</strong> which is related to the following APKs:</p><p><i class="fas fa-gamepad"></i> <a href=https://data.romainthomas.fr/21-09-pgsharp/pgs1.33.0.apk>PGSharp v1.33.0</a></p><p><i class="fas fa-gamepad"></i> <a href=https://data.romainthomas.fr/21-09-pgsharp/com.nianticlabs.pokemongo_0.221.0-2021093001.apk>PokemonGO v0.221.0</a></p></div></div></div></div><p>This blog post is quite <strong>long</strong> but the different parts are
more or less independents, so feel free to jump on them depending on your interests:</p><p><span id=toc></span></p><ul><li><a href=#code-protection><i class='fas fa-shield-alt'></i>  Code Protection</a><ul><li><a href=#lua-vm>Lua VM</a></li><li><a href=#java-obfuscation>Java Obfuscation</a></li></ul></li><li><a href=#cheat-mechanisms><i class='fas fa-cogs'></i>  Cheat Mechanisms</a><ul><li><a href=#dex-files-diff>DEX Files Comparison</a></li><li><a href=#libmain>libmain.so</a></li><li><a href=#signature-bypass>Signature Bypass</a></li><li><a href=#dynamic-apk-loading>Dynamic APK Loading</a></li><li><a href=#gps-spoofing>GPS Spoofing</a></li><li><a href=#jnienv-proxifier>JNIEnv Proxifier</a></li><li><a href=#unity-hooks>Unity Hooks</a></li><li><a href=#network>Network Communications</a></li><li><a href=#safetynet>SafetyNet</a></li><li><a href=#pgsharp-signature-check>When PGSharp avoids PokemonGO pitfalls</a></li></ul></li><li><a href=#final-words><i class='fas fa-power-off'></i>  Final Words</a></li><li><a href=#acknowledgments><i class='fas fa-stream'></i>  Acknowledgments</a></li><li><a href=#annexes><i class='fas fa-clipboard'></i>  Annexes</a></li></ul><p>You can also check the slides to get an overview of the content:</p><div class="pdfpreview shortcode shortcode--pdfpreview mb-4"><embed src=/publication/21-ekoparty-mobile-hacking-space-pgsharp/21-10-ekoparty-mobile-hacking-space-pgsharp.pdf type=application/pdf width=100% height=450px></div><center><br><br><p><b>Enjoy!</b></p></center><h2 id=code-protection><a href=#toc><i class='fas fa-angle-up'></i>  Code Protection</a></h2><p>PokemonGO is a target of choice for reverse engineers and some critical functionalities are protected by a commercial solution.
It is worth mentioning that only a subset of the game is obfuscated. For instance, the &ldquo;Java&rdquo; part of the
game is absolutely not protected, such as we have the original class and method names.
The Unity part is &ldquo;compiled&rdquo; into <code>libil2cpp.so</code> but we can recover some metadata with <a href=https://github.com/Perfare/Il2CppDumper>Perfare/Il2CppDumper</a>.</p><p>All the obfuscation is focused on <code>libNianticLabsPlugin.so</code> (c.f. <a href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/><em>Gotta Catch &lsquo;Em All: Frida & jailbreak detection</em></a>),
and since only this part of the game is heavily obfuscated, it gives a hint about where the critical functionalities are.</p><p>On the other hand, PGSharp uses different layers of obfuscation to prevent its analysis.
First of all, it uses O-LLVM to obfuscate the native code that includes, at least, control-flow flattening and
string encryption. Nevertheless, the obfuscation is <em>relatively</em> weak against emulation and static analysis<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><h3 id=lua-vm><a href=#toc><i class='fas fa-angle-up'></i>  Lua VM</a></h3><p>Some obfuscation techniques are based on transforming the original code through a VM (like <a href=https://vmpsoft.com/>VMProtect</a>).
It adds another layer to reverse, as we need to understand the VM architecture before being able to understand the original semantic of the code.</p><center><b><p>But what about using an interpreted language (like Python) and obfuscate its VM or its interpreter with O-LLVM?</p></b><br></center><p>This is what PGSharp does with Lua. Some parts of the cheat are written in Lua whose VM has been modified to:</p><ol><li>Fake the version: try to make believe <code>Lua 5.1</code> while it&rsquo;s <code>Lua 5.3</code></li><li>Add new opcodes (<code>OP_RUN</code>, <code>OP_GETDOWNVAL</code>, <code>OP_OLDTABLE</code>, and <code>OP_XXOR</code>) to break decompilation and
common Lua tools.</li></ol><p>The native library that implements the cheat functionalities and that contains the Lua VM being stripped, one of the
challenges lies in recognizing the Lua C API among the library&rsquo;s functions<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. For instance,
here is a basic block of a native function that uses the Lua API:</p><p><img src=lua_func_re.png alt="Stripped PGSharp function"></p><p>Among all the Lua C functions, some of them are worth identifying to ease reverse engineering:</p><ul><li><dl><dt><code>luaL_loadbuffer</code></dt><dd><blockquote><p><em>&ldquo;Load a buffer as a Lua chunk.&rdquo;</em>.</p></blockquote></dd><dd><p>Basically, it loads a Lua bytecode from a buffer given in parameter.
This Lua bytecode is the result of the <em>compilation</em> of the original script with <a href=https://www.lua.org/manual/5.3/luac.html>luac</a>.
By hooking this function, we can recover the following files:</p><ul><li><span class=orange>base64.luac</span></li><li><span class=green>class.luac</span></li><li><span class=green>global.luac</span></li><li><span class=green>init.luac</span></li><li><span class=orange>json.luac - from <a href=https://github.com/rxi/json.lua>https://github.com/rxi/json.lua</a></span></li><li><span class=green>location.luac</span></li><li><span class=orange>md5.luac - from <a href=https://github.com/kikito/md5.lua>https://github.com/kikito/md5.lua</a></span></li><li><span class=green>pgo.luac</span></li><li><span class=green>pgodump.luac</span></li><li><span class=green>plugin.luac</span></li><li><span class=green>reflect.luac</span></li></ul></dd></dl><p>The <span class=orange>orange files</span> are utilities, while the <span class=green>green ones</span>
contain cheat mechanisms.</p></li><li><dl><dt><code>luaD_precall</code></dt><dd>Function that is involved when calling a C native function or a pure Lua function.
Since its prototype is <span class=blue>(lua_State *L, StkId func, int nresults)</span>,
it can help to dynamically identify which function is called:</dd></dl><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x6776a8 luaD_precall(&#39;gamehelper&#39;)
</span></span><span style=display:flex><span>0x6776a8 luaD_precall(&#39;@./app/arm64-v8a/luac/global.lua:0 - sub_71733ea5d0&#39;) {
</span></span><span style=display:flex><span>0x694d90 luaD_precall(&#39;@./app/arm64-v8a/luac/global.lua:246 - sub_71733f7b50&#39;) {
</span></span><span style=display:flex><span>0x6776a8 luaD_precall(&#39;@./app/arm64-v8a/luac/location.lua:38 - sub_717346d650&#39;) {
</span></span></code></pre></div></li><li><dl><dt><code>lua_pushcclosure</code></dt><dd><blockquote><p>Pushes a new C closure onto the stack.</p></blockquote></dd><dd><p>This function is particularly interesting to recover
native C functions linked to Lua function:</p></dd></dl><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x0e9cc0: lua_pushcclosure(&#39;initil2cppmethods&#39;)
</span></span><span style=display:flex><span>0x0e9cd4: lua_setfield(-2, &#39;initil2cppmethods&#39;, &#39;func_0xedaa0&#39;)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>0x0e9d10: lua_pushcclosure(&#39;nar&#39;)
</span></span><span style=display:flex><span>0x0e9d24: lua_setfield(-2, &#39;nar&#39;, &#39;func_0xeddbc&#39;)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>0x0ea020: lua_pushcclosure(&#39;ipf&#39;)
</span></span><span style=display:flex><span>0x0ea034: lua_setfield(-2, &#39;ipf&#39;, &#39;func_0x1318b0&#39;)
</span></span></code></pre></div></li><li><dl><dt><code>lua_pushstring</code></dt><dd><blockquote><p><em>&ldquo;Pushes the zero-terminated string pointed to by s onto the stack.&rdquo;</em></p></blockquote></dd><dd><p>This function enables to dynamically recover strings that might not be present
in the native code or somehow encoded:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x0ebdfc: lua_pushstring(&#39;https://tens.pgsharp.com/v1/scc-2-[...]/&#39;)
</span></span><span style=display:flex><span>0x0ebe28: lua_pushstring(&#39;me.uw.hela.pref&#39;)
</span></span><span style=display:flex><span>0x0c56ac: lua_pushstring(&#39;AIza[...]XhM4&#39;)
</span></span><span style=display:flex><span>0x0e15b4: lua_pushstring(&#39;token=[Redacted]&#39;)
</span></span></code></pre></div></dd></dl></li></ul><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff><p>To dynamically understand the behavior of the Lua VM, we can compile the Frida Gum SDK along with Lua v5.3.</p><p>It enables to hook Lua functions with Frida and to leverage the compiled Lua v5.3 to inspect the parameters:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>extern</span> <span style=color:#ba2121>&#34;C&#34;</span> {
</span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&#34;lua.h&#34;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&#34;ldo.h&#34;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&#34;ldebug.h&#34;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gum_interceptor_attach(listener_<span style=color:#666>-&gt;</span>interceptor,
</span></span><span style=display:flex><span>                       luaD_precall_addr, listener_ luaD_precall_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>native_listener_on_enter</span>(GumInvocationListener <span style=color:#666>*</span>listener, GumInvocationContext<span style=color:#666>*</span> ic) {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span><span style=color:#666>*</span> L <span style=color:#666>=</span> <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span>lua_State<span style=color:#666>*&gt;</span>(ic<span style=color:#666>-&gt;</span>cpu_context<span style=color:#666>-&gt;</span>x[<span style=color:#666>0</span>]);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> func <span style=color:#666>=</span> <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span>StkId<span style=color:#666>&gt;</span>(ic<span style=color:#666>-&gt;</span>cpu_context<span style=color:#666>-&gt;</span>x[<span style=color:#666>1</span>]);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> narg <span style=color:#666>=</span> <span style=color:green;font-weight:700>static_cast</span><span style=color:#666>&lt;</span><span style=color:#b00040>int</span><span style=color:#666>&gt;</span>(ic<span style=color:#666>-&gt;</span>cpu_context<span style=color:#666>-&gt;</span>x[<span style=color:#666>2</span>]);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (ttype(func) <span style=color:#666>!=</span> LUA_TLCL) {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> log(<span style=color:#ba2121>&#34;sub_{:x}&#34;</span>, ptr);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  Proto <span style=color:#666>*</span>p <span style=color:#666>=</span> clLvalue(func)<span style=color:#666>-&gt;</span>p;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> log(<span style=color:#ba2121>&#34;{}:{:d} - sub_{:x}&#34;</span>, getstr(p<span style=color:#666>-&gt;</span>source), p<span style=color:#666>-&gt;</span>linedefined, ptr);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><h3 id=java-obfuscation><a href=#toc><i class='fas fa-angle-up'></i>  Java Obfuscation</a></h3><p>Contrary to the PokemonGO&rsquo;s Java layer, PGSharp protects its Java code with Proguard and the strings are xored
with the hardcoded key:</p><center><p><b class=orange><p>vqGqQWCVnDRrNXTR</b></p><br></center><p>This key seems to not change across the different versions of PGSharp and the encoded strings look
like this:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>q</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  String a <span style=color:#666>=</span> GL<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;FAQgLiQlLw==&#34;</span><span style=color:#666>),</span> <span style=color:#666>(</span>String<span style=color:#666>)</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>a <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    JSONObject jSONObject <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> JSONObject<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    Context context <span style=color:#666>=</span> GL<span style=color:#666>.</span><span style=color:#7d9029>c</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Agg3FA==&#34;</span><span style=color:#666>),</span> r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Axg=&#34;</span><span style=color:#666>));</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Axgj&#34;</span><span style=color:#666>),</span> UI<span style=color:#666>.</span><span style=color:#7d9029>g</span><span style=color:#666>(</span>context<span style=color:#666>));</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;BQUmBTQ=&#34;</span><span style=color:#666>),</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>s</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;BQEoHjc+LTE=&#34;</span><span style=color:#666>),</span> <span style=color:#666>((</span>Boolean<span style=color:#666>)</span> <span style=color:#666>...);</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;BAUr&#34;</span><span style=color:#666>),</span> UI<span style=color:#666>.</span><span style=color:#7d9029>f</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Gh8g&#34;</span><span style=color:#666>),</span> Locale<span style=color:#666>.</span><span style=color:#7d9029>getDefault</span><span style=color:#666>().</span><span style=color:#7d9029>getDisplayLanguage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;FxMu&#34;</span><span style=color:#666>),</span> UI<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;FBA1&#34;</span><span style=color:#666>),</span> LayoutInflater$Factory2o<span style=color:#666>.</span><span style=color:#7d9029>i</span><span style=color:#666>.</span><span style=color:#7d9029>e</span><span style=color:#666>(</span>context<span style=color:#666>));</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span>r3<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;Gx4j&#34;</span><span style=color:#666>),</span> Build<span style=color:#666>.</span><span style=color:#7d9029>MODEL</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    String str <span style=color:#666>=</span> Build<span style=color:#666>.</span><span style=color:#7d9029>VERSION</span><span style=color:#666>.</span><span style=color:#7d9029>RELEASE</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>The string encoding routine being easy to reverse, we can create a Jadx plugin
that automatically decodes these strings:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#666>[...]</span>
</span></span><span style=display:flex><span>passes<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> SimplifyVisitor<span style=color:#666>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>passes<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> PGSharpString<span style=color:#666>());</span> <span style=color:#408080;font-style:italic>// Automatically decode the strings
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>passes<span style=color:#666>.</span><span style=color:#7d9029>add</span><span style=color:#666>(</span><span style=color:green;font-weight:700>new</span> CheckRegions<span style=color:#666>());</span>
</span></span><span style=display:flex><span><span style=color:#666>[...]</span>
</span></span></code></pre></div><p>It results in this kind of output:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>q</span><span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  String a <span style=color:#666>=</span> GL<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;bug_url&#34;</span><span style=color:#666>,</span> <span style=color:#666>(</span>String<span style=color:#666>)</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>a <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    JSONObject jSONObject <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> JSONObject<span style=color:#666>();</span>
</span></span><span style=display:flex><span>    Context context <span style=color:#666>=</span> GL<span style=color:#666>.</span><span style=color:#7d9029>c</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;type&#34;</span><span style=color:#666>,</span> <span style=color:#ba2121>&#34;ui&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;uid&#34;</span><span style=color:#666>,</span> UI<span style=color:#666>.</span><span style=color:#7d9029>g</span><span style=color:#666>(</span>context<span style=color:#666>));</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;state&#34;</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>s</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;spoofing&#34;</span><span style=color:#666>,</span> <span style=color:#666>((</span>Boolean<span style=color:#666>)</span> PL<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;hlspoofing&#34;</span><span style=color:#666>)).</span><span style=color:#7d9029>booleanValue</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;rtl&#34;</span><span style=color:#666>,</span> UI<span style=color:#666>.</span><span style=color:#7d9029>f</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;lng&#34;</span><span style=color:#666>,</span> Locale<span style=color:#666>.</span><span style=color:#7d9029>getDefault</span><span style=color:#666>().</span><span style=color:#7d9029>getDisplayLanguage</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;abi&#34;</span><span style=color:#666>,</span> UI<span style=color:#666>.</span><span style=color:#7d9029>a</span><span style=color:#666>());</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;bar&#34;</span><span style=color:#666>,</span> LayoutInflater$Factory2o<span style=color:#666>.</span><span style=color:#7d9029>i</span><span style=color:#666>.</span><span style=color:#7d9029>e</span><span style=color:#666>(</span>context<span style=color:#666>));</span>
</span></span><span style=display:flex><span>    jSONObject<span style=color:#666>.</span><span style=color:#7d9029>put</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;mod&#34;</span><span style=color:#666>,</span> Build<span style=color:#666>.</span><span style=color:#7d9029>MODEL</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>    String str <span style=color:#666>=</span> Build<span style=color:#666>.</span><span style=color:#7d9029>VERSION</span><span style=color:#666>.</span><span style=color:#7d9029>RELEASE</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>You can find the whole Jadx <em>plugin</em> on Github: <a href=https://github.com/romainthomas/pgsharp/blob/9addafbb6672571d2b7fbba43899f662c21aac8e/jadx/PGSharpStrings.java>PGSharpStrings.java</a></p><hr width=50%><h2 id=cheat-mechanisms><a href=#toc><i class='fas fa-angle-up'></i>  Cheat Mechanisms</a></h2><p>One <del>disruptive</del> feature of PGSharp is that it does not require a rooted device. Until recently,
most of the PokemonGO cheating apps required a jailbroken or a rooted device which raises a barrier
for people who are not familiar with rooting.</p><blockquote><p>But wait, how <em>hell</em> they do that?</p></blockquote><p>The structure of the PGSharp APK is <strong>very</strong> close to the genuine PokemonGO
application, which leads identifying which parts of the game have been tampered with.</p><p>A naive comparison (cf. <a href=https://github.com/romainthomas/pgsharp/blob/9addafbb6672571d2b7fbba43899f662c21aac8e/zip_diff.py>zip_diff.py</a>) raises mismatches on the following files:</p><table><thead><tr><th style=text-align:left>File</th><th style=text-align:left>Size in PGSharp</th><th style=text-align:left>Size in PGO</th><th style=text-align:left>Delta</th></tr></thead><tbody><tr><td style=text-align:left>classes.dex</td><td style=text-align:left>9057844</td><td style=text-align:left>8953000</td><td style=text-align:left>+1.17%</td></tr><tr><td style=text-align:left>classes2.dex</td><td style=text-align:left>7131864</td><td style=text-align:left>7107296</td><td style=text-align:left>+0.34%</td></tr><tr><td style=text-align:left>lib/arm64-v8a/libmain.so</td><td style=text-align:left>21278480</td><td style=text-align:left>6424</td><td style=text-align:left>+331134%</td></tr><tr><td style=text-align:left>META-INF/MANIFEST.MF</td><td style=text-align:left>351045</td><td style=text-align:left>355533</td><td style=text-align:left>-1.26%</td></tr></tbody></table><p>The high level of similarity between the two applications, associated with a different signature
confirms that PGSharp repackaged the original application.</p><h4 id=dex-files-diff><a href=#toc><i class='fas fa-angle-up'></i>  DEX Files Comparison</a></h4><p>To figure out which parts of the DEX files have been modified, we can use LIEF (yes, LIEF can <u><b>read</b></u> the DEX format).
Basically, the idea is to check which method(s) has a bytecode whose size is different from the real PokemonGO
application:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>zipfile</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>with</span> zipfile<span style=color:#666>.</span>ZipFile(CHEAT_FILE) <span style=color:green;font-weight:700>as</span> zip_file:
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>with</span> zip_file<span style=color:#666>.</span>open(target) <span style=color:green;font-weight:700>as</span> f:
</span></span><span style=display:flex><span>        hela_dex <span style=color:#666>=</span> f<span style=color:#666>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>with</span> zipfile<span style=color:#666>.</span>ZipFile(ORIG_FILE) <span style=color:green;font-weight:700>as</span> zip_file:
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>with</span> zip_file<span style=color:#666>.</span>open(target) <span style=color:green;font-weight:700>as</span> f:
</span></span><span style=display:flex><span>        pgo_dex <span style=color:#666>=</span> f<span style=color:#666>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hela_dex <span style=color:#666>=</span> lief<span style=color:#666>.</span>DEX<span style=color:#666>.</span>parse(<span style=color:green>list</span>(hela_dex))
</span></span><span style=display:flex><span>pgo_dex  <span style=color:#666>=</span> lief<span style=color:#666>.</span>DEX<span style=color:#666>.</span>parse(<span style=color:green>list</span>(pgo_dex))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hela <span style=color:#666>=</span> {<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>cls<span style=color:#666>.</span>pretty_name<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>.</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>name<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>.</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>prototype<span style=color:#b68;font-weight:700>!s}</span><span style=color:#ba2121>&#34;</span>: <span style=color:green>len</span>(m<span style=color:#666>.</span>bytecode) \
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>for</span> m <span style=color:#a2f;font-weight:700>in</span> hela_dex<span style=color:#666>.</span>methods}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pgo  <span style=color:#666>=</span> {<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>cls<span style=color:#666>.</span>pretty_name<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>.</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>name<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>.</span><span style=color:#b68;font-weight:700>{</span>m<span style=color:#666>.</span>prototype<span style=color:#b68;font-weight:700>!s}</span><span style=color:#ba2121>&#34;</span>: <span style=color:green>len</span>(m<span style=color:#666>.</span>bytecode) \
</span></span><span style=display:flex><span>          <span style=color:green;font-weight:700>for</span> m <span style=color:#a2f;font-weight:700>in</span> pgo_dex<span style=color:#666>.</span>methods}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> k, size_hela <span style=color:#a2f;font-weight:700>in</span> hela<span style=color:#666>.</span>items():
</span></span><span style=display:flex><span>    size_pgo <span style=color:#666>=</span> pgo[k]
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> size_pgo <span style=color:#666>!=</span> size_hela:
</span></span><span style=display:flex><span>        <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;Mismatch: </span><span style=color:#b68;font-weight:700>{</span>k<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span></code></pre></div><p>By running this script on <code>classes.dex</code>, we don&rsquo;t find any difference.
Actually, the PGSharp authors tried to prevent <em>diffing</em> by changing the line number attribute of the DEX classes.
If we try to diff the two applications from the output of apktool or Jadx, we get a lot of noise as the line number is
used in the output. On the other hand, the size bytecode for this kind of repackaging is suitable<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p>Running the same script on <code>classes2.dex</code> raises the following mismatches:</p><ul><li><code>holoholo.libholoholo.unity.UnityMainActivity.onActivityResult</code></li><li><code>holoholo.nativelib.Library.&lt;clinit></code></li></ul><p>In <code>UnityMainActivity.onActivityResult</code>, they changed this piece of code:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>onActivityResult</span><span style=color:#666>(</span><span style=color:#b00040>int</span> i<span style=color:#666>,</span> <span style=color:#b00040>int</span> i2<span style=color:#666>,</span> Intent intent<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  UnityCallbackInfo unityCallbackInfo <span style=color:#666>=</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>activityCallbacks</span><span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>Integer<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>));</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>unityCallbackInfo <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    UnityPlayer<span style=color:#666>.</span><span style=color:#7d9029>UnitySendMessage</span><span style=color:#666>(</span>unityCallbackInfo<span style=color:#666>.</span><span style=color:#7d9029>mGameObjectName</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                 unityCallbackInfo<span style=color:#666>.</span><span style=color:#7d9029>mMethodName</span><span style=color:#666>,</span>
</span></span><span style=display:flex><span>                                 String<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>i2<span style=color:#666>));</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    Client<span style=color:#666>.</span><span style=color:#7d9029>handleActivityResult</span><span style=color:#666>(</span>i<span style=color:#666>,</span> intent<span style=color:#666>);</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>into:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#b00040>void</span> <span style=color:#00f>onActivityResult</span><span style=color:#666>(</span><span style=color:#b00040>int</span> i<span style=color:#666>,</span> <span style=color:#b00040>int</span> i2<span style=color:#666>,</span> Intent intent<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  UnityCallbackInfo unityCallbackInfo <span style=color:#666>=</span> <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>activityCallbacks</span><span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>Integer<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>i<span style=color:#666>));</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>unityCallbackInfo <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      String mGameObjectName <span style=color:#666>=</span> unityCallbackInfo<span style=color:#666>.</span><span style=color:#7d9029>mGameObjectName</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>      UnityPlayer<span style=color:#666>.</span><span style=color:#7d9029>UnitySendMessage</span><span style=color:#666>(</span>mGameObjectName<span style=color:#666>,</span> unityCallbackInfo<span style=color:#666>.</span><span style=color:#7d9029>mMethodName</span><span style=color:#666>,</span> <span style=color:#ba2121>&#34;HL.PL&#34;</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>mGameObjectName<span style=color:#666>)</span> <span style=color:#666>?</span> intent <span style=color:#666>==</span> <span style=color:green;font-weight:700>null</span> <span style=color:#666>?</span> <span style=color:#ba2121>&#34;&#34;</span> <span style=color:#666>:</span> intent<span style=color:#666>.</span><span style=color:#7d9029>getData</span><span style=color:#666>().</span><span style=color:#7d9029>toString</span><span style=color:#666>()</span> <span style=color:#666>:</span> String<span style=color:#666>.</span><span style=color:#7d9029>valueOf</span><span style=color:#666>(</span>i2<span style=color:#666>));</span>
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>return</span><span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  Client<span style=color:#666>.</span><span style=color:#7d9029>handleActivityResult</span><span style=color:#666>(</span>i<span style=color:#666>,</span> intent<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>While in the static constructor of the <code>Library</code> class, they force the loading of <b class=red>libmain.so</b>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>static</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  System<span style=color:#666>.</span><span style=color:#7d9029>loadLibrary</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;main&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  System<span style=color:#666>.</span><span style=color:#7d9029>loadLibrary</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;holoholo&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>Now, let&rsquo;s look at <b class=red>libmain.so</b></p><h4 id=libmain><a href=#toc><i class='fas fa-angle-up'></i>  libmain.so</a></h4><p>Compared to the original PokemonGO APK, <b class=red>libmain.so</b> in PGSharp is substantially larger. Moreover,
the ELF metadata leaks the original file name of the file:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -d libmain.so
</span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span><span style=display:flex><span><span style=color:#888>0x000000000000000e (SONAME)             Library soname: [libhela.so]
</span></span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span></code></pre></div><p>During the analysis of PGSharp, we find references to <a href=https://en.wikipedia.org/wiki/Hela_(comics)>Hela</a>
in different places, like the package name
of the dynamically-loaded APK: <code>me.underworld.helaplugin</code>.</p><p>Originally, the purpose of this library is to initialize some parts of the Unity engine but PGSharp
uses it to load its main payload.</p><p>In the cheating app, <b class=red>libmain.so</b> is responsible for:</p><ol><li>Initializing the Lua VM</li><li>Implementing Lua native C functions</li><li>Implementing JNI functions</li><li>Calling the Lua scripts</li></ol><p><b class=red>libmain.so</b> exposes <code>JNI_OnLoad</code> which is used as an entrypoint
to perform the actions listed above.</p><p>The JNI functions don&rsquo;t have a meaningful name but thanks to their callsites, we can figure out their purpose:</p><table><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th><th style=text-align:left>Rename</th></tr></thead><tbody><tr><td style=text-align:left>NRL</td><td style=text-align:left>Trigger Lua function from Java</td><td style=text-align:left>NativeRunLua</td></tr><tr><td style=text-align:left>NSMTC</td><td style=text-align:left>Trigger PGSharp Action</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>NOHRB</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>NativeOkHttpResponseByte</td></tr><tr><td style=text-align:left>NOHR</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>NativeOkHttpResponse</td></tr><tr><td style=text-align:left>NOHF</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>NativeOkHttpFailure</td></tr><tr><td style=text-align:left>NIOS</td><td style=text-align:left>Google Signing?</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>NIOR</td><td style=text-align:left><em>Seems not used</em></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>NOT</td><td style=text-align:left>Perform periodic actions on Lua threads</td><td style=text-align:left>NativeOnTimer</td></tr><tr><td style=text-align:left>NIPE</td><td style=text-align:left>Related to PokemonGO Plus</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>NIOF</td><td style=text-align:left><em>Seems to do nothing relevant</em></td><td style=text-align:left>-</td></tr></tbody></table><p>Similarly, for the Lua C closures, we get the following table:</p><table><thead><tr><th style=text-align:left>Name</th><th style=text-align:left>Description</th><th style=text-align:left>Rename</th></tr></thead><tbody><tr><td style=text-align:left>callpgo</td><td style=text-align:left>Trigger Lua function from Java</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>add_unity_task</td><td style=text-align:left>Trigger PGSharp Action</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>initil2cppbase</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>initil2cpphooks</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>initil2cppmethods</td><td style=text-align:left>OkHtttp callback</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>newjbytearray</td><td style=text-align:left>Create a <em>Java</em> bytearray from Lua</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>nar</td><td style=text-align:left>-</td><td style=text-align:left>nativeAttestResponse</td></tr><tr><td style=text-align:left>ngak</td><td style=text-align:left>-</td><td style=text-align:left>nativeGetApiKey</td></tr><tr><td style=text-align:left>findclass</td><td style=text-align:left>Find a <em>Java</em> class from Lua</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>gettid</td><td style=text-align:left>Get Thread ID</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>logi</td><td style=text-align:left>Log info (empty)</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>logv</td><td style=text-align:left>Log verbose (empty)</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>init_plugin_natives</td><td style=text-align:left>Init Java layer (JNI + <code>nUSlwbRIjReLowOP</code>)</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>uf_whitelist</td><td style=text-align:left><em>empty</em></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>uf_forbid</td><td style=text-align:left><em>empty</em></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>uf_redirect</td><td style=text-align:left><em>empty</em></td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>fkinitjni</td><td style=text-align:left>Lua wrapper<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td><td style=text-align:left>FakeInitJNI</td></tr><tr><td style=text-align:left>fknalp</td><td style=text-align:left>Lua wrapper<sup id=fnref1:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td><td style=text-align:left>FakeNativeAddLocationProvider</td></tr><tr><td style=text-align:left>fkngsu</td><td style=text-align:left>Lua wrapper<sup id=fnref2:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td><td style=text-align:left>FakeNativeGpsStatusUpdate</td></tr><tr><td style=text-align:left>fknlu</td><td style=text-align:left>Lua wrapper<sup id=fnref3:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></td><td style=text-align:left>FakeNativeLocationUpdate</td></tr><tr><td style=text-align:left>getPoisFromCache</td><td style=text-align:left>Related to the autowalk feature</td><td style=text-align:left>-</td></tr></tbody></table><div class="accordion accordion-flush" id=spoiler-5><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-5><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-5 aria-expanded=true aria-controls=flush-collapse-spoiler-5>
<i class='fas fa-table'></i>&nbsp;&nbsp;NRL Actions</button></h2><div id=flush-collapse-spoiler-5 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-5 data-bs-parent=#spoiler-5><div class=accordion-body><table><thead><tr><th style=text-align:left>Action</th><th style=text-align:left>Event Task</th></tr></thead><tbody><tr><td style=text-align:left>1</td><td style=text-align:left>plg.float.click</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>plg.float.remove</td></tr><tr><td style=text-align:left>3</td><td style=text-align:left>plg.map.tp</td></tr><tr><td style=text-align:left>4</td><td style=text-align:left>plg.setspeed</td></tr><tr><td style=text-align:left>5</td><td style=text-align:left>plg.randomwalk</td></tr><tr><td style=text-align:left>6</td><td style=text-align:left>plg.enablespoof</td></tr><tr><td style=text-align:left>7</td><td style=text-align:left>plg.joystart</td></tr><tr><td style=text-align:left>8</td><td style=text-align:left>plg.joystop</td></tr><tr><td style=text-align:left>9</td><td style=text-align:left>plg.entergame</td></tr><tr><td style=text-align:left>10</td><td style=text-align:left>plg.pause</td></tr></tbody></table></div></div></div></div><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff>Long story short, PGSharp repackages the PokemonGO application and implements its payload in <b class=red>libmain.so</b></div><blockquote><p><em>But wait, since they repackage the application they have to re-sign the application and you won&rsquo;t tell me that PokemonGO does have
signature checks?</em></p></blockquote><center><p>And this is where the fun begins!</p><br></center><p>The functionalities of PGSharp heavily rely on hooking but not the hooking you might think of &mldr;</p><h3 id=signature-bypass><a href=#toc><i class='fas fa-angle-up'></i>  Signature Bypass</a></h3><p>As it is detailed in the next section, <b class=red>libmain.so</b> dynamically loads another APK. Within
this APK, and more precisely in the class <code>androidx.appcompat.app.AppCompatDelegateImpl</code><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, we can notice this method:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#408080;font-style:italic>/* renamed from: g */</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:green;font-weight:700>static</span> <span style=color:#b00040>void</span> <span style=color:#00f>proxifySignatureCheck</span><span style=color:#666>(</span>Context context<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  String packageName <span style=color:#666>=</span> context<span style=color:#666>.</span><span style=color:#7d9029>getPackageName</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>  Class<span style=color:#666>&lt;?&gt;</span> aThreadCls <span style=color:#666>=</span> Class<span style=color:#666>.</span><span style=color:#7d9029>forName</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;android.app.ActivityThread&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  Object mCurrentActivityThread <span style=color:#666>=</span> aThreadCls<span style=color:#666>.</span><span style=color:#7d9029>getDeclaredMethod</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;currentActivityThread&#34;</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> Class<span style=color:#666>[</span>0<span style=color:#666>]).</span><span style=color:#7d9029>invoke</span><span style=color:#666>(</span><span style=color:green;font-weight:700>null</span><span style=color:#666>,</span> <span style=color:green;font-weight:700>new</span> Object<span style=color:#666>[</span>0<span style=color:#666>]);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Field sPackageManager <span style=color:#666>=</span> aThreadCls<span style=color:#666>.</span><span style=color:#7d9029>getDeclaredField</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;sPackageManager&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  sPackageManager<span style=color:#666>.</span><span style=color:#7d9029>setAccessible</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Object pm <span style=color:#666>=</span> sPackageManager<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>mCurrentActivityThread<span style=color:#666>);</span>
</span></span><span style=display:flex><span>  Class<span style=color:#666>&lt;?&gt;</span> IPackageManager <span style=color:#666>=</span> Class<span style=color:#666>.</span><span style=color:#7d9029>forName</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;android.content.pm.IPackageManager&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  SignatureMock mock <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> SignatureMock<span style=color:#666>(</span>pm<span style=color:#666>,</span> <span style=color:#ba2121>&#34;30820 [ ... ] aa001f55&#34;</span><span style=color:#666>,</span> packageName<span style=color:#666>)</span>
</span></span><span style=display:flex><span>  Object newProxyInstance <span style=color:#666>=</span> Proxy<span style=color:#666>.</span><span style=color:#7d9029>newProxyInstance</span><span style=color:#666>(</span>IPackageManager<span style=color:#666>.</span><span style=color:#7d9029>getClassLoader</span><span style=color:#666>(),</span>
</span></span><span style=display:flex><span>                                                   <span style=color:green;font-weight:700>new</span> Class<span style=color:#666>[]{</span>IPackageManager<span style=color:#666>},</span> mock<span style=color:#666>);</span>
</span></span><span style=display:flex><span>  sPackageManager<span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>mCurrentActivityThread<span style=color:#666>,</span> newProxyInstance<span style=color:#666>);</span>
</span></span><span style=display:flex><span>  PackageManager packageManager <span style=color:#666>=</span> context<span style=color:#666>.</span><span style=color:#7d9029>getPackageManager</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>  Field mPM <span style=color:#666>=</span> packageManager<span style=color:#666>.</span><span style=color:#7d9029>getClass</span><span style=color:#666>().</span><span style=color:#7d9029>getDeclaredField</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;mPM&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  mPM<span style=color:#666>.</span><span style=color:#7d9029>setAccessible</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>  mPM<span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>packageManager<span style=color:#666>,</span> newProxyInstance<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>This code leverages the Java <em>hooking</em> API, <a href=https://developer.android.com/reference/java/lang/reflect/Proxy>java.lang.reflect.Proxy</a>,
to <em>proxify</em> the Android PackageManager ¯\_(ツ)_/¯.</p><p>The <em>mocked</em> PackageManager looks like this:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:green;font-weight:700>public</span> <span style=color:#00f>SignatureMock</span><span style=color:#666>(</span>Object pm<span style=color:#666>,</span> String originalSignature<span style=color:#666>,</span> String packageName<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageManager</span> <span style=color:#666>=</span> pm<span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mOriginalSignature</span> <span style=color:#666>=</span> originalSignature<span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageName</span> <span style=color:#666>=</span> packageName<span style=color:#666>;</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span><span style=display:flex><span><span style=color:#a2f>@Override</span> <span style=color:#408080;font-style:italic>// java.lang.reflect.InvocationHandler
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>public</span> Object <span style=color:#00f>invoke</span><span style=color:#666>(</span>Object obj<span style=color:#666>,</span> Method inMeth<span style=color:#666>,</span> Object<span style=color:#666>[]</span> args<span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>  PackageInfo packageInfo<span style=color:#666>;</span>
</span></span><span style=display:flex><span>  SigningInfo signingInfo<span style=color:#666>;</span>
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// Hook getPackageInfo
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span><span style=color:#ba2121>&#34;getPackageInfo&#34;</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>inMeth<span style=color:#666>.</span><span style=color:#7d9029>getName</span><span style=color:#666>()))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>    String pkgName <span style=color:#666>=</span> <span style=color:#666>(</span>String<span style=color:#666>)</span> args<span style=color:#666>[</span>0<span style=color:#666>];</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span> flags <span style=color:#666>=</span> <span style=color:#666>((</span>Integer<span style=color:#666>)</span> args<span style=color:#666>[</span>1<span style=color:#666>]).</span><span style=color:#7d9029>intValue</span><span style=color:#666>();</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// Handle both
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// GET_SIGNATURES           (0x00000040) - Deprecated in API 28
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#408080;font-style:italic>// GET_SIGNING_CERTIFICATES (0x08000000)
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> <span style=color:#666>((</span>flags <span style=color:#666>&amp;</span> PackageManager<span style=color:#666>.</span><span style=color:#7d9029>GET_SIGNATURES</span><span style=color:#666>)</span> <span style=color:#666>!=</span> 0 <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageName</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>pkgName<span style=color:#666>))</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      PackageInfo fakePkgInfo <span style=color:#666>=</span> <span style=color:#666>(</span>PackageInfo<span style=color:#666>)</span> inMeth<span style=color:#666>.</span><span style=color:#7d9029>invoke</span><span style=color:#666>(</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageManager</span><span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:#408080;font-style:italic>// Fake the signature
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>      fakePkgInfo<span style=color:#666>.</span><span style=color:#7d9029>signatures</span><span style=color:#666>[</span>0<span style=color:#666>]</span> <span style=color:#666>=</span> <span style=color:green;font-weight:700>new</span> Signature<span style=color:#666>(</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mOriginalSignature</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>return</span> fakePkgInfo<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span> <span style=color:green;font-weight:700>else</span> <span style=color:green;font-weight:700>if</span> <span style=color:#666>(</span>Build<span style=color:#666>.</span><span style=color:#7d9029>VERSION</span><span style=color:#666>.</span><span style=color:#7d9029>SDK_INT</span> <span style=color:#666>&gt;=</span> 28 <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>              <span style=color:#666>(</span>flags <span style=color:#666>&amp;</span> GET_SIGNING_CERTIFICATES<span style=color:#666>)</span> <span style=color:#666>!=</span> 0 <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>              <span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageName</span><span style=color:#666>.</span><span style=color:#7d9029>equals</span><span style=color:#666>(</span>pkgName<span style=color:#666>)</span> <span style=color:#666>&amp;&amp;</span>
</span></span><span style=display:flex><span>              <span style=color:#666>(</span>signingInfo <span style=color:#666>=</span> <span style=color:#666>(</span>packageInfo <span style=color:#666>=</span> <span style=color:#666>(</span>PackageInfo<span style=color:#666>)</span> method<span style=color:#666>.</span><span style=color:#7d9029>invoke</span><span style=color:#666>(</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageManager</span><span style=color:#666>,</span> args<span style=color:#666>)).</span><span style=color:#7d9029>signingInfo</span><span style=color:#666>)</span> <span style=color:#666>!=</span> <span style=color:green;font-weight:700>null</span><span style=color:#666>)</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>      Field FieldSigningDetails <span style=color:#666>=</span> signingInfo<span style=color:#666>.</span><span style=color:#7d9029>getClass</span><span style=color:#666>().</span><span style=color:#7d9029>getDeclaredField</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;mSigningDetails&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      FieldSigningDetails<span style=color:#666>.</span><span style=color:#7d9029>setAccessible</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      Object mSigningDetails <span style=color:#666>=</span> FieldSigningD<span style=color:#666>.</span><span style=color:#7d9029>get</span><span style=color:#666>(</span>packageInfo<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      Signature<span style=color:#666>[]</span> fakeSigArray <span style=color:#666>=</span> <span style=color:#666>{</span><span style=color:green;font-weight:700>new</span> Signature<span style=color:#666>(</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mOriginalSignature</span><span style=color:#666>)};</span>
</span></span><span style=display:flex><span>      Field FieldSignatures <span style=color:#666>=</span> mSigningDetails<span style=color:#666>.</span><span style=color:#7d9029>getClass</span><span style=color:#666>().</span><span style=color:#7d9029>getDeclaredField</span><span style=color:#666>(</span><span style=color:#ba2121>&#34;signatures&#34;</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      FieldSignatures<span style=color:#666>.</span><span style=color:#7d9029>setAccessible</span><span style=color:#666>(</span><span style=color:green;font-weight:700>true</span><span style=color:#666>);</span>
</span></span><span style=display:flex><span>      FieldSignatures<span style=color:#666>.</span><span style=color:#7d9029>set</span><span style=color:#666>(</span>FieldSigningDetails<span style=color:#666>,</span> fakeSigArray<span style=color:#666>);</span>
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>return</span> packageInfo<span style=color:#666>;</span>
</span></span><span style=display:flex><span>    <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> inMeth<span style=color:#666>.</span><span style=color:#7d9029>invoke</span><span style=color:#666>(</span><span style=color:green;font-weight:700>this</span><span style=color:#666>.</span><span style=color:#7d9029>mPackageManager</span><span style=color:#666>,</span> args<span style=color:#666>);</span>
</span></span><span style=display:flex><span><span style=color:#666>}</span>
</span></span></code></pre></div><p>In doing so, when PokemonGO accesses the PackageManager, it gets a <em>mocked</em> version of the PackageManager
that is <strong>controlled</strong> by PGSharp.
PGSharp changes the behavior of <code>getPackageInfo()</code> to return the real PokemonGO signature instead of its own.</p><p>The following figure outlines the process:</p><p><img src=mock_signature.png alt="Mock Android PackageManager"></p><h3 id=dynamic-apk-loading><a href=#toc><i class='fas fa-angle-up'></i>  Dynamic APK Loading</a></h3><p>In the Lua script <code>plugin.lua</code>, PGSharp defines an <code>init</code> function that performs the following
actions:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:green;font-weight:700>local</span> filesdir     <span style=color:#666>=</span> (ref.call_method)(runtime.app, <span style=color:#ba2121>&#34;getFilesDir&#34;</span>, <span style=color:#ba2121>&#34;()Ljava/io/File;&#34;</span>)
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>local</span> filesdirpath <span style=color:#666>=</span> (ref.call_method)(filesdir, <span style=color:#ba2121>&#34;getAbsolutePath&#34;</span>, <span style=color:#ba2121>&#34;()Ljava/lang/String;&#34;</span>)
</span></span><span style=display:flex><span>u_plugin_path      <span style=color:#666>=</span> (gh.ipf)(loadjstring(filesdirpath))
</span></span></code></pre></div><p><code>ipf</code> is a function that takes the output of <code>cxt.getFilesDir().getAbsolutePath()</code> as parameter,
in other words, the path of the <em>files</em> directory of PokemonGO: <code>/data/data/com.nianticlabs.pokemongo/files</code>,
and returns a <code>u_plugin_path</code> as a Lua string.</p><p>If we look for <code>ipf</code> in the Lua scripts, we don&rsquo;t find any implementation. Actually, this
function is referenced in the <code>gamehelper()</code> function of <b class=red>libmain.so</b> where it is
linked as follows:</p><p><img src=ipf.png alt="Lua registering IPF"></p><p>So <code>ipf</code> is a native Lua C function registered with <code>lua_pushcclosure</code>.</p><p>Once we identified the location of <code>ipf</code>, the logic of the function can be summarized with this pseudo code:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// file_dir: /data/user/0/com.nianticlabs.pokemongo/files
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>void</span> <span style=color:#00f>ipf</span>(lua_State <span style=color:#666>*</span>L) {
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// std::string ctor @0xA4F00
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  std<span style=color:#666>::</span>string outpath <span style=color:#666>=</span> lua_tostring(L, <span style=color:#666>-</span><span style=color:#666>1</span>);
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// std::string::append @0xD868C
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  outpath.append(<span style=color:#ba2121>&#34;/&#34;</span>);
</span></span><span style=display:flex><span>  outpath.append(<span style=color:#ba2121>&#34;LZZqoKpt.plg&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  FILE<span style=color:#666>*</span> fout <span style=color:#666>=</span> fopen(outpath.c_str(), <span style=color:#ba2121>&#34;wb&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// @0x634424
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  extract_apk_file(FILE<span style=color:#666>*</span> fout) {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> (<span style=color:#a0a000>chunk</span> : chunks) {
</span></span><span style=display:flex><span>      decode(chunk, <span style=color:#666>0x2710</span>);
</span></span><span style=display:flex><span>      fwrite(chunk, <span style=color:#666>0x2710</span>, <span style=color:#666>1</span>, fout);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  fclose(fout);
</span></span><span style=display:flex><span>  lua_pushlstring(L, outpath.c_str(), outpath.size());
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>inline_decode</span>(<span style=color:#b00040>uint8_t</span><span style=color:#666>*</span> data, size_t size) {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>for</span> (size_t i <span style=color:#666>=</span> <span style=color:#666>0</span>; i <span style=color:#666>&lt;</span> size; <span style=color:#666>++</span>i) {
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// Byte decoding
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    data[i] <span style=color:#666>=</span> (<span style=color:#666>0xb3</span> <span style=color:#666>&amp;</span> <span style=color:#666>~</span>data[i]) <span style=color:#666>|</span> (data[i] <span style=color:#666>&amp;</span> <span style=color:#666>0x4c</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff>Since the decoded file is written in the <code>/data</code> partition,
one can also pull the file from the device (this file is not removed when PGSharp stops running).</div><p>The written file, <code>LZZqoKpt.plg</code>, is actually an APK that is loaded with <code>PathClassLoader</code> in the Lua script:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>u_classloader <span style=color:#666>=</span> (ref.new_instance)(<span style=color:#ba2121>&#34;dalvik/system/PathClassLoader&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#ba2121>&#34;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/ClassLoader;)V&#34;</span>,
</span></span><span style=display:flex><span>                (env.NewStringUTF)(u_plugin_path),
</span></span><span style=display:flex><span>                nativeLibraryDir,
</span></span><span style=display:flex><span>                gh.pgo_classloader);
</span></span></code></pre></div><div class="accordion accordion-flush" id=spoiler-8><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-8><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-8 aria-expanded=true aria-controls=flush-collapse-spoiler-8>
<i class='fas fa-file-code'></i>&nbsp;&nbsp;Rest of the function</button></h2><div id=flush-collapse-spoiler-8 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-8 data-bs-parent=#spoiler-8><div class=accordion-body><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>u_plugin_cls                <span style=color:#666>=</span> findclass(<span style=color:#ba2121>&#34;me/underworld/helaplugin/PL&#34;</span>, u_classloader)
</span></span><span style=display:flex><span>u_global_cls                <span style=color:#666>=</span> findclass(<span style=color:#ba2121>&#34;me/underworld/helaplugin/GL&#34;</span>, u_classloader)
</span></span><span style=display:flex><span>u_runnable_cls              <span style=color:#666>=</span> findclass(<span style=color:#ba2121>&#34;me/underworld/helaplugin/HR&#34;</span>, u_classloader)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>u_global_cls                <span style=color:#666>=</span> (env.NewGlobalRef)(u_global_cls)
</span></span><span style=display:flex><span>u_plugin_cls                <span style=color:#666>=</span> (env.NewGlobalRef)(u_plugin_cls)
</span></span><span style=display:flex><span>u_classloader               <span style=color:#666>=</span> (env.NewGlobalRef)(u_classloader)
</span></span><span style=display:flex><span>u_runnable_cls              <span style=color:#666>=</span> (env.NewGlobalRef)(u_runnable_cls)
</span></span><span style=display:flex><span>u_runnable_init_mid         <span style=color:#666>=</span> (env.GetMethodID)(u_runnable_cls, <span style=color:#ba2121>&#34;&lt;init&gt;&#34;</span>, <span style=color:#ba2121>&#34;(ILjava/lang/Object;)V&#34;</span>)
</span></span><span style=display:flex><span>u_geturl_mid                <span style=color:#666>=</span> (env.GetStaticMethodID)(u_plugin_cls, <span style=color:#ba2121>&#34;GU&#34;</span>, <span style=color:#ba2121>&#34;(Ljava/lang/String;Ljava/lang/String;)I&#34;</span>)
</span></span><span style=display:flex><span>u_postString_mid            <span style=color:#666>=</span> (env.GetStaticMethodID)(u_plugin_cls, <span style=color:#ba2121>&#34;vtEdUZmWQYAgtGWs&#34;</span>, <span style=color:#ba2121>&#34;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)I&#34;</span>)
</span></span><span style=display:flex><span>u_postBytes_mid             <span style=color:#666>=</span> (env.GetStaticMethodID)(u_plugin_cls, <span style=color:#ba2121>&#34;BbTwaTXurePBxTDt&#34;</span>, <span style=color:#ba2121>&#34;(Ljava/lang/String;[BLjava/lang/String;)I&#34;</span>)
</span></span><span style=display:flex><span>u_onLuaMessage_mid          <span style=color:#666>=</span> (env.GetStaticMethodID)(u_plugin_cls, <span style=color:#ba2121>&#34;tFAxNZCNHOXBTYGM&#34;</span>, <span style=color:#ba2121>&#34;(ILjava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;&#34;</span>)
</span></span><span style=display:flex><span>u_global_updatelocation_mid <span style=color:#666>=</span> (env.GetStaticMethodID)(u_global_cls, <span style=color:#ba2121>&#34;ul&#34;</span>, <span style=color:#ba2121>&#34;(DD)V&#34;</span>)
</span></span><span style=display:flex><span>u_global_savelocation_mid   <span style=color:#666>=</span> (env.GetStaticMethodID)(u_global_cls, <span style=color:#ba2121>&#34;sl&#34;</span>, <span style=color:#ba2121>&#34;()V&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(gh.init_plugin_natives)(u_classloader)
</span></span><span style=display:flex><span>(ref.call_static_method)(u_plugin_cls,
</span></span><span style=display:flex><span>                         <span style=color:#ba2121>&#34;rDymrMuxPIlIESFe&#34;</span>, <span style=color:#ba2121>&#34;(Landroid/app/Application;Ljava/lang/String;I)V&#34;</span>,
</span></span><span style=display:flex><span>                         runtime.app, (env.NewStringUTF)(u_plugin_path), runtime.log_level)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>local</span> cls              <span style=color:#666>=</span> (gh.findclass)(<span style=color:#ba2121>&#34;me.underworld.helaplugin.HLVM&#34;</span>, u_classloader)
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>local</span> hlviewmanagerref <span style=color:#666>=</span> (ref.call_static_method)(cls, <span style=color:#ba2121>&#34;getInstance&#34;</span>, <span style=color:#ba2121>&#34;()Lme/underworld/helaplugin/HLVM;&#34;</span>)
</span></span><span style=display:flex><span>u_sm_mid               <span style=color:#666>=</span> (env.GetMethodID)(cls, <span style=color:#ba2121>&#34;SM&#34;</span>, <span style=color:#ba2121>&#34;(Ljava/lang/String;I)V&#34;</span>)
</span></span><span style=display:flex><span>u_setviewshow_mid      <span style=color:#666>=</span> (env.GetMethodID)(cls, <span style=color:#ba2121>&#34;SVC&#34;</span>, <span style=color:#ba2121>&#34;(Ljava/lang/String;Z)V&#34;</span>)
</span></span><span style=display:flex><span>u_hlviewmanager        <span style=color:#666>=</span> (env.NewGlobalRef)(hlviewmanagerref)
</span></span><span style=display:flex><span>plugin.classloader     <span style=color:#666>=</span> u_classloader
</span></span></code></pre></div></div></div></div></div><h3 id=gps-spoofing><a href=#toc><i class='fas fa-angle-up'></i>  GPS Spoofing</a></h3><p>Since PokemonGO heavily relies on the user&rsquo;s location, the must-have feature for the PokemonGO cheat engines
is to be able to spoof the GPS location.</p><p>The genuine PokemonGO application manages the user location through the Java class <code>NianticLocationManager</code>,
which exposes three natives functions:</p><ol><li><span class=blue>nativeAddLocationProviders(Context ctx)</span></li><li><span class=blue>nativeGpsStatusUpdate(int i, SatelliteInfo[] info)</span></li><li><span class=blue>nativeLocationUpdate(String providerName, Location location, &mldr;)</span></li></ol><p><code>nativeAddLocationProviders</code> aims at instantiating the different location providers as Java object:</p><ol><li>FusedLocationProvider</li><li>GnssLocationProvider</li><li>GpsLocationProvider</li><li>NetworkLocationProvider</li></ol><p>while <code>nativeLocationUpdate</code> and <code>nativeGpsStatusUpdate</code> are a kind of callbacks triggered when there is
a new user location to consider.</p><p>The implementation of <code>nativeLocationUpdate</code> checks natively if the location object given in the second parameter
is <em>mocked</em> (cf. <a href=https://developer.android.com/reference/android/location/Location#isMock()>isMock()</a> or <a href=https://developer.android.com/reference/android/location/Location#isFromMockProvider()>isFromMockProvider()</a>).</p><p>Actually PGSharp hooks two of these three native methods:</p><ol><li><span class=red><i class="fas fa-cogs"> </i>nativeAddLocationProviders(Context ctx)</span></li><li><span class=blue>nativeGpsStatusUpdate(int i, SatelliteInfo[] info)</span></li><li><span class=red><i class="fas fa-cogs"> </i>nativeLocationUpdate(String provider, Location location, &mldr;)</span></li></ol><p>By hooking <code>nativeLocationUpdate</code>, they can modify the value of the <code>Location</code> parameter to change
the real location.</p><blockquote><p><em>&ldquo;You assert that PGSharp hooks <code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> in
<code>libNianticLabsPlugin.so</code>, but this library is protected by a commercial obfuscator
which has anti-hooks features. How do they hook these functions?&rdquo;</em></p></blockquote><p>And this is where the fun reaches another level 🚀</p><h3 id=jnienv-proxifier><a href=#toc><i class='fas fa-angle-up'></i>  JNIEnv Proxifier</a></h3><p>I would assume that <code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> are critical
enough to be protected against hooking. It turns out that PGSharp embeds a hooking framework to hook
Unity functions, but they don&rsquo;t use it on these functions.</p><center><p><b>The authors of PGSharp found a subtle trick to circumvent the anti-hook protection.<br></b></p></center><p><code>nativeLocationUpdate</code> and <code>nativeAddLocationProviders</code> are JNI functions
that are <strong>dynamically</strong> registered by <code>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit(env, ...) {
</span></span><span style=display:flex><span>  env<span style=color:#666>-&gt;</span>RegisterNatives(...);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>env</code> parameter refers to the JNIEnv structure which is an array of function pointers:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>JNINativeInterface</span> {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  jclass      (<span style=color:#666>*</span>GetObjectClass)(JNIEnv<span style=color:#666>*</span>, jobject);
</span></span><span style=display:flex><span>  jboolean    (<span style=color:#666>*</span>IsInstanceOf)(JNIEnv<span style=color:#666>*</span>, jobject, jclass);
</span></span><span style=display:flex><span>  jmethodID   (<span style=color:#666>*</span>GetMethodID)(JNIEnv<span style=color:#666>*</span>, jclass, <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>char</span><span style=color:#666>*</span>, <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>char</span><span style=color:#666>*</span>);
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The values
of these pointers are defined by the implementation of the &ldquo;JVM&rdquo; which is, for Android, the <strong>A</strong>ndroid <strong>R</strong>un<strong>T</strong>ime (ART).</p><p>For instance, <code>FindClass</code> is actually a pointer
to <code>art::{CheckJNI, JNIImpl}::FindClass</code> located in <code>art/runtime/jni/{jni_internal, check_jni}.cc</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>static</span> jclass <span style=color:#00f>FindClass</span>(JNIEnv<span style=color:#666>*</span> env, <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>char</span><span style=color:#666>*</span> name) {
</span></span><span style=display:flex><span>  Runtime<span style=color:#666>*</span> runtime <span style=color:#666>=</span> Runtime<span style=color:#666>::</span>Current();
</span></span><span style=display:flex><span>  ClassLinker<span style=color:#666>*</span> class_linker <span style=color:#666>=</span> runtime<span style=color:#666>-&gt;</span>GetClassLinker();
</span></span><span style=display:flex><span>  std<span style=color:#666>::</span>string descriptor(NormalizeJniClassDescriptor(name));
</span></span><span style=display:flex><span>  ScopedObjectAccess soa(env);
</span></span><span style=display:flex><span>  ObjPtr<span style=color:#666>&lt;</span>mirror<span style=color:#666>::</span>Class<span style=color:#666>&gt;</span> c <span style=color:#666>=</span> <span style=color:green;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (runtime<span style=color:#666>-&gt;</span>IsStarted()) {
</span></span><span style=display:flex><span>    StackHandleScope<span style=color:#666>&lt;</span><span style=color:#666>1</span><span style=color:#666>&gt;</span> hs(soa.Self());
</span></span><span style=display:flex><span>    Handle<span style=color:#666>&lt;</span>mirror<span style=color:#666>::</span>ClassLoader<span style=color:#666>&gt;</span> class_loader(hs.NewHandle(GetClassLoader<span style=color:#666>&lt;</span>kEnableIndexIds<span style=color:#666>&gt;</span>(soa)));
</span></span><span style=display:flex><span>    c <span style=color:#666>=</span> class_linker<span style=color:#666>-&gt;</span>FindClass(soa.Self(), descriptor.c_str(), class_loader);
</span></span><span style=display:flex><span>  } <span style=color:green;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    c <span style=color:#666>=</span> class_linker<span style=color:#666>-&gt;</span>FindSystemClass(soa.Self(), descriptor.c_str());
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> soa.AddLocalReference<span style=color:#666>&lt;</span>jclass<span style=color:#666>&gt;</span>(c);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we hook <code>Java_com_nianticlabs_nia_unity_UnityUtil_nativeInit</code> from the <strong>genuine</strong> PokemonGO,
and we check where the pointers of the <code>JNIEnv</code> structure point to, we get this kind of output:</p><p><img src=jni_ptr_clean.png alt="Normal values of the JNI Pointers"></p><p>This output is consistent with what we said about the <em>JVM</em> and the runtime ART.
If we do the same check <strong>on PGSharp</strong>, we get this result:</p><p><img src=jni_ptr_cheat.png alt="Modified values of the JNI Pointers"></p><p>As we can see, some pointers have been relocated to point in <b class=red>libmain.so</b>:</p><center><table><thead><tr><th style=text-align:left>JNI Function</th><th style=text-align:left>Offset in libmain.so (v1.33.0)</th></tr></thead><tbody><tr><td style=text-align:left>GetMethodID</td><td style=text-align:left>0x14540c</td></tr><tr><td style=text-align:left>CallObjectMethodV</td><td style=text-align:left>0x145194</td></tr><tr><td style=text-align:left>CallVoidMethodV</td><td style=text-align:left>0x145040</td></tr><tr><td style=text-align:left>RegisterNatives</td><td style=text-align:left>0x1452f0</td></tr></tbody></table></center><p>It means that when <code>libNianticLabsPlugin.so</code> is calling one of the functions listed above,
the execution is forwarded to <b class=red>libmain.so</b> instead of <b class=green>libart.so</b>.</p><p><img src=jnienv_proxy.png alt="JNIEnv Proxy"></p><p>PGSharp proxifies these functions for the following purposes:</p><p><strong>GetMethodID</strong></p><p>  To monitor:</p><ol><li>SafetyNetService.attest</li><li>SafetyNetService.cancel</li><li>NianticLocationManager.addLocationProvider</li></ol><p><strong>CallVoidMethodV</strong></p><p>  To monitor the parameters of:</p><ol><li>SafetyNetService.attest (to intercept the nonce)</li><li>SafetyNetService.cancel</li></ol><p><strong>RegisterNatives</strong></p><p>  Proxified to get, and potentially change, the effective location of the<br>  <code>libNianticLabsPlugin.so</code> JNI functions:</p><ol><li>nativeAttestResponse</li><li>nativeGetApiKey</li><li>nativeAddLocationProviders</li><li>nativeLocationUpdate</li><li>initJni</li><li>nativeInjectEvent</li><li>nativeUnitySendMessage</li><li>nativeRender</li><li>nativeMuteMasterAudio</li></ol><p>By managing the function <code>JNIEnv::RegisterNatives</code>, they are able to change the value of <code>JNINativeMethod.fnPtr</code>,
such as when PokemonGO calls <code>nativeLocationUpdate</code>, it actually calls a function managed by PGSharp.</p><p>It results that JNI functions used by <code>libNianticLabsPlugin.so</code> have been <em>redefined</em>:</p><table><thead><tr><th style=text-align:left>JNI Function</th><th style=text-align:left>Location</th></tr></thead><tbody><tr><td style=text-align:left><b class=red>NianticLocationManager.nativeAddLocationProviders</b></td><td style=text-align:left><b class=red>libmain.so!ea868</b></td></tr><tr><td style=text-align:left>NianticLocationManager.nativeGpsStatusUpdate</td><td style=text-align:left>libNianticLabsPlugin.so!bc508</td></tr><tr><td style=text-align:left><b class=red>NianticLocationManager.nativeLocationUpdate</b></td><td style=text-align:left><b class=red>libmain.so!ea8bc</b></td></tr><tr><td style=text-align:left>NLog.nativeDispatchLogMessage</td><td style=text-align:left>libNianticLabsPlugin.so!4beaa0</td></tr><tr><td style=text-align:left>NetworkConnectivity.nativeNotifyNetworkStateChanged</td><td style=text-align:left>libNianticLabsPlugin.so!6f8118</td></tr><tr><td style=text-align:left>NianticTrustManager.nativeCheckClientTrusted</td><td style=text-align:left>libNianticLabsPlugin.so!9b9cc</td></tr><tr><td style=text-align:left>NianticTrustManager.nativeCheckServerTrusted</td><td style=text-align:left>libNianticLabsPlugin.so!73b42c</td></tr><tr><td style=text-align:left>NianticTrustManager.nativeGetAcceptedIssuers</td><td style=text-align:left>libNianticLabsPlugin.so!6dc5c8</td></tr><tr><td style=text-align:left>WebsocketController.nativeOnDidClose</td><td style=text-align:left>libNianticLabsPlugin.so!6fcabc</td></tr><tr><td style=text-align:left>WebsocketController.nativeOnDidFail</td><td style=text-align:left>libNianticLabsPlugin.so!4a0d0c</td></tr><tr><td style=text-align:left>WebsocketController.nativeOnDidOpen</td><td style=text-align:left>libNianticLabsPlugin.so!5922b0</td></tr><tr><td style=text-align:left>WebsocketController.nativeOnDidReceiveData</td><td style=text-align:left>libNianticLabsPlugin.so!742fa8</td></tr><tr><td style=text-align:left>SafetyNetService.nativeAttestResponse</td><td style=text-align:left>libNianticLabsPlugin.so!5ea1b8</td></tr><tr><td style=text-align:left>SafetyNetService.nativeGetApiKey</td><td style=text-align:left>libNianticLabsPlugin.so!6bc60</td></tr><tr><td style=text-align:left>NianticSensorManager.nativeCompassUpdate</td><td style=text-align:left>libNianticLabsPlugin.so!4b9bc0</td></tr><tr><td style=text-align:left>NianticSensorManager.nativeSensorUpdate</td><td style=text-align:left>libNianticLabsPlugin.so!177c44</td></tr></tbody></table><h3 id=unity-hooks><a href=#toc><i class='fas fa-angle-up'></i>  Unity Hooks</a></h3><p>In addition to GPS spoofing, PGSharp provides other functionalities such as,
Pokemon feed, skip evolve animation &mldr;</p><p>In the genuine PokemonGO application, these functionalities are implemented in the Unity layer
that is <em>compiled</em> into <code>libil2cpp.so</code>.</p><p>To perform these functionalities, PGSharp hooks (hooking like Frida) some of these Unity functions.</p><p>They tried to hide<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> the underlying hooking framework used to perform these hooks, unfortunately they missed
to remove important strings:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> strings ./libmain.so|grep -i -E <span style=color:#ba2121>&#34;\w\+\.cc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/InterceptRouting/Routing/FunctionInlineReplace/FunctionInlineReplaceExport.cc
</span></span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/TrampolineBridge/Trampoline/arm64/trampoline-arm64.cc
</span></span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/MemoryAllocator/MemoryArena.cc
</span></span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/InstructionRelocation/arm64/ARM64InstructionRelocation.cc
</span></span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/UserMode/PlatformUtil/Linux/ProcessRuntimeUtility.cc
</span></span></span><span style=display:flex><span><span style=color:#888>E:/work/code/Hela/app/src/main/cpp/Dobby/source/UserMode/UnifiedInterface/platform-posix.cc
</span></span></span></code></pre></div><p>So the hooking framework is Dobby:</p><center><p><i class='fab fa-github'></i>&nbsp;&nbsp;&nbsp;<a href=https://github.com/jmpews/Dobby target=_blank rel=noopener>https://github.com/jmpews/Dobby</a><br></p></center><p>Unity hooks start, in the script <code>init.lua</code> of PGSharp where they wait for the loading of <code>libil2cpp.so</code><sup id=fnref:7><a href=#fn:7 class=footnote-ref role=doc-noteref>7</a></sup>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>set_event_handler(<span style=color:#ba2121>&#34;pgo.il2ready&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>function</span>(il2base)
</span></span><span style=display:flex><span>    runtime.il2base <span style=color:#666>=</span> il2base;
</span></span><span style=display:flex><span>    (gh.initil2cppmethods)();
</span></span><span style=display:flex><span>    (gh.initil2cpphooks)();
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>end</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p><code>initil2cppmethods()</code> aims at resolving the address of PokemonGO Unity functions needed to perform cheating actions,
while <code>initil2cpphooks()</code> dobby-hooks some Unity functions to change their behaviour.
In the version 1.33 of PGSharp, they hook 207 functions
of <code>libil2cpp.so</code> and we will take one of them to detail the internal mechanisms:</p><ul><li><code>UnityEngine.Application$$OpenURL</code></li></ul><p>First of all, if we look at the symbols or the strings of <code>libil2cpp.so</code>, we don&rsquo;t find meaningful information that could
help to figure out the original purpose of the Unity functions. In fact, the Unity metadata are embedded
in <code>global-metadata.dat</code>, and to recover the bindings between this file
and <code>libil2cpp.so</code>, we can use <a href=https://github.com/Perfare/Il2CppDumper>Perfare/Il2CppDumper</a>.</p><p>They compute the absolute of a Unity function by adding the offset provided by <code>global-metadata.dat</code>
to the base address of <code>libil2cpp.so</code>. Here is an example <code>UnityEngine.Application$$OpenURL</code>:</p><pre tabindex=0><code class=language-arm data-lang=arm>MOV   W13, 0x4bfeea0                   ; Offset of the function (thanks to global-metadata.dat)
ADRP  X14, #Application_OpenURL
ADD   X13, X8, X13                     ; Add the libil2cpp.so base address
STR   X13, [X14, #Application_OpenURL] ; Store the absolute address in libmain.so
</code></pre><p>The function associated with <code>initil2cpphooks()</code> is quite large as shown in the figure below:</p><p><img src=initil2cpphooks.png alt=initil2cpphooks></p><p>Actually, the function is large but easily understandable statically<sup id=fnref:8><a href=#fn:8 class=footnote-ref role=doc-noteref>8</a></sup>. The right-hand side of the figure is actually
the <code>catch { ... }</code> handlers of the exceptions, while the left-hand side that goes down, initializes
C++ objects. In this area of the CFG, we find the same pattern that repeats all the way down:</p><p><img src=dobby_hook_vtable.png alt="Dobby Hooking VTable"></p><p>From what we can see, it initializes a C++ object (on the stack) and the first instructions setup the
VTable. We can find the relevant function in the last entry of the VTable that contains the hooking logic:</p><p><img src=hook_OpenURL.png alt="Dobby Hooking OpenURL"></p><p>From this code, we can see that they perform the resolution of the absolute address of
<code>UnityEngine.Application$$OpenURL</code>. Also, thanks to the prototype of <code>DobbyHook()</code> we can
quickly understand that the new behavior of <code>OpenURL</code> is located in the function <code>sub_6C983C</code>:</p><p><img src=il2cpp_hooks.png alt="Dobby Hooking OpenURL"></p><p>In this hook, they check if PokemonGO is opening its Google Play URL and redirect the user to the PGSharp home page.</p><h3 id=network><a href=#toc><i class='fas fa-angle-up'></i>  Network Communications and Encryption</a></h3><p>The cheating application communicates with its servers through the TLS/HTTP protocol and adds another layer
of encryption on the top of TLS. To encrypt the HTTP payload, they use AES in the CBC mode.
We can identify the AES algorithm thanks to clear S-BOX present in the <code>.rodata</code> section.</p><p>It seems that they use different keys, depending on the endpoint the application targets but
we can retrieve them by hooking the AES key schedule function. It results that we can decrypt the communication
between the application and the PGSharp servers<sup id=fnref:9><a href=#fn:9 class=footnote-ref role=doc-noteref>9</a></sup>.</p><p>Here are examples of endpoints and the data sent by PGSharp:</p><div class="accordion accordion-flush" id=spoiler-9><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-9><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-9 aria-expanded=true aria-controls=flush-collapse-spoiler-9>
<i class='fas fa-link'></i>&nbsp;&nbsp;hazelnuts</button></h2><div id=flush-collapse-spoiler-9 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-9 data-bs-parent=#spoiler-9><div class=accordion-body><ul><li><strong>POST <code>hazelnuts</code></strong><ul><li>Action: Handshake</li><li>Request:<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;bid&#34;</span>: <span style=color:#ba2121>&#34;com.nianticlabs.pokemongo&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;clt&#34;</span>: <span style=color:#ba2121>&#34;pgs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;host&#34;</span>: <span style=color:#ba2121>&#34;Samsung A40&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;lv&#34;</span>: <span style=color:#666>-1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;nonce&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;nonce_key&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;pgver&#34;</span>: <span style=color:#ba2121>&#34;0.221.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#ba2121>&#34;00000000-00000000-[...]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;ver&#34;</span>: <span style=color:#ba2121>&#34;1.33.0&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div></li><li>Response:<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;err&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;shiny&#34;</span>: [<span style=color:#ba2121>&#34;List of shiny&#34;</span>],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;hotplaces&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;name&#34;</span>: <span style=color:#ba2121>&#34;🇧🇷 Consolacao, São Paulo, Brazil&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;lat&#34;</span>: <span style=color:#666>-23.5512</span>,
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>&#34;lng&#34;</span>: <span style=color:#666>-46.6584</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul></div></div></div></div><div class="accordion accordion-flush" id=spoiler-10><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-10><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-10 aria-expanded=true aria-controls=flush-collapse-spoiler-10>
<i class='fas fa-link'></i>&nbsp;&nbsp;Cw8dfkXpW7mq2i</button></h2><div id=flush-collapse-spoiler-10 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-10 data-bs-parent=#spoiler-10><div class=accordion-body><ul><li><strong>POST <code>Cw8dfkXpW7mq2i</code></strong><ul><li>Action: <code>PGS_ACTIONS.GETPLAYER</code></li><li>Request:<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;bid&#34;</span>: <span style=color:#ba2121>&#34;com.nianticlabs.pokemongo&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;clt&#34;</span>: <span style=color:#ba2121>&#34;pgs&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;host&#34;</span>: <span style=color:#ba2121>&#34;Samsung A40&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;lv&#34;</span>: <span style=color:#666>4</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;nonce&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;nonce_key&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;pgver&#34;</span>: <span style=color:#ba2121>&#34;0.221.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;player&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;ban&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;captured&#34;</span>: <span style=color:#666>3</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;encountered&#34;</span>: <span style=color:#666>5</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;kmwalked&#34;</span>: <span style=color:#666>10.50</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;outage&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;pid&#34;</span>: <span style=color:#ba2121>&#34;[redacted]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;serverlo&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;susp&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;suspa&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;visits&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;warn&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;warna&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;warndt&#34;</span>: <span style=color:#666>623234511000000000</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;warntm&#34;</span>: <span style=color:#666>0</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#ba2121>&#34;00000000-00000000-[...]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ver&#34;</span>: <span style=color:#ba2121>&#34;1.33.0&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul></div></div></div></div><div class="accordion accordion-flush" id=spoiler-11><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-11><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-11 aria-expanded=true aria-controls=flush-collapse-spoiler-11>
<i class='fas fa-link'></i>&nbsp;&nbsp;SSZgBPn6Ixq2ZK</button></h2><div id=flush-collapse-spoiler-11 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-11 data-bs-parent=#spoiler-11><div class=accordion-body><ul><li><strong>POST <code>SSZgBPn6Ixq2ZK</code></strong><ul><li>Action: <code>PGS_ACTIONS.GETREPORTABLE</code></li><li>Request:<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;bid&#34;</span>: <span style=color:#ba2121>&#34;com.nianticlabs.pokemongo&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;clt&#34;</span>: <span style=color:#ba2121>&#34;pgs&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;host&#34;</span>: <span style=color:#ba2121>&#34;Samsung A40&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;lv&#34;</span>: <span style=color:#666>4</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;nonce&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;nonce_key&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;pgver&#34;</span>: <span style=color:#ba2121>&#34;0.221.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;raid&#34;</span>: [
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;battle&#34;</span>: <span style=color:#666>1634490000000</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;campaignId&#34;</span>: <span style=color:#ba2121>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;complete&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;costume&#34;</span>: <span style=color:#666>12233</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;dex&#34;</span>: <span style=color:#666>326</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;eligible&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;end&#34;</span>: <span style=color:#666>1634490000000</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;exclusive&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;form&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;free&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;gender&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;hidden&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;lat&#34;</span>: <span style=color:#666>0.1234</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;lng&#34;</span>: <span style=color:#666>5.6789</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;lv&#34;</span>: <span style=color:#666>3</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;mov1&#34;</span>: <span style=color:#666>163</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;mov2&#34;</span>: <span style=color:#666>90</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;schedule&#34;</span>: <span style=color:green;font-weight:700>false</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;seed&#34;</span>: <span style=color:#666>5000000</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;spawn&#34;</span>: <span style=color:#666>1634400000000</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;team&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;web&#34;</span>: <span style=color:#666>0</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;wec&#34;</span>: <span style=color:#666>3</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>],
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#ba2121>&#34;00000000-00000000-[...]&#34;</span>,
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&#34;ver&#34;</span>: <span style=color:#ba2121>&#34;1.33.0&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul></div></div></div></div><div class="accordion accordion-flush" id=spoiler-12><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-12><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-12 aria-expanded=true aria-controls=flush-collapse-spoiler-12>
<i class='fas fa-link'></i>&nbsp;&nbsp;/pga/keycode/v-q2mgqcyji/</button></h2><div id=flush-collapse-spoiler-12 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-12 data-bs-parent=#spoiler-12><div class=accordion-body><ul><li><strong>POST <code>/pga/keycode/v-q2mgqcyji/</code></strong><ul><li>Action: Activate PGSharp with a premium key</li><li>Request:<div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ver&#34;</span>: <span style=color:#ba2121>&#34;1.33.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;gi&#34;</span>: <span style=color:#666>1</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;key&#34;</span>: <span style=color:#ba2121>&#34;AVerySecretKey&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;host&#34;</span>: <span style=color:#ba2121>&#34;Samsung A40&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;clt&#34;</span>: <span style=color:#ba2121>&#34;pgs&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ua&#34;</span>: <span style=color:#ba2121>&#34;Samsung A40/11/[redacted]/arm64-v8a/[redacted]/unknow/unknown/English&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;uid&#34;</span>: <span style=color:#ba2121>&#34;00000000-00000000-[...]&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul></li></ul></div></div></div></div><h3 id=safetynet><a href=#toc><i class='fas fa-angle-up'></i>  SafetyNet</a></h3><p><img src=snet.svg alt=safetynet></p><div class="alert alert-warning" role=alert><span class="far fa-brake-warning me-1"></span>
I skimmed this layer this weekend, so some parts might be inaccurate or wrong.</div><p>In addition to standard code obfuscation, PokemonGO uses SafetyNet as an attestation mechanism.
Similarly to the GPS management, we find a (non-obfuscated) Java layer implemented in the class
<code>SafetyNetService</code>. This class exposes two native functions:</p><ol><li><span class=blue>String nativeGetApiKey()</span></li><li><span class=blue>void nativeAttestResponse(byte[] nonce, String jwtResult)</span></li></ol><p>The implementation of these two functions is obfuscated within <code>libNianticLabsPlugin.so</code>.</p><p>The first function is used to get the Google SafetyNet API key (<code>AIzaSyCh8l[...]_eOTXhM4</code>) while the second one,
is involved in the validation of the SafetyNet attestation.</p><p>Thanks to the JNIEnv proxy on <code>GetMethodID</code> and <code>CallVoidMethodV</code>,
PGSharp is able to monitor the calls to <code>SafetyNetService.attest(bytes[] nonce)</code>. When this function is called,
PGSharp intercepts the nonce and forward the request to its servers:</p><center><p><span class=red>https://tens.pgsharp.com/v1/scc-2-eg[...]4/</span><br></p></center><p>The request is performed through a http POST, whose data are encrypted with AES. The clear payload
has the following layout:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;n&#34;</span>: <span style=color:#ba2121>&#34;Cy[...]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;type&#34;</span>: <span style=color:#ba2121>&#34;attest&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ver&#34;</span>: <span style=color:#ba2121>&#34;&lt;PGSharp Version&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;k&#34;</span>: <span style=color:#ba2121>&#34;i3[...]&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;clt&#34;</span>: <span style=color:#ba2121>&#34;pgs&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;data&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;k&#34;</span>: <span style=color:#ba2121>&#34;AIzaSyCh8l[...]_eOTXhM4 &lt;- From nativeGetApiKey&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&#34;n&#34;</span>: <span style=color:#ba2121>&#34;&lt;nonce&gt;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>On success, the server responses with an AES-encrypted payload which has the following layout:</p><pre tabindex=0><code>{&#34;result&#34;:&#34;suc: &lt;JWT SafetyNet Attestation&gt;&#34;}
</code></pre><p>The JWT SafetyNet value is then forwarded by PGSharp to <code>nativeAttestResponse()</code> with the original nonce.
At some point, this JWT attestation is sent to Niantic&rsquo;s servers (on the endpoint <code>plfe/112/rpc2</code>)
wrapped by a Protobuf structure.</p><p>To understand how they <em>&ldquo;bypass&rdquo;</em> SafetyNet, let&rsquo;s look at the JWT payload:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;nonce&#34;</span>: <span style=color:#ba2121>&#34;&lt;nonce&gt;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;timestampMs&#34;</span>: <span style=color:#666>1636265656</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;apkPackageName&#34;</span>: <span style=color:#ba2121>&#34;com.nianticlabs.pokemongo&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;apkDigestSha256&#34;</span>: <span style=color:#ba2121>&#34;ioYmlh5mk5EhMUH/DsaG1jrhUoQJDK/2IvK61eiAXJE=&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;ctsProfileMatch&#34;</span>: <span style=color:green;font-weight:700>true</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;apkCertificateDigestSha256&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#ba2121>&#34;lEvaRm6vZL4ck4ltXI6aRUoHyNj8vEre7vs1RbM16Xk=&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;basicIntegrity&#34;</span>: <span style=color:green;font-weight:700>true</span>,
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&#34;evaluationType&#34;</span>: <span style=color:#ba2121>&#34;BASIC&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>First of all, the JWT is correctly signed by Google SafetyNet&rsquo;s key and the <code>apkCertificateDigestSha256</code>
matches the signature of the real PokemonGO application.</p><p>But &mldr;</p><p>The value of <code>apkDigestSha256</code> does not match the checksum of the genuine PokemonGO application 😕</p><p><strong>Here are my hypothesis:</strong></p><p>The server <code>https://tens.pgsharp.com/v1/scc-2-eg/...</code> forwards the SafetyNet request to
a real application that runs on a real device. This application would have been created by PGSharp authors
to <em>really</em> run SafetyNet and to get a valid attestation signed with a valid Google key.
The fake application would have been created with <code>com.nianticlabs.pokemongo</code> as package name
and would implement signature mocking, as discussed in the first part.</p><p>If they would have managed to break SafetyNet, the <code>apkDigestSha256</code> value would have been consistent.</p><p>The JWT attestation is forwarded to Niantic so they might check the consistency of <code>apkDigestSha256</code>
but they might only focus on the signature (which can be faked) and not this value &mldr;</p><h3 id=pgsharp-signature-check><a href=#toc><i class='fas fa-angle-up'></i>  When PGSharp avoids PokemonGO pitfalls</a></h3><p>As discussed in the section <a href=#signature-bypass><em>Signature Bypass</em></a>, PGSharp
tricks the Android PackageManager to mock the signature of the application.</p><p>It turns out that PGSharp is also concerned about app repackaging. As they provide premium
features, they don&rsquo;t want to be cheated &mldr;</p><p>In the function associated with <code>PGS_ACTIONS.INITPOST</code> they perform a device fingerprint
whose one of these elements is the APK&rsquo;s signature. But instead of using the Android PackageManager to
retrieve the signature, they use <a href=https://github.com/DimaKoz/stunning-signature>DimaKoz/stunning-signature</a>
to compute the MD5 digest of the signature.</p><h2 id=final-words><a href=#toc><i class='fas fa-angle-up'></i>  Final Words</a></h2><p>When I started to look at this cheating app, I did not expect to find such nice tricks and challenges.
The PGSharp&rsquo;s authors know the sneaky tricks to hinder reverse engineering. Unfortunately,
O-LLVM is relatively weak in this context compared to the commercial obfuscator used by Niantic.</p><p>On the other hand, the design of PokemonGO is such that all the reverse engineering difficulties
lie in one single module that can be treated in black-box once we identified the API. In particular, the
un-obfuscated Java layer helps a lot to identify these API.</p><p>Regarding the signature bypass, at first, I thought it would be easy to prevent by checking the integrity
of the <code>.apk</code> and/or the native libraries. But, there are some points that need to be taken into account:</p><p><strong>APK Integrity Check</strong></p><p>Naively, we might want to compute a checksum of the APK or re-compute the signature (as it&rsquo;s done by PGSharp).
But in fact, since a few years, Google tries to push
developers to use app bundle such as an application is no longer a single <code>.apk</code> but a split <code>.apk</code>.
While this feature optimizes the device&rsquo;s data partition size, it complicates the verification
of the signature since it would require to deal with different files and different checksum.</p><p>It&rsquo;s not infeasible, but it complicates its implementation in the APK build & development pipeline.</p><p><strong>Native Library Integrity Check</strong></p><p>I guess that <code>libNianticLabsPlugin.so</code> implements checksum on its own library as it is
a sensitive part of the application. Regarding the other libraries, some of them are owned
by Niantic (like <code>libholoholo.so</code>) and others come from third-parties (like <code>libmain.so</code>). Depending on
how they are integrated, the checksum of these external libraries might not be easy to automatically
compute while releasing a new version of PokemonGO. These third-party libraries are,
most of the time, not copy-pasted by the developers but automatically bundled when compiling the
application. Therefore, computing their checksums might require tweaking the build process
in a non-easy way.</p><p>On the top of that, Niantic releases a new version of its games on a monthly basis. It means
that these checks need to be automated in CI/CD pipeline which might not be trivial to do.</p><hr width=50%><p>It was a funny and very interesting journey, for those who want to dig a bit more
in PGSharp, I pushed some materials and documents on Github. In particular, you can
find the symbol list of <b class=red>libmain.so</b> based on reverse engineering.</p><center><p><i class='fab fa-github'></i>&nbsp;&nbsp;&nbsp;<a href=https://github.com/romainthomas/pgsharp target=_blank rel=noopener>https://github.com/romainthomas/pgsharp</a></p></center><h2 id=acknowledgments><a href=#toc><i class='fas fa-angle-up'></i>  Acknowledgments</a></h2><p>This analysis has been independently done in my spare time while being at <a href=https://www.quarkslab.com>Quarkslab</a> and
<a href=https://www.ul.com target=_blank rel=noopener class=ul>UL</a>,
my current employer.</p><h2 id=annexes><a href=#toc><i class='fas fa-angle-up'></i>  Annexes</a></h2><h3 id=third-party>Third-Party</h3><p>Here is the (non exhaustive) list of the open-source projects used by PGSharp:</p><table><thead><tr><th></th></tr></thead><tbody><tr><td style=text-align:left><a href=https://github.com/jmpews/Dobby>https://github.com/jmpews/Dobby</a></td></tr><tr><td style=text-align:left><a href=https://github.com/or-dvir/EasySettings>https://github.com/or-dvir/EasySettings</a></td></tr><tr><td style=text-align:left><a href=https://github.com/zupet/LuaTinker>https://github.com/zupet/LuaTinker</a> or <a href=https://github.com/yanwei1983/luatinkerE>https://github.com/yanwei1983/luatinkerE</a></td></tr><tr><td style=text-align:left><a href=https://github.com/DimaKoz/stunning-signature>https://github.com/DimaKoz/stunning-signature</a></td></tr><tr><td style=text-align:left><a href=https://www.sqlite.org/index.html>https://www.sqlite.org/index.html</a></td></tr><tr><td style=text-align:left><a href=https://github.com/nlohmann/json>https://github.com/nlohmann/json</a></td></tr><tr><td style=text-align:left><a href=https://www.lua.org/manual/5.3/>https://www.lua.org/manual/5.3/</a></td></tr><tr><td style=text-align:left><a href=https://github.com/kikito/md5.lua>https://github.com/kikito/md5.lua</a></td></tr><tr><td style=text-align:left><a href=https://github.com/rxi/json.lua>https://github.com/rxi/json.lua</a></td></tr></tbody></table><h3 id=list-of-the-unity-functions-used-by-pgsharp>List of the Unity Functions used by PGSharp</h3><div class="accordion accordion-flush" id=spoiler-15><div class=accordion-item><h2 class=accordion-header id=flush-heading-spoiler-15><button class="accordion-button collapsed" type=button data-bs-toggle=collapse data-bs-target=#flush-collapse-spoiler-15 aria-expanded=true aria-controls=flush-collapse-spoiler-15>
<i class='fas fa-table'></i>&nbsp;&nbsp;Expand</button></h2><div id=flush-collapse-spoiler-15 class="accordion-collapse collapse" aria-labelledby=flush-heading-spoiler-15 data-bs-parent=#spoiler-15><div class=accordion-body><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>object__Invoke
</span></span><span style=display:flex><span>String_CreateString1
</span></span><span style=display:flex><span>String_CreateString3
</span></span><span style=display:flex><span>ulong_object___get_Item
</span></span><span style=display:flex><span>ulong_object___ContainsKey
</span></span><span style=display:flex><span>ulong_object___TryGetValue
</span></span><span style=display:flex><span>Application_OpenURL
</span></span><span style=display:flex><span>Application_set_targetFrameRate
</span></span><span style=display:flex><span>Quaternion_Angle
</span></span><span style=display:flex><span>PlayerPrefs_TrySetInt
</span></span><span style=display:flex><span>PlayerPrefs_TrySetFloat
</span></span><span style=display:flex><span>PlayerPrefs_TrySetSetString
</span></span><span style=display:flex><span>PlayerPrefs_SetInt
</span></span><span style=display:flex><span>PlayerPrefs_GetInt
</span></span><span style=display:flex><span>PlayerPrefs_SetFloat
</span></span><span style=display:flex><span>PlayerPrefs_GetFloat
</span></span><span style=display:flex><span>PlayerPrefs_SetString
</span></span><span style=display:flex><span>PlayerPrefs_GetStringNoDefault
</span></span><span style=display:flex><span>PlayerPrefs_HasKey
</span></span><span style=display:flex><span>PlayerPrefs_DeleteKey
</span></span><span style=display:flex><span>Component_get_gameObject
</span></span><span style=display:flex><span>Transform_get_rotation
</span></span><span style=display:flex><span>Animator_get_speed
</span></span><span style=display:flex><span>Animator_set_speed
</span></span><span style=display:flex><span>Animator_SetTriggerID
</span></span><span style=display:flex><span>Animator_Update
</span></span><span style=display:flex><span>Promise__ctor
</span></span><span style=display:flex><span>Promise_Complete
</span></span><span style=display:flex><span>MapMath_MetersBetween
</span></span><span style=display:flex><span>NL_NLAny_object_
</span></span><span style=display:flex><span>NL_NLFirst_object_
</span></span><span style=display:flex><span>InputField_ActivateInputField
</span></span><span style=display:flex><span>InputField_DeactivateInputField
</span></span><span style=display:flex><span>Text_set_text
</span></span><span style=display:flex><span>Text_set_fontSize
</span></span><span style=display:flex><span>DiContainer_InjectExplicitInternal
</span></span><span style=display:flex><span>Schedule_WaitOn_c__AnonStorey0____m__0
</span></span><span style=display:flex><span>GameState_EnterState
</span></span><span style=display:flex><span>GameState_ExitState
</span></span><span style=display:flex><span>RpcBindings_Send
</span></span><span style=display:flex><span>RpcManager_DispatchCallbacks
</span></span><span style=display:flex><span>Animator_SetTriggerID
</span></span><span style=display:flex><span>RpcManager_DispatchCallbacks
</span></span><span style=display:flex><span>AuthService_get_CachedCredentialsExist
</span></span><span style=display:flex><span>AuthService_Logout
</span></span><span style=display:flex><span>DeviceServiceExtensions_IsUsable
</span></span><span style=display:flex><span>GameMasterData_IsPokemonWeatherBoosted
</span></span><span style=display:flex><span>Animator_SetTriggerID
</span></span><span style=display:flex><span>AuthService_get_CachedCredentialsExist
</span></span><span style=display:flex><span>AuthService_Logout
</span></span><span style=display:flex><span>PgpApi_UpdateNotifications
</span></span><span style=display:flex><span>ARPlusEncounterValuesProto__ctor
</span></span><span style=display:flex><span>ARPlusEncounterValuesProto__cctor
</span></span><span style=display:flex><span>PlayerService_GetPlayerDayBucket
</span></span><span style=display:flex><span>PlayerService_get_PlayerStats
</span></span><span style=display:flex><span>PlayerService_get_CurrentPokeball
</span></span><span style=display:flex><span>PlayerService_get_CurrentLinkedLogins
</span></span><span style=display:flex><span>AuthService_get_CachedCredentialsExist
</span></span><span style=display:flex><span>PlayerService_get_PokemonBag
</span></span><span style=display:flex><span>PlayerService_GetPlayerProfile
</span></span><span style=display:flex><span>PlayerService_set_CurrentPokeball
</span></span><span style=display:flex><span>PlayerService_get_BagIsFull
</span></span><span style=display:flex><span>PlayerService_GetCandyCountForPokemon
</span></span><span style=display:flex><span>StateToken_Complete
</span></span><span style=display:flex><span>TimeUtil_ServerNowMs
</span></span><span style=display:flex><span>RequestGymDetailsById_onSucceed
</span></span><span style=display:flex><span>RequestGymDetailsById_onError
</span></span><span style=display:flex><span>PlayerPrefs_SetInt
</span></span><span style=display:flex><span>BluetoothUtil_get_IsBluetoothEnabled
</span></span><span style=display:flex><span>PgpGuiController_ClickIcon
</span></span><span style=display:flex><span>PgpGuiService_SetSfidaIconVisible
</span></span><span style=display:flex><span>PgpGuiService_EnableSfidaIcon
</span></span><span style=display:flex><span>ulong_object___get_Item
</span></span><span style=display:flex><span>PgpService_get_IsSessionActive
</span></span><span style=display:flex><span>PgpService_GetCurrentNotificationType
</span></span><span style=display:flex><span>ItemBagImpl_GetItemCount
</span></span><span style=display:flex><span>PokemonBagImpl_GetPokemon
</span></span><span style=display:flex><span>ulong_object___get_Item
</span></span><span style=display:flex><span>PgpApi_UpdateNotifications
</span></span><span style=display:flex><span>Animator_set_speed
</span></span><span style=display:flex><span>StateToken_Complete
</span></span><span style=display:flex><span>VersionCheckService_CheckVersion
</span></span><span style=display:flex><span>ulong_object___TryGetValue
</span></span><span style=display:flex><span>QuestMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>QuestService_BeginQuestEncounterWithOut
</span></span><span style=display:flex><span>EulaGuiController_PressAccept
</span></span><span style=display:flex><span>StarterMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>OpenRemoteGym_gymOpner
</span></span><span style=display:flex><span>OpenRemoteGym_onSucceed
</span></span><span style=display:flex><span>BluetoothUtil_get_IsBluetoothEnabled
</span></span><span style=display:flex><span>QuestService_BeginQuestEncounterWithOut
</span></span><span style=display:flex><span>RaidState_ExitGymWithRaidDetails
</span></span><span style=display:flex><span>AccountChoiceState_ClickNewPlayer
</span></span><span style=display:flex><span>AccountChoiceState_ClickExistingPlayer
</span></span><span style=display:flex><span>LoginAgeGateState_SubmitSelections
</span></span><span style=display:flex><span>LoginChoiceState_ClickPtc
</span></span><span style=display:flex><span>LoginChoiceState_ClickGoogle
</span></span><span style=display:flex><span>LoginGuiController_ClickSubmit
</span></span><span style=display:flex><span>PtcLoginState_SubmitLogin
</span></span><span style=display:flex><span>I18n_PokemonMoveName
</span></span><span style=display:flex><span>I18n_SetUpLanguageTable
</span></span><span style=display:flex><span>I18n_PokemonNameTemporaryEvolution
</span></span><span style=display:flex><span>I18n_Text
</span></span><span style=display:flex><span>I18n_PokemonName
</span></span><span style=display:flex><span>FriendsGuiState_StartOpenGiftFlow
</span></span><span style=display:flex><span>FriendsGuiState_StartSendGiftFlow
</span></span><span style=display:flex><span>FriendsRpcService_RemoveGiftbox
</span></span><span style=display:flex><span>GiftingRpcService_SendGift
</span></span><span style=display:flex><span>GiftingRpcService_OpenGift
</span></span><span style=display:flex><span>StickerService_GetStickerInventory
</span></span><span style=display:flex><span>CombatDirector_Initialize
</span></span><span style=display:flex><span>MapPokestop_get_PoiId
</span></span><span style=display:flex><span>MapPokestop_get_ActiveIncidentType
</span></span><span style=display:flex><span>MapPokestop_get_Location
</span></span><span style=display:flex><span>EncounterParkCameraController_PlayIntro
</span></span><span style=display:flex><span>RunPokemonCaptured_onDitto
</span></span><span style=display:flex><span>EncounterInteractionState_RunAway
</span></span><span style=display:flex><span>MapMath_MetersBetween
</span></span><span style=display:flex><span>PlayerPrefs_TrySetSetString
</span></span><span style=display:flex><span>EncounterInteractionState_IntroCompleted
</span></span><span style=display:flex><span>AttemptCapture_onResponse
</span></span><span style=display:flex><span>EncounterIntroState_ExitState
</span></span><span style=display:flex><span>EncounterPokemon_get_MapPokemon
</span></span><span style=display:flex><span>PlayerPrefs_HasKey
</span></span><span style=display:flex><span>ItemBagImpl_GetItemCount
</span></span><span style=display:flex><span>Pokeball_TryHitPokemon
</span></span><span style=display:flex><span>Pokeball_FlyStateImpl_Capture__MoveNext
</span></span><span style=display:flex><span>Pokeball_DropStateImpl_Capture__MoveNext
</span></span><span style=display:flex><span>EncounterGuiController_ShowPokemonFlee
</span></span><span style=display:flex><span>EncounterState_get_EncounterType
</span></span><span style=display:flex><span>EncounterState_EncounterStateComplete
</span></span><span style=display:flex><span>EncounterState_EncounterStateComplete
</span></span><span style=display:flex><span>EncounterState_get_MapPokemon
</span></span><span style=display:flex><span>EncounterState_OnEncounterResponse
</span></span><span style=display:flex><span>DefaultEncounter_get_DefaultBall
</span></span><span style=display:flex><span>ExtraMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>ResearchEncounter_get_DefaultBall
</span></span><span style=display:flex><span>ResearchEncounter_get_DefaultBall
</span></span><span style=display:flex><span>object_object__object___CurrentPageIndex
</span></span><span style=display:flex><span>PokemonInventoryCellView_Initialize
</span></span><span style=display:flex><span>ToastService_OneLineMedium
</span></span><span style=display:flex><span>ToastService_RewardItemNameAmount
</span></span><span style=display:flex><span>ToastService_RewardItemDefault
</span></span><span style=display:flex><span>ToastService_RewardItemStardust
</span></span><span style=display:flex><span>ToastService_OneLineMediumWithParams
</span></span><span style=display:flex><span>ToastService_RewardItemXlCandy
</span></span><span style=display:flex><span>ToastService_RewardItemAmount
</span></span><span style=display:flex><span>ToastService_TwoLine
</span></span><span style=display:flex><span>ToastService_RewardItemAmountType
</span></span><span style=display:flex><span>ToastService_RewardItemMegaResource
</span></span><span style=display:flex><span>ToastService_RewardSticker
</span></span><span style=display:flex><span>ToastService_OneLineWithParams
</span></span><span style=display:flex><span>ToastService_OneLineBig
</span></span><span style=display:flex><span>ToastService_OneLineBigWithParams
</span></span><span style=display:flex><span>ToastService_RewardItemCandy
</span></span><span style=display:flex><span>UserPromptsService_HasActiveModal
</span></span><span style=display:flex><span>UserPromptsService_DismissActiveModal
</span></span><span style=display:flex><span>PokemonInfoDynoScrollRect_Cleanup
</span></span><span style=display:flex><span>Quaternion_Angle
</span></span><span style=display:flex><span>Animator_get_speed
</span></span><span style=display:flex><span>PokemonInfoPanel_DoUpdate
</span></span><span style=display:flex><span>GymRootController_get_View
</span></span><span style=display:flex><span>GymRootController_get_MapGym
</span></span><span style=display:flex><span>MapGym_get_PoiId
</span></span><span style=display:flex><span>MapGym_OnTap
</span></span><span style=display:flex><span>MapGym_get_Location
</span></span><span style=display:flex><span>RaidMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>MapContentHandler_UpdateCells
</span></span><span style=display:flex><span>MapEntityCell_get_Pois
</span></span><span style=display:flex><span>MapEntityService_get_Cells
</span></span><span style=display:flex><span>MapEntityService_GetMapPoi
</span></span><span style=display:flex><span>MapEntityService_UpdatePois
</span></span><span style=display:flex><span>MapExploreState_GymSelected
</span></span><span style=display:flex><span>MapExploreState_EnterQuestEncounter
</span></span><span style=display:flex><span>MapPokemon_get_Location
</span></span><span style=display:flex><span>MapPokemon_get_DespawnTime
</span></span><span style=display:flex><span>MapPokemon_TryCapture
</span></span><span style=display:flex><span>PhotobombingMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>MapPokestop_get_ActiveIncidentType
</span></span><span style=display:flex><span>SendEncounterRequestCapture_onResponse
</span></span><span style=display:flex><span>PoiMapPokemon_get_SpawnPointId
</span></span><span style=display:flex><span>PoiMapPokemon_get_EncounterId
</span></span><span style=display:flex><span>WildMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>WildMapPokemon_SendEncounterRequest
</span></span><span style=display:flex><span>PoiDirectoryService_AddPokemon
</span></span><span style=display:flex><span>PoiDirectoryService_RemovePokemon
</span></span><span style=display:flex><span>RaidMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>IncidentMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>IncenseMapPokemon_SendEncounterRequest
</span></span><span style=display:flex><span>IncenseMapPokemon_OnDestroy
</span></span><span style=display:flex><span>IncenseMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>TroyDiskMapPokemon_SendEncounterRequest
</span></span><span style=display:flex><span>TroyDiskMapPokemon_get_Pokemon
</span></span><span style=display:flex><span>GroundTapHandler_OnTap
</span></span><span style=display:flex><span>GroundTapHandler_OnTap1
</span></span><span style=display:flex><span>MapViewHandler_GetGroundLocation
</span></span><span style=display:flex><span>MapViewHandler_GetGroundPosition
</span></span><span style=display:flex><span>MapViewHandler_GetWorldLocation
</span></span><span style=display:flex><span>NL_NLFirst_object_
</span></span><span style=display:flex><span>CompassGuiController_Update
</span></span><span style=display:flex><span>PlayerService_SetPlayerProto
</span></span><span style=display:flex><span>MapPokemon_LogEncounterMetrics
</span></span></code></pre></div></div></div></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>O-LLVM provides control-flow obfuscation that can be <em>recovered</em> with emulation.
On the other hand, the data-flow (function parameters, stack values, memory accesses) can be analysed at a basic-block level with static analysis.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><b class=red>libmain.so</b> is also <strong>statically</strong> linked against other libraries like <a href=https://github.com/jmpews/Dobby>jmpews/Dobby</a>,
<a href=https://github.com/nlohmann/json>nlohmann/json</a>, <a href=https://github.com/sqlite/sqlite>sqlite</a> &mldr;&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Modded apps use similar tricks as discussed in <a href=https://blog.quarkslab.com/android-application-diffing-analysis-of-modded-version.html#defeating-obfuscation>Android Application Diffing: Analysis of Modded Version</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>In order to arbitrarily call the underlying function when needed.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref2:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref3:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>The package names are stripped with Proguard but we can quite easily recover those packages.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>Basically, they renamed <a href=https://github.com/jmpews/Dobby/blob/bba23cbee8e3cfff5622ef8b63fb797703baea5f/include/dobby.h#L157>DobbyHook</a> in <code>FbbUePBslRNHWkdS</code>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:7><p>The event is triggered when <code>nativeMuteMasterAudio</code> or <code>nativeRender</code> is registered and they
get the base address by iterating over <code>/proc/&lt;pid>/maps</code>.&#160;<a href=#fnref:7 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:8><p>O-LLVM seems not applied on this function&#160;<a href=#fnref:8 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:9><p>One can also hook the AES encrypt/decrypt functions whose prototype is <code>(uint8_*t key_schedule, uint8_t* inout_buffer, size_t size)</code>&#160;<a href=#fnref:9 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script></body></html>