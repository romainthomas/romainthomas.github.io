<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="This blog post introduces new features of LIEF as well as some uses cases."><meta name=keywords content="lief"><meta property="og:type" content="article"><meta property="og:description" content="This blog post introduces new features of LIEF as well as some uses cases."><meta property="og:title" content="Have fun with LIEF and Executable Formats | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/17-11-have-fun-with-lief-and-executable-formats/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/post/17-11-have-fun-with-lief-and-executable-formats/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2017-11-02T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content="lief"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Have fun with LIEF and Executable Formats | Romain Thomas"><meta name=twitter:description content="This blog post introduces new features of LIEF as well as some uses cases."><meta name=twitter:domain content="https://www.romainthomas.fr/post/17-11-have-fun-with-lief-and-executable-formats/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/17-11-have-fun-with-lief-and-executable-formats/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/post/17-11-have-fun-with-lief-and-executable-formats/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4></div><h1 class="display-3 mb-4 px-lg-5">Have fun with LIEF and Executable Formats</h1><div class=post-meta><span class="fw-bold me-3">Romain Thomas</span>
<span class="post-date me-3">November 2, 2017</span>
<span class=fw-bold>13 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/17-11-have-fun-with-lief-and-executable-formats/featured.png class="rounded img-fluid" alt=featured.png></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fa-duotone fa-link-horizontal" style=color:#084298></span></div></div><div class=ps-4><span class="h6 m-0 mb-1" style=color:#084298>This post has been originally posted on the <a href=https://blog.quarkslab.com/have-fun-with-lief-and-executable-formats.html>Quarkslab&rsquo;s blog</a></span></div></div></div></div><p>This blog post introduces new features of LIEF as well as some uses cases.</p><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff><strong>Tl;DR</strong>: LIEF v0.8.3 is out. The main changelog is available <a href=https://lief.quarkslab.com/doc/changelog.html#october-16-2017>here</a>
and packages can be downloaded on the <a href=https://lief.quarkslab.com/#download>official website</a>.</div><p>To install the Python package:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> pip install lief
</span></span></code></pre></div><h2 id=development-process>Development process</h2><p>We attach a great importance to the automation of some development tasks like testing, distributing, packaging, etc. Here is a summary of these processes:</p><p>Each commits is tested on</p><ul><li>Linux - x86-64 - Python{2.7, 3.5, 3.6}</li><li>Windows - x86 / x86-64 - Python{2.7, 3.5, 3.6}</li><li>OSX - x86-64 - Python{2.7, 3.5, 3.6}</li></ul><p>The test suite includes:</p><ul><li>Tests on the Python API</li><li>Tests on the C API</li><li>Tests on the parsers</li><li>Tests on the builders</li></ul><p>If tests succeeds packages are automatically uploaded on the <a href=https://github.com/lief-project/packages>https://github.com/lief-project/packages</a> repository.</p><p>For tagged version, packages are uploaded on the Github release page: <a href=https://github.com/lief-project/LIEF/releases>https://github.com/lief-project/LIEF/releases</a>.
Dockerlief</p><h3 id=dockerlief>Dockerlief</h3><p>To facilitate the compilation and the use of LIEF, we created the <a href=https://github.com/lief-project/Dockerlief>Dockerlief</a>
repo which includes various
<a href=https://github.com/lief-project/Dockerlief/tree/v0.1.0/dockerlief/dockerfiles>Dockerfiles</a> as well as the
<code>dockerlief</code> utility. <code>dockerlief</code> is basically a wrapper on docker build .</p><p>Among Dockerfiles, we provide a <a href=https://github.com/lief-project/Dockerlief/blob/v0.1.0/dockerlief/dockerfiles/android.docker>Dockerfile</a>
to cross compile LIEF for Android (<code>ARM</code>, <code>AARCH64</code>, <code>x86</code>, <code>x86-64</code>)</p><p>To cross compile LIEF for Android ARM, one can run:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> dockerlief build --api-level <span style=color:#666>21</span> --arm lief-android
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>[INFO] - Location of the Dockerfiles: ~/dockerfiles
</span></span></span><span style=display:flex><span><span style=color:#888>[INFO] - Building Dockerfile: &#39;lief-android&#39;
</span></span></span><span style=display:flex><span><span style=color:#888>[INFO] - Target architecture: armeabi-v7a
</span></span></span><span style=display:flex><span><span style=color:#888>[INFO] - Target API Level: 21
</span></span></span></code></pre></div><p>The SDK package <code>LIEF-0.8.3-Android_API21_armeabi-v7a.tar.gz</code> is automatically pulled from the Docker to
the current directory.</p><h3 id=integration-of-libfuzzer>Integration of LibFuzzer</h3><p>Fuzzing our own library is a good way to detect bugs, memory leak, unsanitized inputs &mldr;</p><p>Thus, we integrated <a href=https://llvm.org/docs/LibFuzzer.html>LibFuzzer</a> in the project.
Fuzzing the LIEF ELF, PE, Mach-O parser is as simple as:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;LIEF/LIEF.hpp&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;vector&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;memory&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00></span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>extern</span> <span style=color:#ba2121>&#34;C&#34;</span> <span style=color:#b00040>int</span> LLVMFuzzerTestOneInput(<span style=color:green;font-weight:700>const</span> <span style=color:#b00040>uint8_t</span> <span style=color:#666>*</span>data, size_t size) {
</span></span><span style=display:flex><span>  std<span style=color:#666>::</span>vector<span style=color:#666>&lt;</span><span style=color:#b00040>uint8_t</span><span style=color:#666>&gt;</span> raw <span style=color:#666>=</span> {data, data <span style=color:#666>+</span> size};
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>try</span> {
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>unique_ptr<span style=color:#666>&lt;</span>LIEF<span style=color:#666>::</span>Binary<span style=color:#666>&gt;</span> b{LIEF<span style=color:#666>::</span>Parser<span style=color:#666>::</span>parse(raw)};
</span></span><span style=display:flex><span>  } <span style=color:green;font-weight:700>catch</span> (<span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>exception<span style=color:#666>&amp;</span> e) {
</span></span><span style=display:flex><span>    std<span style=color:#666>::</span>cout <span style=color:#666>&lt;&lt;</span> e.what() <span style=color:#666>&lt;&lt;</span> std<span style=color:#666>::</span>endl;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>To launch the fuzzer, one can run the following commands:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> make fuzz-elf   <span style=color:#408080;font-style:italic># Launch ELF Fuzzer</span>
</span></span><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> make fuzz-pe    <span style=color:#408080;font-style:italic># Launch PE Fuzzer</span>
</span></span><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> make fuzz-macho <span style=color:#408080;font-style:italic># Launch MachO Fuzzer</span>
</span></span><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> make fuzz       <span style=color:#408080;font-style:italic># Launch ELF, PE and MachO Fuzzer</span>
</span></span></code></pre></div><h2 id=elf>ELF</h2><h3 id=play-with-elf-symbols---part-2>Play with ELF symbols - Part 2</h3><p>In the <a href=https://lief.quarkslab.com/doc/tutorials/03_elf_change_symbols.html>tutorial #03</a> we demonstrated
how to swap dynamic symbols between a binary and a library.
In this part, we will see how we can rename these symbols.</p><p>Changing symbol names is not a trivial modification, since modifying the string table of the <code>PT_DYNAMIC</code>
segment has side effects:</p><ul><li>It requires to update the hash table (GNU Hash / SYSV).</li><li>It usually requires to extend the <code>DYNAMIC</code> part of the ELF format.</li></ul><p>The previous version of LIEF already implements the rebuilding of the hash table but not the extending of
the <code>DYNAMIC</code> part.</p><p>With the <code>v0.8.3</code> we can extend the <code>DYNAMIC</code> part. Therefore:</p><ul><li>We can add new entries in the <code>.dynamic</code> section</li><li>We can change dynamic symbols names</li><li>We can change <code>DT_RUNPATH</code> and <code>DT_RPATH</code> without length restriction</li></ul><p>We will rename all <strong>imported</strong> functions of <code>gpg</code> that are imported from <code>libgcrypt.so.20</code> into
<code>a_very_long_name_of_function_XX</code> and all exported functions of <code>libgcrypt.so.20</code> into the same name
(<em>XX</em> is the symbol index). <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Load targets</span>
</span></span><span style=display:flex><span>gpg <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;/usr/bin/gpg&#34;</span>)
</span></span><span style=display:flex><span>libgcrypt <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;/usr/lib/libgcrypt.so.20&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Change names</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> idx, lsym <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>enumerate</span>(<span style=color:green>filter</span>(<span style=color:green;font-weight:700>lambda</span> e : e<span style=color:#666>.</span>exported, libgcrypt<span style=color:#666>.</span>dynamic_symbols)):
</span></span><span style=display:flex><span>  new_name <span style=color:#666>=</span> <span style=color:#ba2121>&#39;a_very_long_name_of_function_</span><span style=color:#b68;font-weight:700>{:d}</span><span style=color:#ba2121>&#39;</span><span style=color:#666>.</span>format(idx)
</span></span><span style=display:flex><span>  <span style=color:green>print</span>(<span style=color:#ba2121>&#34;New name for &#39;</span><span style=color:#b68;font-weight:700>{}</span><span style=color:#ba2121>&#39;: </span><span style=color:#b68;font-weight:700>{}</span><span style=color:#ba2121>&#34;</span><span style=color:#666>.</span>format(lsym<span style=color:#666>.</span>name, new_name))
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>for</span> bsym <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>filter</span>(<span style=color:green;font-weight:700>lambda</span> e : e<span style=color:#666>.</span>name <span style=color:#666>==</span> lsym<span style=color:#666>.</span>name, gpg<span style=color:#666>.</span>dynamic_symbols):
</span></span><span style=display:flex><span>    bsym<span style=color:#666>.</span>name <span style=color:#666>=</span> new_name
</span></span><span style=display:flex><span>  lsym<span style=color:#666>.</span>name <span style=color:#666>=</span> new_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Write back</span>
</span></span><span style=display:flex><span>binary<span style=color:#666>.</span>write(gpg<span style=color:#666>.</span>name)
</span></span><span style=display:flex><span>libgcrypt<span style=color:#666>.</span>write(libgcrypt<span style=color:#666>.</span>name)</span></span></code></pre></td></tr></table></div></div><p>By using <code>readelf</code> we can check that function names have been modified:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -s ./gpg|grep <span style=color:#ba2121>&#34;a_very_long_name&#34;</span>
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>   2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND a_very_long_name_of_funct@GCRYPT_1.6 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND a_very_long_name_of_funct@GCRYPT_1.6 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>  11: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND a_very_long_name_of_funct@GCRYPT_1.6 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>  13: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND a_very_long_name_of_funct@GCRYPT_1.6 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>  ...
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:navy;font-weight:700>$</span> readelf -s ./libgcrypt.so.20|grep <span style=color:#ba2121>&#34;a_very_long_name&#34;</span>
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>  88: 000000000000d050     6 FUNC    GLOBAL DEFAULT   10 a_very_long_name_of_funct@@GCRYPT_1.6
</span></span></span><span style=display:flex><span><span style=color:#888>  89: 000000000000dcd0    69 FUNC    GLOBAL DEFAULT   10 a_very_long_name_of_funct@@GCRYPT_1.6
</span></span></span><span style=display:flex><span><span style=color:#888>  90: 000000000000d310    34 FUNC    GLOBAL DEFAULT   10 a_very_long_name_of_funct@@GCRYPT_1.6
</span></span></span><span style=display:flex><span><span style=color:#888>  91: 000000000000de70    81 FUNC    GLOBAL DEFAULT   10 a_very_long_name_of_funct@@GCRYPT_1.6
</span></span></span><span style=display:flex><span><span style=color:#888>  ...
</span></span></span></code></pre></div><p><img src=./ida_gpg.png alt></p><p>Now if we run the new <code>gpg</code> binary, we get the following error:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> ./gpg --output bar.txt --symmetric ./foo.txt
</span></span><span style=display:flex><span><span style=color:#888>relocation error: ./gpg: symbol a_very_long_name_of_function_8, version GCRYPT_1.6 not defined in file libgcrypt.so.20 with link time reference
</span></span></span></code></pre></div><p>Because the Linux loader tries to resolve the function <code>a_very_long_name_of_function_8</code> against
<code>/usr/lib/libgcrypt.so.20</code> and that library doesn&rsquo;t include the updated names we get the error.</p><p>One way to fix this error is to set the environment variable <code>LD_LIBRARY_PATH</code> to the current directory:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> <span style=color:#19177c>LD_LIBRARY_PATH</span><span style=color:#666>=</span>. ./gpg --output bar.txt --symmetric ./foo.txt
</span></span><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> xxd ./bar.txt|head -n1
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>00000000: 8c0d 0407 0302 c5af 9fba cab1 9545 ebd2  .............E..
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:navy;font-weight:700>$</span> <span style=color:#19177c>LD_LIBRARY_PATH</span><span style=color:#666>=</span>. ./gpg --output foo_decrypted.txt --decrypt ./bar.txt
</span></span><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> xxd ./foo_decrypted.txt|head -n1
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>00000000: 4865 6c6c 6f20 576f 726c 640a            Hello World.
</span></span></span></code></pre></div><p>Another way to fix it is to add a new entry in <code>.dynamic</code> section.</p><p>As mentioned at the beginning, we can now add new entries in the <code>.dynamic</code> so let&rsquo;s add a <code>DT_RUNPATH</code> entry
with the <code>$ORIGIN</code> value so that the Linux loader resolves the modified <code>libgcrypt.so.20</code> instead of the system one:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Add a DT_RUNPATH entry</span>
</span></span><span style=display:flex><span>gpg <span style=color:#666>+=</span> lief<span style=color:#666>.</span>ELF<span style=color:#666>.</span>DynamicEntryRunPath(<span style=color:#ba2121>&#34;$ORIGIN&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic># Write back</span>
</span></span><span style=display:flex><span>binary<span style=color:#666>.</span>write(gpg<span style=color:#666>.</span>name)
</span></span><span style=display:flex><span>libgcrypt<span style=color:#666>.</span>write(libgcrypt<span style=color:#666>.</span>name)</span></span></code></pre></td></tr></table></div></div><p>And we don&rsquo;t need the <code>LD_LIBRARY_PATH</code> anymore:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -d ./gpg|grep RUNPATH
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>0x000000000000001d (RUNPATH)            Library runpath: [$ORIGIN]
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:navy;font-weight:700>$</span> ./gpg --decrypt ./bar.txt
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>gpg: AES encrypted data
</span></span></span><span style=display:flex><span><span style=color:#888>gpg: encrypted with 1 passphrase
</span></span></span><span style=display:flex><span><span style=color:#888>Hello World
</span></span></span></code></pre></div><h3 id=hiding-its-symbols>Hiding its symbols</h3><p>While IDA v7.0 has been released recently, among the <a href=https://www.hex-rays.com/products/ida/7.0/index.shtml>changelog</a>
one can notice two changes:</p><blockquote><ul><li>ELF: describe symbols using symtab from DYNAMIC section</li><li>ELF: IDA now uses the PHT by default instead of the SHT to load segments from ELF files</li></ul></blockquote><p>These changes are partially true. Let&rsquo;s see what go wrong in IDA with the following snippet:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green>id</span> <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;/usr/bin/id&#34;</span>)
</span></span><span style=display:flex><span>dynsym <span style=color:#666>=</span> <span style=color:green>id</span><span style=color:#666>.</span>get_section(<span style=color:#ba2121>&#34;.dynsym&#34;</span>)
</span></span><span style=display:flex><span>dynsym<span style=color:#666>.</span>entry_size <span style=color:#666>=</span> dynsym<span style=color:#666>.</span>size <span style=color:#666>//</span> <span style=color:#666>2</span>
</span></span><span style=display:flex><span><span style=color:green>id</span><span style=color:#666>.</span>write(<span style=color:#ba2121>&#34;id_test&#34;</span>)</span></span></code></pre></td></tr></table></div></div><p>This snippet defines the size of <strong>one</strong> symbol as the entire size of <code>.dynsym</code> section divided by 2.
The <em>normal</em> size of ELF symbols would be:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(<span style=color:green>int</span>(lief<span style=color:#666>.</span>ELF<span style=color:#666>.</span>ELF32<span style=color:#666>.</span>SIZES<span style=color:#666>.</span>SYM)) <span style=color:#408080;font-style:italic># For 32-bits</span>
</span></span><span style=display:flex><span><span style=color:#666>16</span>
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(<span style=color:green>int</span>(lief<span style=color:#666>.</span>ELF<span style=color:#666>.</span>ELF64<span style=color:#666>.</span>SIZES<span style=color:#666>.</span>SYM)) <span style=color:#408080;font-style:italic># For 64-bits</span>
</span></span><span style=display:flex><span><span style=color:#666>24</span></span></span></code></pre></div><p>In the case of the 64-bits <code>id</code> binary, we set this size to <strong>924</strong>.</p><p>When opening <code>id_test</code> in IDA and forcing to use <strong>Segment</strong> for parsing and not <strong>Sections</strong> we get the
following imports:</p><div class=row><div class="d-flex col-12 col-lg-4 align-middle mb-4 mb-sm-0"><img src=ida_loading.png alt="IDA Loading Dialog"></div><div class="d-flex col-12 col-lg-8 align-middle"><img src=ida_imports.png alt="IDA Loading Dialog"></div></div><p>Only one import is resolved and the others are <strong>hidden</strong>.</p><p>Note that <code>id_test</code> is still executable:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> id_test
</span></span><span style=display:flex><span><span style=color:#888>uid=1000(romain) gid=1000(romain) ...
</span></span></span></code></pre></div><p>By using <code>readelf</code> we can still retrieve the symbols and we have an error indicating that symbol size is corrupted.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -s id_test
</span></span><span style=display:flex><span><span style=color:#888>readelf: Error: Section 5 has invalid sh_entsize of 000000000000039c
</span></span></span><span style=display:flex><span><span style=color:#888>readelf: Error: (Using the expected size of 24 for the rest of this dump)
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>Symbol table &#39;.dynsym&#39; contains 77 entries:
</span></span></span><span style=display:flex><span><span style=color:#888>  Num:    Value          Size Type    Bind   Vis      Ndx Name
</span></span></span><span style=display:flex><span><span style=color:#888>   0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
</span></span></span><span style=display:flex><span><span style=color:#888>   1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND endgrent@GLIBC_2.2.5 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __uflow@GLIBC_2.2.5 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND getenv@GLIBC_2.2.5 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   4: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND free@GLIBC_2.2.5 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   5: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND abort@GLIBC_2.2.5 (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   ...
</span></span></span></code></pre></div><p>In LIEF the (dynamic) symbol table address is computed through the <code>DT_SYMTAB</code> from the <code>PT_DYNAMIC</code> segment.</p><p>To compute the number of dynamic symbols LIEF uses three heuristics:</p><ol><li>Based on hash tables (<a href=https://github.com/lief-project/LIEF/blob/0.8.3/src/ELF/Parser.tcc#L711-L796>GNU Hash</a> / <a href=https://github.com/lief-project/LIEF/blob/0.8.3/src/ELF/Parser.tcc#L690-L708>Sysv Hash</a>)</li><li>Based on <a href=https://github.com/lief-project/LIEF/blob/0.8.3/src/ELF/Parser.tcc#L513-L648>relocations</a></li><li>Based on <a href=https://github.com/lief-project/LIEF/blob/0.8.3/src/ELF/Parser.tcc#L653-L672>sections</a></li></ol><p>Malwares start to use this kind of corruption as we will see in the next part.</p><h3 id=rootnik-malware>Rootnik Malware</h3><p>Rootnik is a malware targeting Android devices. It has been analyzed by Fortinet security researcher.</p><p>A full analysis of the malware is available on the <a href=https://blog.fortinet.com/2017/07/09/unmasking-android-malware-a-deep-dive-into-a-new-rootnik-variant-part-i>Fortinet blog</a>.</p><p>This part is focused on the ELF format analysis of one component: libshell.</p><p>Actually there are two libraries <code>libshella_2.10.3.1.so</code> and <code>libshellx_2.10.3.1.so</code>. As they have the same
purpose, we will use the x86 version.</p><p>First if we look at the ELF sections of <code>libshellx_2.10.3.1.so</code> we can notice that the <strong>address</strong>, <strong>offset</strong>
and <strong>size</strong> of some sections like <code>.text</code>, <code>.init_array</code>, <code>.dynstr</code>, <code>.dynsym</code> are set to 0.</p><p>This kind of modification is used to disturb tools that rely on <strong>sections</strong> to parse some ELF structures
(like objdump, readelf, IDA &mldr;)</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -S ./libshellx-2.10.3.1.so
</span></span><span style=display:flex><span><span style=color:#888>There are 21 section headers, starting at offset 0x2431c:
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>Section Headers:
</span></span></span><span style=display:flex><span><span style=color:#888>  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 1] .dynsym           DYNSYM          00000114 000114 000300 10   A  2   1  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 2] .dynstr           STRTAB          00000414 000414 0001e2 00   A  0   0  1
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 3] .hash             HASH            00000000 000000 000000 04   A  1   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 4] .rel.dyn          REL             00000000 000000 000000 08   A  1   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 5] .rel.plt          REL             00000000 000000 000000 08  AI  1   6  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 6] .plt              PROGBITS        00000000 000000 000000 04  AX  0   0 16
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 7] .text             PROGBITS        00000000 000000 000000 00  AX  0   0 16
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 8] .code             PROGBITS        00000000 000000 000000 00  AX  0   0 16
</span></span></span><span style=display:flex><span><span style=color:#888>  [ 9] .eh_frame         PROGBITS        00000000 000000 000000 00   A  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [10] .eh_frame_hdr     PROGBITS        00000000 000000 000000 00   A  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [11] .fini_array       FINI_ARRAY      00000000 000000 000000 00  WA  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [12] .init_array       INIT_ARRAY      00000000 000000 000000 00  WA  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [13] .dynamic          DYNAMIC         0000ce50 00be50 0000f8 08  WA  2   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [14] .got              PROGBITS        00000000 000000 000000 00  WA  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [15] .got.plt          PROGBITS        00000000 000000 000000 00  WA  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [16] .data             PROGBITS        00000000 000000 000000 00  WA  0   0 16
</span></span></span><span style=display:flex><span><span style=color:#888>  [17] .bss              NOBITS          0000d398 00c395 000000 00  WA  0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [18] .comment          PROGBITS        00000000 00c395 000045 01  MS  0   0  1
</span></span></span><span style=display:flex><span><span style=color:#888>  [19] .note.gnu.gold-ve NOTE            00000000 00c3dc 00001c 00      0   0  4
</span></span></span><span style=display:flex><span><span style=color:#888>  [20] .shstrtab         STRTAB          00000000 024268 0000b1 00      0   0  1
</span></span></span><span style=display:flex><span><span style=color:#888>Key to Flags:
</span></span></span><span style=display:flex><span><span style=color:#888>  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
</span></span></span><span style=display:flex><span><span style=color:#888>  L (link order), O (extra OS processing required), G (group), T (TLS),
</span></span></span><span style=display:flex><span><span style=color:#888>  C (compressed), x (unknown), o (OS specific), E (exclude),
</span></span></span><span style=display:flex><span><span style=color:#888>  p (processor specific)
</span></span></span></code></pre></div><p>If we open the given library in IDA we have no exports, no imports and no sections:</p><p><img src=libshell_ida.png alt="IDA Shella"></p><p>Based on the segments and dynamic entries we can recover most of these information:</p><ul><li><code>.init_array</code> address and size are available through the <code>DT_INIT_ARRAY</code> and <code>DT_INIT_ARRAYSZ</code> entries</li><li><code>.dynstr</code> address and size are available through the <code>DT_STRTAB</code> and <code>DT_STRSZ</code></li><li><code>.dynsym</code> address is available through the <code>DT_SYMTAB</code></li></ul><p>The script <a href=https://gist.github.com/romainthomas/c262be2c29ab374451663b9f6dcdfc0d>recover_shellx.py</a>
recovers the missing values, patch sections and rebuild a <em>fixed</em> library.</p><p><img src=libshell_FIXED_ida.png alt="IDA Shella recovered"></p><p>Now if we open the new <code>libshellx-2.10.3.1_FIXED.so</code> we have access to imports / exports and some sections.
The <code>.init_array</code> section contains 2 functions:</p><ol><li><code>tencent652524168491435794009</code></li><li><code>sub_60C0</code></li></ol><p>The <code>tencent652524168491435794009</code> function basically do a stack alignment and the <code>sub_60C0</code> is one of the
decryption routines<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. This function is obfuscated with graph flattening and looks like to O-LLVM graph
flattening passe<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>:</p><p><img src=shellx_cfg.png alt="CFG Flattening"></p><p>Fortunately there are few &ldquo;<em>relevant blocks</em>&rdquo; and there are not obfuscated.</p><p>The function <code>sub_60C0</code> basically iterates over the program headers to find the encrypted one and decrypt
it using a custom algorithm (based on shift, xor, etc).</p><p><img src=shellx_cfg_1.2.png alt="CFG Flattening Handlers"></p><p><img src=shellx_cfg_2.2.png alt="CFG Flattening Decryption Routine"></p><h3 id=triggering-cve-2017-1000249>Triggering CVE-2017-1000249</h3><p>The CVE-2017-1000249 is a stack based buffer overflow in the <code>file</code> utility.
It affects the versions <code>5.29</code>, <code>5.30</code> and <code>5.31</code>.</p><p>Basically the overflow occurs in the size of the note description.</p><p>Using LIEF we can trigger the overflow as follow:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>target <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;/usr/bin/id&#34;</span>)
</span></span><span style=display:flex><span>note_build_id <span style=color:#666>=</span> target[lief<span style=color:#666>.</span>ELF<span style=color:#666>.</span>NOTE_TYPES<span style=color:#666>.</span>BUILD_ID]
</span></span><span style=display:flex><span>note_build_id<span style=color:#666>.</span>description <span style=color:#666>=</span> [<span style=color:#666>0x41</span>] <span style=color:#666>*</span> <span style=color:#666>30</span>
</span></span><span style=display:flex><span>target<span style=color:#666>.</span>write(<span style=color:#ba2121>&#34;id_overflow&#34;</span>)</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> file --version
</span></span><span style=display:flex><span><span style=color:#888>file-5.29
</span></span></span><span style=display:flex><span><span style=color:#888>magic file from /usr/share/file/misc/magic
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:navy;font-weight:700>$</span> id_overflow
</span></span><span style=display:flex><span><span style=color:#888>uid=1000(romain) gid=1000(romain) ...
</span></span></span><span style=display:flex><span><span style=color:#888></span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:navy;font-weight:700>$</span> file id_overflow
</span></span><span style=display:flex><span><span style=color:#888>*** buffer overflow detected ***: file terminated
</span></span></span><span style=display:flex><span><span style=color:#888>./id_overflow: [1] 3418 abort (core dumped)  file ./id_overflow
</span></span></span></code></pre></div><p>Here is the commit that introduced the bug: <a href=https://github.com/file/file/commit/9611f31313a93aa036389c5f3b15eea53510d4d1#diff-bc5c24ef9f39a5f4963ca28ecbc645b3L512>9611f3</a>.</p><h2 id=pe>PE</h2><p>The <em>Load Config</em> directory is now parsed into the <a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/PE/LoadConfigurations/LoadConfiguration.hpp>LoadConfiguration</a> object.
This structure evolves with the Windows versions and LIEF has been designed to support this evolution.
You can take a look at <a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/PE/LoadConfigurations/LoadConfigurationV0.hpp#L47-L52>LoadConfigurationV0</a>,
<a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/PE/LoadConfigurations/LoadConfigurationV6.hpp#L47-L54>LoadConfigurationV6</a>.</p><p>One can find the different versions of this structure in the following directories:</p><ul><li><code>include/LIEF/PE/LoadConfigurations</code></li><li><code>src/PE/LoadConfigurations</code></li></ul><p>The current version of LIEF is able to parse the structure up to Windows 10 build 15002 with the <em>hotpatch
table offset</em>.</p><p>Here are some examples of the <code>LoadConfiguration</code> API:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> target <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;PE64_x86-64_binary_WinApp.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> target<span style=color:#666>.</span>has_configuration
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>True</span>
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> config <span style=color:#666>=</span> target<span style=color:#666>.</span>load_configuration
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> config<span style=color:#666>.</span>version
</span></span><span style=display:flex><span>WIN_VERSION<span style=color:#666>.</span>WIN10_0_15002
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>hex</span>(config<span style=color:#666>.</span>guard_rf_failure_routine)
</span></span><span style=display:flex><span><span style=color:#ba2121>&#39;0x140001040&#39;</span></span></span></code></pre></div><p>LIEF also provides an API to serialize any ELF or PE objects into JSON<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><p>For examples to transform <code>LoadConfiguration</code> object into JSON:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green;font-weight:700>from</span> <span style=color:#00f;font-weight:700>lief</span> <span style=color:green;font-weight:700>import</span> to_json
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> to_json(config)
</span></span><span style=display:flex><span><span style=color:#ba2121>&#39;{&#34;characteristics&#34;:248,&#34;code_integrity&#34;:{&#34;catalog&#34;:0,&#34;catalog_offset&#34;:0 ... }}&#39;</span> <span style=color:#408080;font-style:italic># Not fully printed</span></span></span></code></pre></div><p>One can also serialize the whole Binary object:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> to_json(target)
</span></span><span style=display:flex><span><span style=color:#ba2121>&#39;{&#34;data_directories&#34;:[{&#34;RVA&#34;:0,&#34;size&#34;:0,&#34;type&#34;:&#34;EXPORT_TABLE&#34;},{&#34;RVA&#34;:62584,&#34;section&#34; ...}}&#39;</span> <span style=color:#408080;font-style:italic># # Not fully printed</span></span></span></code></pre></div><h2 id=mach-o>Mach-O</h2><p>For Mach-O binary, dynamic executables embed the <code>LC_DYLD_INFO</code> command which is associated with the
<code>dyld_info_command</code> structure.</p><p>The structure is basically a list of offsets and sizes pointing to other data structures.</p><p>From <code>/usr/lib/mach-o/loader.h</code> the structure looks like this:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>dyld_info_command</span> {
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   cmd;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   cmdsize;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   rebase_off;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   rebase_size;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   bind_off;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   bind_size;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   weak_bind_off;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   weak_bind_size;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   lazy_bind_off;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   lazy_bind_size;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   export_off;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint32_t</span>   export_size;
</span></span><span style=display:flex><span>};</span></span></code></pre></div><p>The <code>dyld</code> loader uses this structure to:</p><ul><li>Rebase the executable</li><li>Bind symbols to addresses</li><li>Retrieve exported functions (or symbols)</li></ul><p>Whereas in the ELF and PE format relocations are basically a <strong>table</strong>, Mach-O format uses <strong>byte streams</strong> to
rebase the image and to bind symbols with addresses. For exports it uses a <strong>trie</strong> as subjacent structure.</p><p>In the new version of LIEF, the Mach-O parser is able to handle these underlying structures to provide an user-friendly API:</p><p>The export trie is represented by the <a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/MachO/ExportInfo.hpp>ExportInfo</a>
object which is usually tied to a <a href=https://github.com/lief-project/LIEF/blob/master/include/LIEF/MachO/Symbol.hpp>Symbol</a>.
The binding byte stream is represented trough the <a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/MachO/BindingInfo.hpp>BindingInfo</a> object.</p><p>For the rebase byte stream, the parser create virtual relocations to model the rebasing process.
These virtual relocations are represented by the <a href=https://github.com/lief-project/LIEF/blob/0.8.3/include/LIEF/MachO/RelocationDyld.hpp>RelocationDyld</a>
object and among other attributes it contains <code>address</code>, <code>size</code> and <code>type</code><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>.</p><p>Here is an example using the Python API:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>id</span> <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;/usr/bin/id&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(<span style=color:green>id</span><span style=color:#666>.</span>relocations[<span style=color:#666>0</span>])
</span></span><span style=display:flex><span><span style=color:#666>100002000</span> POINTER <span style=color:#666>64</span> DYLDINFO __DATA<span style=color:#666>.</span>__eh_frame dyld_stub_binder
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(<span style=color:green>id</span><span style=color:#666>.</span>has_dyld_info)
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>True</span>
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> dyldinfo <span style=color:#666>=</span> <span style=color:green>id</span><span style=color:#666>.</span>dyld_info
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(dyldinfo<span style=color:#666>.</span>bindings[<span style=color:#666>0</span>])
</span></span><span style=display:flex><span>Class:       STANDARD
</span></span><span style=display:flex><span>Type:        POINTER
</span></span><span style=display:flex><span>Address:     <span style=color:#666>0x100002010</span>
</span></span><span style=display:flex><span>Symbol:      ___stderrp
</span></span><span style=display:flex><span>Segment:     __DATA
</span></span><span style=display:flex><span>Library:     <span style=color:#666>/</span>usr<span style=color:#666>/</span>lib<span style=color:#666>/</span>libSystem<span style=color:#666>.</span>B<span style=color:#666>.</span>dylib
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:green>print</span>(dyldinfo<span style=color:#666>.</span>exports[<span style=color:#666>0</span>])
</span></span><span style=display:flex><span>Node Offset: <span style=color:#666>18</span>
</span></span><span style=display:flex><span>Flags:       <span style=color:#666>0</span>
</span></span><span style=display:flex><span>Address:     <span style=color:#666>0</span>
</span></span><span style=display:flex><span>Symbol:      __mh_execute_header</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>In this release we did a large improvement of the ELF builder. Mach-O and PE parts gain new objects and new
functions. LIEF is now available on <a href=https://pypi.python.org/pypi/lief>pypi</a>
and can be added in the requirements of Python projects whatever the Python version and the target platform.</p><p>Since the <code>v0.7.0</code> LIEF has been presented at <a href="https://prog2017.rmll.info/programme/securite-entre-transparence-et-opacite/lief-bibliotheque-d-instrumentation-de-formats-executables-mais-ca-fait-bife-c?lang=en">RMLL</a>
and the <a href=http://www.misp-project.org/>MISP</a> project uses it for its <em>PyMISP objects</em>.</p><p>Some may complain about the C API. They are right! Until the <code>v1.0.0</code> we will provide a minimal C API.
Once C++ API is stable we plan to provide full APIs for Python, C, Java, OCaml<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>, etc.</p><p>Next version should be focused on the Mach-O builder especially for adding sections and segments.
We also plan to support PE <code>.NET</code> headers and fix some performances issues.</p><p>For questions you can join the <a href=https://gitter.im/lief-project>Gitter channel</a>.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>All Python examples are done with the 3.5 version&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>As mentioned in the Fortinet blog post, the library is packed.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>See the blog post about O-LLVM analysis: <a href=https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html>https://blog.quarkslab.com/deobfuscation-recovering-an-ollvm-protected-program.html</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>This feature is not yet available for MachO objects&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>Due to the inheritance relationship and abstraction these attributes are located in the MachO::Relocation and LIEF::Relocation objects.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=https://github.com/aziem/LIEF-ocaml>https://github.com/aziem/LIEF-ocaml</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script></body></html>