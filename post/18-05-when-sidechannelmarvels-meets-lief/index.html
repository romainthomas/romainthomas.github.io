<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="On how we used LIEF to lift an Android x86_64 library to Linux to perform our usual white-box attacks on it."><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="On how we used LIEF to lift an Android x86_64 library to Linux to perform our usual white-box attacks on it."><meta property="og:title" content="When SideChannelMarvels meets LIEF | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/18-05-when-sidechannelmarvels-meets-lief/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/post/18-05-when-sidechannelmarvels-meets-lief/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2018-05-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="When SideChannelMarvels meets LIEF | Romain Thomas"><meta name=twitter:description content="On how we used LIEF to lift an Android x86_64 library to Linux to perform our usual white-box attacks on it."><meta name=twitter:domain content="https://www.romainthomas.fr/post/18-05-when-sidechannelmarvels-meets-lief/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/18-05-when-sidechannelmarvels-meets-lief/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/post/18-05-when-sidechannelmarvels-meets-lief/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4><a href=/categories/android/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Android</span>
</a><a href=/categories/lief/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">LIEF</span></a></div><h1 class="display-3 mb-4 px-lg-5">When SideChannelMarvels meets LIEF</h1><div class=post-meta><span class="fw-bold me-3">Philippe Teuwen
, Romain Thomas</span>
<span class="post-date me-3">May 3, 2018</span>
<span class=fw-bold>7 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/18-05-when-sidechannelmarvels-meets-lief/featured.png class="rounded img-fluid" alt=featured.png></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fa-duotone fa-link-horizontal" style=color:#084298></span></div></div><div class=ps-4><span class="h6 m-0 mb-1" style=color:#084298>This post has been originally posted on the <a href=https://blog.quarkslab.com/when-sidechannelmarvels-meet-lief.html>Quarkslab&rsquo;s Blog</a></span></div></div></div></div><h2 id=introduction>Introduction</h2><p>For those of you following our SideChannelMarvels<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, you know that whenever we stumble on a non-commercial
white-box implementation, we like to add it to the Deadpool project, a repository of various public white-box
cryptographic implementations and their practical attacks.</p><p>This time, we wanted to have a look at the white-box created by Sanghwan (h2spice) Ahn and proposed during
SECCON2016 CTF<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Apparently only PPP solved it during the competition and Sanghwan wrote himself a write-up<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p>The challenge consists in an Android APK. When you launch it, it displays a flag encrypted a random number of
times (between 1 and 3601). When encrypted only once, the flag is <code>g1UlZafiuGdCgpTkWYjaZg3kE6qCd7kF3kV+nMKcGHc=</code>.</p><p>To be able to ‘plug’ the challenge into our tools, we need to get an easy access to the input and output of
the AES encryption function. A quick look reveals that the actual cryptographic operations are done in a
native library called libnative-lib.so, conveniently available for several architectures. The function
<code>TfcqPqf1lNhu0DC2qGsAAeML0SEmOBYX4jpYUnyT8qYWIlEq(unsigned char*, unsigned char*)</code> is the AES encryption
function we want to attack. Note that the library is obfuscated with Obfuscator-LLVM 3.6.1, as we can see
from its <code>.comment</code> section.</p><p>But we&rsquo;re lazy, so we&rsquo;d like to reuse the x86-64 version of <code>libnative-lib.so</code> under a Linux environment, where
all the SideChannelMarvels toolchain is ready to crunch white-boxes. That&rsquo;s not that simple because, even if
they look alike, dynamic libraries compiled for Android or for Linux have a number of differences and a naive
attempt to load an Android dynamic library under Linux will simply fail.</p><p>Fortunately, we have a nifty tool for parsing and modifying binaries. We&rsquo;re talking about LIEF<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> of course!</p><h2 id=converting-an-android-library-to-linux-with-lief>Converting an Android library to Linux with LIEF</h2><p>The white-box is implemented in the <code>libnative-lib.so</code> which is available for ARM, AMR64, x86 and x86-64
architectures. It&rsquo;s a tiny library exporting one <strong>JNI</strong> function: <code>Java_kr_repo_h2spice_crypto500_MainActivity_a</code>
and importing three functions from external libraries.</p><p>Lifting this library to Linux is possible because the three imported functions
(<code>__cxa_finalize</code>, <code>__cxa_atexit</code>, <code>__stack_chk_fail</code>) are not specific to Android.</p><p>The linked libraries of <code>libnative-lib.so</code> are standard: <code>libc</code>, <code>libstdc++</code> &mldr; except for <code>liblog</code>. But
<code>libnative-lib.so</code> doesn&rsquo;t use any of liblog functions, as we can see in readelf output:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -s -d -W ./libnative-lib.so
</span></span><span style=display:flex><span><span>
</span></span></span><span style=display:flex><span><span></span><span style=color:#888>Dynamic section at offset 0x2ad00 contains 31 entries:
</span></span></span><span style=display:flex><span><span style=color:#888>  Tag  Type    Name/Value
</span></span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span><span style=display:flex><span><span style=color:#888> 0x01 (NEEDED) Shared library: [liblog.so]
</span></span></span><span style=display:flex><span><span style=color:#888> 0x01 (NEEDED) Shared library: [libm.so]
</span></span></span><span style=display:flex><span><span style=color:#888> 0x01 (NEEDED) Shared library: [libstdc++.so]
</span></span></span><span style=display:flex><span><span style=color:#888> 0x01 (NEEDED) Shared library: [libdl.so]
</span></span></span><span style=display:flex><span><span style=color:#888> 0x01 (NEEDED) Shared library: [libc.so]
</span></span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span><span style=display:flex><span><span style=color:#888>Symbol table &#39;.dynsym&#39; contains 32 entries:
</span></span></span><span style=display:flex><span><span style=color:#888> Num: Value  Size Type    Bind   Vis      Ndx Name
</span></span></span><span style=display:flex><span><span style=color:#888>   0: 00000     0 NOTYPE  LOCAL  DEFAULT  UND
</span></span></span><span style=display:flex><span><span style=color:#888>   1: 00000     0 FUNC    GLOBAL DEFAULT  UND __cxa_finalize@LIBC (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   2: 00000     0 FUNC    GLOBAL DEFAULT  UND __cxa_atexit@LIBC (2)
</span></span></span><span style=display:flex><span><span style=color:#888>   3: 04fe0   865 FUNC    GLOBAL DEFAULT   11 Java_kr_repo_h2spice_crypto500_MainActivity_a
</span></span></span><span style=display:flex><span><span style=color:#888>   4: 02070  2281 FUNC    GLOBAL DEFAULT   11 _Z48APtMDGO79Go3cbIkFca2rN0KszanZXOZ7dIPsxDBletW5gdoPcPKci
</span></span></span><span style=display:flex><span><span style=color:#888>   5: 01100  3916 FUNC    GLOBAL DEFAULT   11 _Z48DENCPKY6hzMem3SuzgIXu4u6vxbF1sajPOJ75aN2VTdc7SCLPcPKc
</span></span></span><span style=display:flex><span><span style=color:#888>   6: 00bb0  1345 FUNC    GLOBAL DEFAULT   11 _Z48KwUmSQBCaOVJKeqvABGpVnuErM7j8YCSOagNYBmr2ah0NZBePKc
</span></span></span><span style=display:flex><span><span style=color:#888>   7: 03860  6011 FUNC    GLOBAL DEFAULT   11 _Z48TfcqPqf1lNhu0DC2qGsAAeML0SEmOBYX4jpYUnyT8qYWIlEqPhS_
</span></span></span><span style=display:flex><span><span style=color:#888>   8: 02050    30 FUNC    GLOBAL DEFAULT   11 _Z48h8AU0jPcyu9vXF9Kvg0bGDSl6H3TtcJIoOoU1ZOObCvegZ84i
</span></span></span><span style=display:flex><span><span style=color:#888>   9: 00000     0 FUNC    GLOBAL DEFAULT  UND __stack_chk_fail@LIBC (2)
</span></span></span><span style=display:flex><span><span style=color:#888>  10: 02960  3836 FUNC    GLOBAL DEFAULT   11 _Z48lrsFdMdlAT0vSMVedxmqOkCBF7sCTbhCjYEp1rLP8vatWEGDPh
</span></span></span><span style=display:flex><span><span style=color:#888>  29: 2c008     0 NOTYPE  GLOBAL DEFAULT  ABS _edata
</span></span></span><span style=display:flex><span><span style=color:#888>  30: 2c008     0 NOTYPE  GLOBAL DEFAULT  ABS __bss_start
</span></span></span><span style=display:flex><span><span style=color:#888>  31: 2c050     0 NOTYPE  GLOBAL DEFAULT  ABS _end
</span></span></span></code></pre></div><p>Thus we can simply remove the <code>liblog</code> library by setting its dynamic tag to <code>DT_NULL</code>:</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>libnative <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;libnative-lib.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>liblog     <span style=color:#666>=</span> libnative<span style=color:#666>.</span>get_library(<span style=color:#ba2121>&#34;liblog.so&#34;</span>)
</span></span><span style=display:flex><span>liblog<span style=color:#666>.</span>tag <span style=color:#666>=</span> lief<span style=color:#666>.</span>ELF<span style=color:#666>.</span>DYNAMIC_TAGS<span style=color:#666>.</span>NULL</span></span></code></pre></td></tr></table></div></div><p>We also notice that the <code>libc</code> is named <code>libc.so</code> while the one on the current Linux version is named libc.so.6.
To address this issue, one solution would be to create a symbol link of <code>libc.so.6</code> to <code>libc.so</code> and set the
environment variable <code>LD_LIBRARY_PATH</code> to the directory that contains the symlink.</p><p>A more elegant solution is to rename the library with LIEF:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>libnative<span style=color:#666>.</span>get_library(<span style=color:#ba2121>&#34;libc.so&#34;</span>)<span style=color:#666>.</span>name <span style=color:#666>=</span> <span style=color:#ba2121>&#34;libc.so.6&#34;</span></span></span></code></pre></div><p>Lastly, <code>libnative-lib.so</code> imports <code>__cxa_finalize</code>, <code>__cxa_atexit</code> and <code>__stack_chk_fail</code> with a specific version.
The version can be seen in the imported names, next to the <code>@</code> character. For these symbols, the associated
version is &ldquo;<code>LIBC</code>&rdquo; and, during the loading step, the loader will look for the <code>__cxa_finalize</code> in <code>libc.so.6</code>
with this exact version.</p><p>But the Linux <code>libc.so.6</code> defines these symbols with a &ldquo;<code>GLIBC_2.2.5</code>&rdquo; version:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> readelf -s -W /usr/lib64/libc.so.6|grep __cxa_finalize
</span></span><span style=display:flex><span><span style=color:#888>1944: 00037cf0 535 FUNC GLOBAL DEFAULT 12 __cxa_finalize@@GLIBC_2.2.5
</span></span></span></code></pre></div><p>To fix the version issue, we can simply change the version to unspecified by setting its value to <code>1</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>for</span> s <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>filter</span>(<span style=color:green;font-weight:700>lambda</span> e: e<span style=color:#666>.</span>has_version, libnative<span style=color:#666>.</span>dynamic_symbols):
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> s<span style=color:#666>.</span>symbol_version<span style=color:#666>.</span>value <span style=color:#666>&gt;</span> <span style=color:#666>1</span>: <span style=color:#408080;font-style:italic># Library-defined version</span>
</span></span><span style=display:flex><span>      s<span style=color:#666>.</span>symbol_version<span style=color:#666>.</span>value <span style=color:#666>=</span> <span style=color:#666>1</span> <span style=color:#408080;font-style:italic># Set to unspecified</span></span></span></code></pre></div><p>And then build the modified library:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>libnative<span style=color:#666>.</span>write(<span style=color:#ba2121>&#34;libnative-fixed.so&#34;</span>)</span></span></code></pre></div><p>Finally, we can load and execute the lifted library with <code>dlopen</code> / <code>dlsym</code>: (error handling being stripped for readability)</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>using</span> fnc_t <span style=color:#666>=</span> <span style=color:#b00040>uint64_t</span>(<span style=color:#666>*</span>)(<span style=color:#b00040>unsigned</span> <span style=color:#b00040>char</span><span style=color:#666>*</span>, <span style=color:#b00040>unsigned</span> <span style=color:#b00040>char</span><span style=color:#666>*</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> <span style=color:#00f>main</span>(<span style=color:#b00040>void</span>) {
</span></span><span style=display:flex><span>  <span style=color:#b00040>void</span><span style=color:#666>*</span> h <span style=color:#666>=</span> dlopen(<span style=color:#ba2121>&#34;./libnative-fixed.so&#34;</span>, RTLD_NOW);
</span></span><span style=display:flex><span>  <span style=color:#b00040>void</span><span style=color:#666>*</span> sh <span style=color:#666>=</span> dlsym(h, <span style=color:#ba2121>&#34;_Z48TfcqPqf1lNhu0DC2qGsAAeML0SEmOBYX4jpYUnyT8qYWIlEqPhS_&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fnc_t AES_128_encrypt <span style=color:#666>=</span> <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span>fnc_t<span style=color:#666>&gt;</span>(sh);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#b00040>unsigned</span> <span style=color:#b00040>char</span> plaintext[<span style=color:#666>16</span>];
</span></span><span style=display:flex><span>  <span style=color:#b00040>unsigned</span> <span style=color:#b00040>char</span> ciphertext[<span style=color:#666>16</span>];
</span></span><span style=display:flex><span>  fread(plaintext, <span style=color:#666>1</span>, <span style=color:#666>16</span>, stdin);
</span></span><span style=display:flex><span>  AES_128_encrypt(plaintext, ciphertext);
</span></span><span style=display:flex><span>  fwrite(ciphertext, <span style=color:#666>1</span>, <span style=color:#666>16</span>, stdout);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div><p>This native library has a special structure that enables the transformation:</p><ol><li>It doesn&rsquo;t use functions specific to Android.</li><li>It doesn&rsquo;t use packed relocations.</li><li>It doesn&rsquo;t use exceptions.</li><li>It doesn&rsquo;t use Thread Local Storage (TLS).</li></ol><p>The first point is very uncommon for JNI libraries and this transformation won&rsquo;t be possible for usual libraries.</p><h2 id=eventually-breaking-the-white-box>Eventually breaking the white-box</h2><p>Now that we got a Linux binary of the AES white-box with standardized input/output, we&rsquo;re back into usual
white-box attacks business. The Differential Fault Analysis attack on white-box using our tools is largely
explained in a <a href=https://blog.quarkslab.com/differential-fault-analysis-on-white-box-aes-implementations.html>previous blogpost</a>.
In short, we inject statically some faults in the white-box tables (here,
we&rsquo;ll shoot on the entire <code>.rodata</code> section of the dynamic library), execute the AES on a constant input, and
observe the output for faults. These steps are automated in the <code>deadpool_dfa.Acquisition</code> function, part of
our <a href=https://github.com/SideChannelMarvels/Deadpool>SideChannelMarvels/Deadpool</a> repository.
Once we collected enough faulty outputs, we can apply a well-known
DFA attack to recover the AES key, which is implemented in the <code>phoenixAES.crack</code> function from the
<a href=https://github.com/SideChannelMarvels/JeanGrey>SideChannelMarvels/JeanGrey</a> repository.</p><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>deadpool_dfa</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>phoenixAES</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>processinput</span>(iblock, blocksize):
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> (<span style=color:green>bytes</span><span style=color:#666>.</span>fromhex(<span style=color:#ba2121>&#39;</span><span style=color:#b68;font-weight:700>%0*x</span><span style=color:#ba2121>&#39;</span> <span style=color:#666>%</span> (<span style=color:#666>2</span><span style=color:#666>*</span>blocksize, iblock)), <span style=color:green;font-weight:700>None</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>processoutput</span>(output, blocksize):
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:green>int</span><span style=color:#666>.</span>from_bytes(output, byteorder<span style=color:#666>=</span><span style=color:#ba2121>&#39;big&#39;</span>, signed<span style=color:#666>=</span><span style=color:green;font-weight:700>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>engine <span style=color:#666>=</span> deadpool_dfa<span style=color:#666>.</span>Acquisition(
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># main white-box executable</span>
</span></span><span style=display:flex><span>    targetbin<span style=color:#666>=</span><span style=color:#ba2121>&#39;./main64&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># file where to inject faults, and a reference copy</span>
</span></span><span style=display:flex><span>    targetdata<span style=color:#666>=</span><span style=color:#ba2121>&#39;./libnative-fixed.so&#39;</span>, goldendata<span style=color:#666>=</span><span style=color:#ba2121>&#39;./libnative-fixed.so.gold&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># hook to the DFA library, to validate faulty outputs</span>
</span></span><span style=display:flex><span>    dfa<span style=color:#666>=</span>phoenixAES,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># hooks to process I/O as expected by the white-box executable</span>
</span></span><span style=display:flex><span>    processinput<span style=color:#666>=</span>processinput, processoutput<span style=color:#666>=</span>processoutput,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># some tuning, telling we want to try up to single byte faults</span>
</span></span><span style=display:flex><span>    verbose<span style=color:#666>=</span><span style=color:#666>2</span>, minleaf<span style=color:#666>=</span><span style=color:#666>1</span>, minleafnail<span style=color:#666>=</span><span style=color:#666>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># the libnative-fixed.so .rodata section address range</span>
</span></span><span style=display:flex><span>    addresses<span style=color:#666>=</span>[<span style=color:#666>0x6350</span>,<span style=color:#666>0x2b490</span>]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>outputs <span style=color:#666>=</span> engine<span style=color:#666>.</span>run()[<span style=color:#666>0</span>][<span style=color:#666>0</span>]
</span></span><span style=display:flex><span>phoenixAES<span style=color:#666>.</span>crack(outputs)</span></span></code></pre></td></tr></table></div></div><p>Execution:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>...
</span></span><span style=display:flex><span>Lvl 016 [0x000226DF-0x000226E0[ xor 0x86 -&gt; B25BE351AD6986FF15D1E152E7802EC7 GoodEncFault Column:1 Logged
</span></span><span style=display:flex><span>Lvl 016 [0x000226DF-0x000226E0[ xor 0x69 -&gt; B235E351806986FF15D1E1A4E780A6C7 GoodEncFault Column:1 Logged
</span></span><span style=display:flex><span>Saving 17 traces in dfa_enc_20180427_112029-112038_17.txt
</span></span><span style=display:flex><span>Last round key #N found:
</span></span><span style=display:flex><span>040D08DA68001026F3DC0D68897148B4</span></span></code></pre></div><p>The DFA recovers the last (tenth) round key but the AES key schedule is invertible so we can go back to the
original AES key:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> aes_keyschedule 040D08DA68001026F3DC0D68897148B4 <span style=color:#666>10</span>
</span></span><span style=display:flex><span><span style=color:#888>K00: 6C2893F21B6185E8567238CB78184945
</span></span></span></code></pre></div><p>The key falls in 10.2s and 3300 executions. This is indeed the correct AES key:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> <span style=color:green>echo</span> g1UlZafiuGdCgpTkWYjaZg3kE6qCd7kF3kV+nMKcGHc<span style=color:#666>=</span>|base64 -d|<span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span><span style=color:#888>    openssl enc -d -aes-128-ecb -nopad -K 6C2893F21B6185E8567238CB78184945
</span></span></span><span style=display:flex><span><span style=color:#888>SECCON{owSkwPeH1CHQdPV9KWrSmz9n}
</span></span></span></code></pre></div><h2 id=final-words>Final Words</h2><p>We hope this little exercise will make you feel like using our tools!</p><p>The whitebox and all the scripts to convert the library and apply the attack are available online <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>
and LIEF has its own website<sup id=fnref1:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>Thanks to all Quarkslab colleagues who proofread this article and provided valuable feedback.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Side-Channel Marvels repository, on <a href=https://github.com/SideChannelMarvels>GitHub</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>SECCON2016 Online CTF-Binary / Crypto500 Obfuscated AES, archived <a href=https://github.com/SECCON/SECCON2016_online_CTF/tree/master/Binary/500_Obfuscated%20AES>here</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Sanghwan&rsquo;s Obfuscated AES Write-Up, in <a href=http://www.repo.kr/2016/12/seccon-2016-online-ctf-binarycrypto500_13.html>english</a>, <a href=http://www.repo.kr/2016/12/seccon-2016-online-ctf-binarycrypto500.html>korean</a> and <a href=http://www.repo.kr/2016/12/seccon-2016-online-ctf-binarycrypto500_30.html>japanese</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://lief-project.github.io>Library to Instrument Executable Formats</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>SECCON 2016 Obfuscated AES artifacts <a href=https://github.com/SideChannelMarvels/Deadpool/tree/master/wbs_aes_seccon2016>in Deadpool</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script>function katex_load(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\begin{equation}",right:"\\end{equation}",display:!0},{left:"\\begin{align}",right:"\\end{align}",display:!0},{left:"\\begin{alignat}",right:"\\end{alignat}",display:!0},{left:"\\begin{gather}",right:"\\end{gather}",display:!0},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})}</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=katex_load()></script></body></html>