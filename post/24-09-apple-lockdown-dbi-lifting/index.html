<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu_77ed901cba198b50.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu_7dfc5c06c37dc39c.png><meta name=description content="This blog post demonstrates how to extract liblockdown.dylib from the visionOS dyld shared cache to be instrumented with QBDI on an Apple M1."><meta name=keywords content="iOS,OSX"><meta property="og:type" content="article"><meta property="og:description" content="This blog post demonstrates how to extract liblockdown.dylib from the visionOS dyld shared cache to be instrumented with QBDI on an Apple M1."><meta property="og:title" content="Instrumenting an Apple Vision Pro Library with QBDI | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/24-09-apple-lockdown-dbi-lifting/featured.webp"><meta property="og:url" content="https://www.romainthomas.fr/post/24-09-apple-lockdown-dbi-lifting/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-09-29T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-24T15:46:06+02:00"><meta property="article:tag" content="iOS"><meta property="article:tag" content="OSX"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Instrumenting an Apple Vision Pro Library with QBDI | Romain Thomas"><meta name=twitter:description content="This blog post demonstrates how to extract liblockdown.dylib from the visionOS dyld shared cache to be instrumented with QBDI on an Apple M1."><meta name=twitter:domain content="https://www.romainthomas.fr/post/24-09-apple-lockdown-dbi-lifting/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/24-09-apple-lockdown-dbi-lifting/featured.webp"><title>Romain Thomas</title>
<link rel=canonical href=https://www.romainthomas.fr/post/24-09-apple-lockdown-dbi-lifting/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/vendor/img-comparison-slider/dist/styles.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#trainings class="nav-link fw-bold"><span class="far fa-books"></span> Trainings</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4><a href=/categories/apple/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Apple
</span></a><a href=/categories/lief/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">LIEF
</span></a><a href=/categories/code-lifting/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Code-Lifting</span></a></div><h1 class="display-3 mb-4 px-lg-5">Instrumenting an Apple Vision Pro Library with QBDI</h1><div class=post-meta><span class="fw-bold me-3">Romain Thomas
</span><span class="post-date me-3">September 29, 2024</span>
<span class=fw-bold>10 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/24-09-apple-lockdown-dbi-lifting/featured.webp class="rounded img-fluid" alt=featured.webp></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><h2 id=introduction>Introduction</h2><p>The purpose of this blog post is to demonstrate how to extract a library
from an Apple visionOS 2.0 dyld shared cache to instrument it with
QBDI on an Apple M1.</p><p>Since both, the Apple Vision Pro and the Apple M1 share the same architecture (arm64),
we should (theoretically) be able to execute and instrument binaries from one platform
to the other.</p><p>Given that the environment of iOS/visionOS is more restricted compared
to a macOS running as root with SIP disabled, lifting and instrumenting iOS or visionOS
binaries on an Apple M1 can open new opportunities for fuzzing, reverse engineering
or vulnerability research.</p><p>In general, running or instrumenting an arbitrary function
compiled for iOS/visionOS on an Apple M1 is not possible especially if the given
function is using hardware-specific inputs.</p><p>That being said, research has already shown that we can mock, emulate<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> or trick
platform- or hardware-specific functions.</p><p>I have no doubt that people have already found workarounds for that :)</p><h2 id=dyld-shared-cache>Dyld Shared Cache</h2><p>To speed up program loading, Apple bundles important libraries into a &ldquo;shared&rdquo; cache
which is located in a file (or several files) named <code>dyld_shared_cache_&lt;arch>.&lt;suffix></code>.
On macOS 14 - Sonoma, these shared cache files are located in <code>/System/Volumes/Preboot/Cryptexes/OS/System/Library/dyld/</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>-rwxr-xr-x   1 root  admin   2.3G Aug  4 12:31 dyld_shared_cache_arm64e
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   1.5G Aug  4 12:31 dyld_shared_cache_arm64e.01
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   984K Aug  4 12:31 dyld_shared_cache_arm64e.map
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   819M Aug  4 12:31 dyld_shared_cache_x86_64
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   786M Aug  4 12:31 dyld_shared_cache_x86_64.01
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   723M Aug  4 12:31 dyld_shared_cache_x86_64.02
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   720M Aug  4 12:31 dyld_shared_cache_x86_64.03
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   724M Aug  4 12:31 dyld_shared_cache_x86_64.04
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   169M Aug  4 12:31 dyld_shared_cache_x86_64.05
</span></span><span style=display:flex><span>-rwxr-xr-x   1 root  admin   800K Aug  4 12:31 dyld_shared_cache_x86_64.map
</span></span></code></pre></div><p>If you already wondered where is located <code>/usr/lib/libSystem.B.dylib</code> while this
library is not present on the filesystem, the answer is in the dyld shared cache.</p><p>Prior to dyld v940 (publicly released in February 2022) the dyld shared cache was
composed of a single file (but one per architecture). From version 940,
it is composed of several files.</p><p><img src=./dyldshared_cache.webp alt="Dyld shared cache evolution"></p><p>One of the interesting questions about the dyld shared cache is: <em>how do we extract
or recover a library from this cache?</em></p><p>Indeed, the dyld shared cache encapsulates system libraries (including sensitive ones)
so getting back these libraries as regular Mach-O binaries can be a legitimate question.</p><p>There are different open source tools available for that:</p><ul><li><a href=https://github.com/keith/dyld-shared-cache-extractor>https://github.com/keith/dyld-shared-cache-extractor</a></li><li><a href=https://github.com/blacktop/ipsw>https://github.com/blacktop/ipsw</a></li><li><a href=https://github.com/arandomdev/DyldExtractor>https://github.com/arandomdev/DyldExtractor</a></li></ul><p>The good news is that <a href=https://lief.re>LIEF</a> is also supporting the shared cache with a
C++/Rust/Python API (not publicly released yet).</p><p>Given a visionOS dyld shared cache directory (from <code>Apple_Vision_Pro_2.0_22N320_Restore.ipsw</code>),
we can load it with LIEF through:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:navy;font-weight:700>$</span> ls -l visionOS-2.0/
</span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.01
</span></span></span><span style=display:flex><span><span style=color:#888>...
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.57
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.58
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.59.dylddata
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.60.dyldlinkedit
</span></span></span><span style=display:flex><span><span style=color:#888>dyld_shared_cache_arm64e.symbols
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>shared_cache: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>DyldSharedCache <span style=color:#666>=</span> lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>load(<span style=color:#ba2121>&#34;visionOS-2.0/&#34;</span>)
</span></span></code></pre></div><p>From this <code>lief.dyldsc.DyldSharedCache</code> object, we can iterate over the embedded dylibs with:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>shared_cache: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>DyldSharedCache <span style=color:#666>=</span> <span style=color:#666>...</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> dylib <span style=color:#a2f;font-weight:700>in</span> shared_cache<span style=color:#666>.</span>libraries:
</span></span><span style=display:flex><span>    <span style=color:green>print</span>(<span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;0x</span><span style=color:#b68;font-weight:700>{</span>dylib<span style=color:#666>.</span>address<span style=color:#b68;font-weight:700>:</span><span style=color:#ba2121>016x</span><span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>: </span><span style=color:#b68;font-weight:700>{</span>dylib<span style=color:#666>.</span>path<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>&#34;</span>)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x00000001800f4000: /usr/lib/libobjc.A.dylib
</span></span><span style=display:flex><span>0x000000018013e000: /System/Library/AccessibilityBundles/ARKit.axbundle/ARKit
</span></span><span style=display:flex><span>0x0000000180140000: /System/Library/AccessibilityBundles/ARTraceModule.axbundle/ARTraceModule
</span></span><span style=display:flex><span>0x0000000180142000: /System/Library/AccessibilityBundles/ASMessagesProvider.axbundle/ASMessagesProvider
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>0x0000000251766000: /usr/lib/system/libxpc.dylib
</span></span><span style=display:flex><span>0x00000002517ad000: /usr/lib/updaters/libAce3Updater.dylib
</span></span><span style=display:flex><span>0x00000002517d2000: /usr/lib/updaters/libAppleTCONUpdater.dylib
</span></span><span style=display:flex><span>0x00000002517da000: /usr/lib/updaters/libAppleTypeCRetimerUpdater.dylib
</span></span><span style=display:flex><span>0x0000000251834000: /usr/lib/updaters/libBoraUpdater.dylib
</span></span><span style=display:flex><span>0x000000025184a000: /usr/lib/updaters/libDurantUpdater.dylib
</span></span><span style=display:flex><span>0x0000000251854000: /usr/lib/updaters/libSEUpdater.dylib
</span></span><span style=display:flex><span>0x00000002518c1000: /usr/lib/updaters/libSavageRestoreInfo_iOS.dylib
</span></span><span style=display:flex><span>0x00000002518cc000: /usr/lib/updaters/libSavageUpdater_iOS.dylib
</span></span><span style=display:flex><span>0x00000002519f0000: /usr/lib/usd/libusd_ms.dylib
</span></span><span style=display:flex><span>0x00000002528a7000: /usr/lib/xr/libRuntimeSupport.dylib
</span></span></code></pre></div><p>Getting back to the original question about extracting a library from the dyld
shared cache, we can extract the in-cache Mach-O binary of <code>/usr/lib/liblockdown.dylib</code>
using <code>dylib.get()</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>shared_cache: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>DyldSharedCache <span style=color:#666>=</span> <span style=color:#666>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>liblockdown: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>Dylib <span style=color:#666>=</span> shared_cache<span style=color:#666>.</span>find_library(<span style=color:#ba2121>&#34;/usr/lib/liblockdown.dylib&#34;</span>)
</span></span><span style=display:flex><span>liblockdown_macho: lief<span style=color:#666>.</span>MachO<span style=color:#666>.</span>Binary <span style=color:#666>=</span> liblockdown<span style=color:#666>.</span>get()
</span></span><span style=display:flex><span>liblockdown_macho<span style=color:#666>.</span>write(<span style=color:#ba2121>&#34;liblockdown.1.dylib&#34;</span>)
</span></span></code></pre></div><p>And we have come full circle: we can parse with LIEF shared cache files to get a
<code>DyldSharedCache</code> object. From this instance, we can access the <code>lief.dyldsc.Dylib</code>
object associated with <code>/usr/lib/liblockdown.dylib</code>. From this object, we can
retrieve a LIEF&rsquo;s Mach-O binary with <code>.get()</code>.
Finally, we can re-write back the Mach-O object with LIEF&rsquo;s writer:
<code>liblockdown_macho.write("liblockdown.1.dylib")</code>.</p><p><img src=./img/lief-circle.webp alt="Schema from dyld shared cache to on-disk library"></p><p>You can download <code>liblockdown.1.dylib</code> here: <a href=https://github.com/romainthomas/visionOS-liblockdown/raw/refs/heads/main/bin/liblockdown.1.dylib>romainthomas/visionOS-liblockdown/bin/liblockdown.1.dylib</a>.</p><p>However, if we open this <code>liblockdown.1.dylib</code> library in IDA or BinaryNinja
we might complain about the result:</p><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-1.webp></figure><figure slot=second class=position-relative><img src=img/bn-1.webp></figure></img-comparison-slider><figcaption class="figure-caption text-center fst-italic">Calls & Memory Accesses Broken</figcaption></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-2.webp></figure><figure slot=second class=position-relative><img src=img/bn-2.webp></figure></img-comparison-slider><figcaption class="figure-caption text-center fst-italic">__cfstrings Relocations Broken</figcaption></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-3.webp></figure><figure slot=second class=position-relative><img src=img/bn-3.webp></figure></img-comparison-slider><figcaption class="figure-caption text-center fst-italic">Broken import stubs</figcaption></figure><p>When Apple generates the dyld shared cache, it performs some optimizations and pre-loading,
such as the in-cache libraries are usually referencing addresses specific to the shared cache.
These optimizations usually break:</p><ul><li>Relocations</li><li>Symbol bindings</li><li>Calls</li><li>Got accesses</li><li>ObjC metadata</li></ul><p>Last but not least, on recent shared cache, the <code>LC_DYLD_CHAINED_FIXUPS</code> command
is striped from the library before being added to the shared cache:</p><p><a href=https://github.com/romainthomas/dyld/blob/main/cache-builder/OptimizerLinkedit.cpp#L387-L390><img src=./img/dyld-removed-cmd.webp alt="LC_DYLD_CHAINED_FIXUPS removed during cache builder"></a></p><p>That means that we can&rsquo;t rely on this command to recover the original
bindings or relocations. Fortunately, we can deoptimize the in-cache library
by accessing internal structures of the dyld shared cache.</p><p>All these de-optimizations can be enabled while calling the <code>.get()</code> function
on a <code>LIEF::dyldsc::Dylib</code> object:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;LIEF/DyldSharedCache.hpp&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00></span>
</span></span><span style=display:flex><span>std<span style=color:#666>::</span>unique_ptr<span style=color:#666>&lt;</span>LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Binary<span style=color:#666>&gt;</span> extract(<span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>dyldsc<span style=color:#666>::</span>DyldSharedCache<span style=color:#666>&amp;</span> cache) {
</span></span><span style=display:flex><span>  std<span style=color:#666>::</span>unique_ptr<span style=color:#666>&lt;</span>LIEF<span style=color:#666>::</span>dyldsc<span style=color:#666>::</span>Dylib<span style=color:#666>&gt;</span> liblockdown <span style=color:#666>=</span> cache.find_library(<span style=color:#ba2121>&#34;liblockdown.dylib&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> liblockdown.get({
</span></span><span style=display:flex;background-color:#e5e5e5><span>    .fix_branches    <span style=color:#666>=</span> <span style=color:green>true</span>,
</span></span><span style=display:flex;background-color:#e5e5e5><span>    .fix_memory      <span style=color:#666>=</span> <span style=color:green>true</span>,
</span></span><span style=display:flex;background-color:#e5e5e5><span>    .fix_relocations <span style=color:#666>=</span> <span style=color:green>true</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>We can also ask LIEF to <strong>recreate</strong> a <code>LC_DYLD_CHAINED_FIXUPS</code>
command based on information recovered from previous stages:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-diff data-lang=diff><span style=display:flex><span>#include &lt;LIEF/DyldSharedCache.hpp&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>std::unique_ptr&lt;LIEF::MachO::Binary&gt; extract(const LIEF::dyldsc::DyldSharedCache&amp; cache) {
</span></span><span style=display:flex><span>  std::unique_ptr&lt;LIEF::dyldsc::Dylib&gt; liblockdown = cache.find_library(&#34;liblockdown.dylib&#34;);
</span></span><span style=display:flex><span>  return liblockdown.get({
</span></span><span style=display:flex><span>    .fix_branches    = true,
</span></span><span style=display:flex><span>    .fix_memory      = true,
</span></span><span style=display:flex><span>    .fix_relocations = true,
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:#00a000>+   .create_dyld_chained_fixup_cmd = true,
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Et voilà: <a href=https://github.com/romainthomas/visionOS-liblockdown/raw/refs/heads/main/bin/liblockdown.2.dylib>romainthomas/visionOS-liblockdown/bin/liblockdown.2.dylib</a>.</p><p><img src=./img/lief-circle-next.webp alt="Schema from dyld shared cache to on-disk library"></p><p>Using LIEF Python API it could be done with:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>extract</span>(cache: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>DyldSharedCache) <span style=color:#666>-&gt;</span> lief<span style=color:#666>.</span>MachO<span style=color:#666>.</span>Binary:
</span></span><span style=display:flex><span>    dylib: lief<span style=color:#666>.</span>dyldsc<span style=color:#666>.</span>Dylib <span style=color:#666>=</span> cache<span style=color:#666>.</span>find(<span style=color:#ba2121>&#34;liblockdown.dylib&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> dylib<span style=color:#666>.</span>get(
</span></span><span style=display:flex><span>      fix_branches<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>,
</span></span><span style=display:flex><span>      fix_memory<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>,
</span></span><span style=display:flex><span>      fix_relocations<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>,
</span></span><span style=display:flex><span>      create_dyld_chained_fixup_cmd<span style=color:#666>=</span><span style=color:green;font-weight:700>True</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>extract(vision_os_cache)<span style=color:#666>.</span>write(<span style=color:#ba2121>&#34;liblockdown.2.dylib&#34;</span>)
</span></span></code></pre></div><p>You can observe the differences between the raw extracted <code>liblockdown.1.dylib</code>
and the de-optimized <code>liblockdown.2.dylib</code>:</p><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-1.webp></figure><figure slot=second class=position-relative><img src=img/ida-1-1.webp></figure></img-comparison-slider></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/bn-1.webp></figure><figure slot=second class=position-relative><img src=img/bn-1-1.webp></figure></img-comparison-slider></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-2.webp></figure><figure slot=second class=position-relative><img src=img/ida-2-1.webp></figure></img-comparison-slider></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/bn-2.webp></figure><figure slot=second class=position-relative><img src=img/bn-2-1.webp></figure></img-comparison-slider></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/ida-3.webp></figure><figure slot=second class=position-relative><img src=img/ida-3-1.webp></figure></img-comparison-slider></figure><figure class=figure><img-comparison-slider><figure slot=first class=position-relative><img src=img/bn-3.webp></figure><figure slot=second class=position-relative><img src=img/bn-3-1.webp></figure></img-comparison-slider></figure><p>Now that we have a pretty well-structured <code>liblockdown.dylib</code> with all
the information needed for loading (relocations, bindings, &mldr;) we can start considering
loading this visionOS library on macOS.</p><h2 id=loading-a-visionpro-library-on-macos>Loading a VisionPro library on macOS</h2><p>Back in the day I was working at Quarkslab, I had the chance to create with
<a href=https://github.com/aguinet>Adrien Guinet</a> QBDL: QuarkslaB Dynamic Linker library.</p><p>The idea of this project is to have a cross-platform/cross-format library to load
executables (based on LIEF).</p><p>For the details, you can check:</p><ul><li><a href=https://www.sstic.org/2021/presentation/qbdl_quarkslab_dynamic_loader/>SSTIC Presentation</a></li><li><a href=https://blog.quarkslab.com/introducing-qbdl-how-to-run-the-nvidia-ngx-sdk-under-linux.html>Quarkslab&rsquo;s Blog</a></li><li><a href=https://quarkslab.github.io/QBDL/0.1.0/>Documentation</a></li></ul><p>From an executable format perspective only, the primary differences between Mach-O binaries
for visionOS and macOS (Silicon) lie in their
linked libraries and their imports.</p><p>We could fairly expect that <code>liblockdown.dylib</code> from the visionOS dyld shared cache
is linked with visionOS-specific libraries or importing specific symbols.</p><p>Nonetheless, Apple is an <strong>ecosystem</strong> and they try to minimize the cost for developers
to create an app or a framework that can target different platforms (visionOS/macOS/iOS/watchOS).</p><p>This comes with an API abstraction that we can leverage to lift executables from
one platform on another. In other words, we can likely expect that some libraries
used by <code>liblockdown.dylib</code> for visionOS are also available on macOS.</p><p>Let&rsquo;s check this with QBDL:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;LIEF/LIEF.hpp&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00>#include</span> <span style=color:#bc7a00>&lt;QBDL/QBDL.hpp&gt;</span><span style=color:#bc7a00>
</span></span></span><span style=display:flex><span><span style=color:#bc7a00></span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>using</span> <span style=color:green;font-weight:700>namespace</span> QBDL;
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>using</span> <span style=color:green;font-weight:700>namespace</span> LIEF<span style=color:#666>::</span>MachO;
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>using</span> <span style=color:green;font-weight:700>namespace</span> LIEF;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>FinalTargetSystem</span><span style=color:#666>:</span> <span style=color:green;font-weight:700>public</span> Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetSystem {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>using</span> Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetSystem<span style=color:#666>::</span>TargetSystem;
</span></span><span style=display:flex;background-color:#e5e5e5><span>  <span style=color:#b00040>uint64_t</span> <span style=color:#00f>symlink</span>(Loaders<span style=color:#666>::</span>MachO<span style=color:#666>&amp;</span> loader, <span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Symbol<span style=color:#666>&amp;</span> symbol) <span style=color:green;font-weight:700>override</span> {
</span></span><span style=display:flex;background-color:#e5e5e5><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> <span style=color:#00f>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> mem <span style=color:#666>=</span> std<span style=color:#666>::</span>make_unique<span style=color:#666>&lt;</span>Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetMemory<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> system <span style=color:#666>=</span> std<span style=color:#666>::</span>make_unique<span style=color:#666>&lt;</span>FinalTargetSystem<span style=color:#666>&gt;</span>(<span style=color:#666>*</span>mem);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> loader <span style=color:#666>=</span> Loaders<span style=color:#666>::</span>MachO<span style=color:#666>::</span>from_file(<span style=color:#ba2121>&#34;./liblockdown.2.dylib&#34;</span>
</span></span><span style=display:flex><span>    Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>arch(), <span style=color:#666>*</span>system, Loader<span style=color:#666>::</span>BIND<span style=color:#666>::</span>NOW
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>In this code <code>symlink</code> is a kind of callback that is used by QBDL whenever a symbol
needs to be resolved. For instance, you could redirect <code>printf</code> with:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex;background-color:#e5e5e5><span><span style=color:#b00040>int</span> <span style=color:#00f>my_printf</span>(<span style=color:green;font-weight:700>const</span> <span style=color:#b00040>char</span> <span style=color:#666>*</span><span style=color:green;font-weight:700>restrict</span> format, ...) {
</span></span><span style=display:flex;background-color:#e5e5e5><span>  printf(<span style=color:#ba2121>&#34;w000t&#34;</span>);
</span></span><span style=display:flex;background-color:#e5e5e5><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>5</span>;
</span></span><span style=display:flex;background-color:#e5e5e5><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>uint64_t</span> <span style=color:#00f>symlink</span>(Loaders<span style=color:#666>::</span>MachO<span style=color:#666>&amp;</span> loader, <span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Symbol<span style=color:#666>&amp;</span> symbol) <span style=color:green;font-weight:700>override</span> {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (symbol.name() <span style=color:#666>==</span> <span style=color:#ba2121>&#34;printf&#34;</span>) {
</span></span><span style=display:flex;background-color:#e5e5e5><span>    <span style=color:green;font-weight:700>return</span> (<span style=color:#b00040>uint64_t</span>)<span style=color:#666>&amp;</span>my_printf;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>With our <code>liblockdown.dylib</code> case, we can naively try to resolve symbols based
on the existing macOS libraries:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#b00040>uint64_t</span> <span style=color:#00f>symlink</span>(Loaders<span style=color:#666>::</span>MachO<span style=color:#666>&amp;</span> loader, <span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Symbol<span style=color:#666>&amp;</span> symbol) <span style=color:green;font-weight:700>override</span> {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>DylibCommand<span style=color:#666>*</span> lib <span style=color:#666>=</span> symbol.library()
</span></span><span style=display:flex><span>  <span style=color:#b00040>void</span><span style=color:#666>*</span> hdl <span style=color:#666>=</span> dlopen(lib<span style=color:#666>-&gt;</span>name().c_str(), <span style=color:#408080;font-style:italic>/*mode=*/</span>RTLD_NOW);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (hdl <span style=color:#666>==</span> <span style=color:green;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>    fprintf(stderr, <span style=color:#ba2121>&#34;Can&#39;t find library %s on the current macOS system</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>,
</span></span><span style=display:flex><span>            lib<span style=color:#666>-&gt;</span>name().c_str());
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#b00040>void</span><span style=color:#666>*</span> addr <span style=color:#666>=</span> dlsym(hdl, symbol.name().c_str());
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (addr <span style=color:#666>==</span> <span style=color:green;font-weight:700>nullptr</span>) {
</span></span><span style=display:flex><span>    fprintf(stderr, <span style=color:#ba2121>&#34;Can&#39;t find &#39;%s&#39; in %s</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>,
</span></span><span style=display:flex><span>            symbol.name().c_str(), lib<span style=color:#666>-&gt;</span>name().c_str());
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> (<span style=color:#b00040>uint64_t</span>)addr;
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>When executing this code, we can observe that the library <code>liblockdown.dylib</code>
from visionOS is <em>binding</em> 395 symbols. From these
395 symbols, only <strong>4 of them fail to be resolved</strong> using macOS library:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Can&#39;t find &#39;__SSLCopyPeerCertificates&#39; in /System/Library/Frameworks/Security.framework/Security
</span></span><span style=display:flex><span>Can&#39;t find &#39;__SSLDisposeContext&#39; in /System/Library/Frameworks/Security.framework/Security
</span></span><span style=display:flex><span>Can&#39;t find &#39;__SSLNewContext&#39; in /System/Library/Frameworks/Security.framework/Security
</span></span><span style=display:flex><span>Can&#39;t find &#39;__SSLSetEnableCertVerify&#39; in /System/Library/Frameworks/Security.framework/Security
</span></span></code></pre></div><p>In other words, <strong>98% of the functions</strong> imported by <code>liblockdown.dylib</code> on the visionOS
are <strong>natively available</strong> on macOS 14.</p><p>The missing symbols could be mocked or emulated but for the sake of simplicity
we just skip them.</p><p>Now that we have a mean to resolve imported symbols pretty well, we can ask QBDL
to get a pointer to the function <code>_lockdown_connect</code>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>FinalTargetSystem</span><span style=color:#666>:</span> <span style=color:green;font-weight:700>public</span> Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetSystem {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>using</span> Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetSystem<span style=color:#666>::</span>TargetSystem;
</span></span><span style=display:flex><span>  <span style=color:#b00040>uint64_t</span> <span style=color:#00f>symlink</span>(Loaders<span style=color:#666>::</span>MachO<span style=color:#666>&amp;</span> loader, <span style=color:green;font-weight:700>const</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Symbol<span style=color:#666>&amp;</span> symbol) <span style=color:green;font-weight:700>override</span> {
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// Logic described previously
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span> <span style=color:#00f>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> mem <span style=color:#666>=</span> std<span style=color:#666>::</span>make_unique<span style=color:#666>&lt;</span>Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>TargetMemory<span style=color:#666>&gt;</span>();
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> system <span style=color:#666>=</span> std<span style=color:#666>::</span>make_unique<span style=color:#666>&lt;</span>FinalTargetSystem<span style=color:#666>&gt;</span>(<span style=color:#666>*</span>mem);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>auto</span> loader <span style=color:#666>=</span> Loaders<span style=color:#666>::</span>MachO<span style=color:#666>::</span>from_file(<span style=color:#ba2121>&#34;./liblockdown.2.dylib&#34;</span>
</span></span><span style=display:flex><span>    Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>arch(), <span style=color:#666>*</span>system, Loader<span style=color:#666>::</span>BIND<span style=color:#666>::</span>NOW
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>  <span style=color:#b00040>uint64_t</span> addr <span style=color:#666>=</span> loader<span style=color:#666>-&gt;</span>get_address(<span style=color:#ba2121>&#34;_lockdown_connect&#34;</span>);
</span></span><span style=display:flex;background-color:#e5e5e5><span>  LK_INFO(<span style=color:#ba2121>&#34;_lockdown_connect: 0x{:016x}&#34;</span>, addr);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>At this point we are in the situation where:</p><ol><li>We extracted <code>/usr/lib/liblockdown.dylib</code> from a visionOS dyld shared cache</li><li>We removed shared cache optimizations and we re-created a <code>LC_DYLD_CHAINED_FIXUPS</code></li><li>We loaded the library with QBDL and most of the imported symbols are resolved</li><li>We have a pointer to the in-macos-memory of <code>_lockdown_connect</code></li></ol><p>Depending on the needs, we could start lldb to debug the function or feed the
function with fuzzing inputs.</p><p>Since I talked about <a href=https://lief.re>LIEF</a> & <a href=https://github.com/quarkslab/QBDL>QBDL</a>,
I can&rsquo;t finish this blog post without mentioning <a href=https://qbdi.quarkslab.com/>QBDI</a>.</p><h2 id=instrumenting-_lockdown_connect-with-qbdi>Instrumenting <code>_lockdown_connect</code> with QBDI</h2><p>First off, we have to instantiate and initialize a QBDI&rsquo;s VM<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> object:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// [...]
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>auto</span> loader <span style=color:#666>=</span> Loaders<span style=color:#666>::</span>MachO<span style=color:#666>::</span>from_file(<span style=color:#ba2121>&#34;./liblockdown.2.dylib&#34;</span>
</span></span><span style=display:flex><span>  Engines<span style=color:#666>::</span>Native<span style=color:#666>::</span>arch(), <span style=color:#666>*</span>system, Loader<span style=color:#666>::</span>BIND<span style=color:#666>::</span>NOW
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>uint64_t</span> lockdown_connect_addr <span style=color:#666>=</span> loader<span style=color:#666>-&gt;</span>get_address(<span style=color:#ba2121>&#34;_lockdown_connect&#34;</span>);
</span></span><span style=display:flex><span>LK_INFO(<span style=color:#ba2121>&#34;_lockdown_connect: 0x{:016x}&#34;</span>, lockdown_connect_addr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>QBDI<span style=color:#666>::</span>VM dbi;
</span></span><span style=display:flex;background-color:#e5e5e5><span>QBDI<span style=color:#666>::</span>GPRState<span style=color:#666>*</span> state <span style=color:#666>=</span> vm.getGPRState();
</span></span><span style=display:flex;background-color:#e5e5e5><span>
</span></span><span style=display:flex;background-color:#e5e5e5><span>state<span style=color:#666>-&gt;</span>pc <span style=color:#666>=</span> lockdown_connect_addr;
</span></span><span style=display:flex;background-color:#e5e5e5><span>
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:#b00040>uint64_t</span> start <span style=color:#666>=</span> loader<span style=color:#666>-&gt;</span>base_address();
</span></span><span style=display:flex;background-color:#e5e5e5><span><span style=color:#b00040>uint64_t</span> end   <span style=color:#666>=</span> start <span style=color:#666>+</span> loader<span style=color:#666>-&gt;</span>get_binary().virtual_size();
</span></span><span style=display:flex;background-color:#e5e5e5><span>vm.addInstrumentedRange(start, end);</span></span></code></pre></div><p>I omitted stack registers initialization (<code>sp</code>, <code>x29</code>) but the previous code is essentially
setting the PC register and scoping the range of virtual addresses we want to instrument.</p><p>After this initialization, we can define what we want to do with the instrumented code. In this example,
we just trace the instructions:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vm.addCodeCB(QBDI<span style=color:#666>::</span>InstPosition<span style=color:#666>::</span>PREINST,
</span></span><span style=display:flex><span>    [] (QBDI<span style=color:#666>::</span>VM<span style=color:#666>*</span> vm, QBDI<span style=color:#666>::</span>GPRState<span style=color:#666>*</span> gpr, QBDI<span style=color:#666>::</span>FPRState<span style=color:#666>*</span>, <span style=color:#b00040>void</span><span style=color:#666>*</span> data) {
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>const</span> QBDI<span style=color:#666>::</span>InstAnalysis<span style=color:#666>*</span> inst <span style=color:#666>=</span> vm<span style=color:#666>-&gt;</span>getInstAnalysis();
</span></span><span style=display:flex><span>      LK_INFO(<span style=color:#ba2121>&#34;0x{:016x}: {}&#34;</span>, inst<span style=color:#666>-&gt;</span>address, inst<span style=color:#666>-&gt;</span>disassembly);
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>return</span> QBDI<span style=color:#666>::</span>VMAction<span style=color:#666>::</span>CONTINUE;
</span></span><span style=display:flex><span>    }, <span style=color:green;font-weight:700>nullptr</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Let&rsquo;s go?</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>vm.run(lockdown_connect_addr, lr);
</span></span></code></pre></div><p>And here we go:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#a0a000>_lockdown_connect</span>: <span style=color:#666>0x00000001039ed024</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed024</span><span style=color:#666>:</span>     pacibsp
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed028</span><span style=color:#666>:</span>     sub sp, sp, <span>#</span><span style=color:#666>208</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed02c</span><span style=color:#666>:</span>     stp x22, x21, [sp, <span>#</span><span style=color:#666>160</span>]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed030</span><span style=color:#666>:</span>     stp x20, x19, [sp, <span>#</span><span style=color:#666>176</span>]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed034</span><span style=color:#666>:</span>     stp x29, x30, [sp, <span>#</span><span style=color:#666>192</span>]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed038</span><span style=color:#666>:</span>     add x29, sp, <span>#</span><span style=color:#666>192</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed03c</span><span style=color:#666>:</span>     adrp    x8, <span>#</span><span style=color:#666>70324224</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed040</span><span style=color:#666>:</span>     ldr x8, [x8, <span>#</span><span style=color:#666>3352</span>]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed044</span><span style=color:#666>:</span>     ldr x8, [x8]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed048</span><span style=color:#666>:</span>     stur    x8, [x29, <span>#</span><span style=color:#666>-</span><span style=color:#666>40</span>]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed04c</span><span style=color:#666>:</span>     mov w21, <span>#</span><span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed050</span><span style=color:#666>:</span>     mov w0, <span>#</span><span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed054</span><span style=color:#666>:</span>     mov w1, <span>#</span><span style=color:#666>1</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed058</span><span style=color:#666>:</span>     mov w2, <span>#</span><span style=color:#666>0</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed05c</span><span style=color:#666>:</span>     bl  <span>#</span><span style=color:#666>10372</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ef8e0</span><span style=color:#666>:</span>     adrp    x17, <span>#</span><span style=color:#666>254316544</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ef8e4</span><span style=color:#666>:</span>     add x17, x17, <span>#</span><span style=color:#666>3176</span>
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ef8e8</span><span style=color:#666>:</span>     ldr x16, [x17]
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ef8ec</span><span style=color:#666>:</span>     braa    x16, x17
</span></span><span style=display:flex><span><span style=color:#666>0x00000001039ed060</span><span style=color:#666>:</span>     cmn w0, <span>#</span><span style=color:#666>1</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Given this instruction-level granularity, we could also intercept syscall instructions.</p><p>I won&rsquo;t advocate any longer about how powerful QBDI is, but for those who are interested in more details
you can check these posts/publications:</p><ul><li><a href=https://www.romainthomas.fr/post/android-native-library-analysis-with-qbdi/>Android Native Library Analysis with QBDI</a></li><li><a href=https://www.romainthomas.fr/publication/20-bh-asia-dbi/>Dynamic Binary Instrumentation Techniques to Address Native Code Obfuscation</a></li><li><a href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part1/>r2-pay - part 1</a> & <a href=https://www.romainthomas.fr/post/20-09-r2con-obfuscated-whitebox-part2/>r2-pay - part 2</a></li></ul><h2 id=closing-words>Closing Words</h2><p>This blog post demonstrates that it is possible to extract a library from a
visionOS dyld shared cache that can be instrumented on a different platform.</p><p>While the same approach would also work for an iOS dyld shared cache, I thought
it would be more challenging to tackle a recent device that lacks the same
knowledge base as iOS.</p><p>Back in January 2024, dfsec also did a publication about
running an iOS binary on macOS: <a href=https://www.df-f.com/blog/macosandiosmerge>Will macOS and iOS merge?</a>
Both approaches are complementary and I recommend reading their blog post.</p><p>For those who seek more details about QBDL/QBDI and a live demo of the instrumentation,
I recorded this video where I detail more aspects about QBDL loading and QBDI instrumentation:</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" loading=eager referrerpolicy=strict-origin-when-cross-origin src="https://www.youtube.com/embed/5L05OE5mL2o?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 title="YouTube video"></iframe></div><p>Finally, the source code of the PoC is on GitHub at this address:
<a href=https://github.com/romainthomas/visionOS-liblockdown><i class="fab fa-github"></i> romainthomas/visionOS-liblockdown</a></p><p>The dyld shared cache support in LIEF is still in progress but you can join <a href=https://discord.com/invite/7hRFGWYedu><i class="fab fa-discord"></i> LIEF&rsquo;s Discord
channel</a> to be notified when this will be released.</p><p>Thank you for reading,</p><p>Romain</p><h3 id=references>References</h3><ul><li><a href=https://www.nowsecure.com/blog/2024/09/11/reversing-ios-system-libraries-using-radare2-a-deep-dive-into-dyld-cache-part-1/>https://www.nowsecure.com/blog/2024/09/11/reversing-ios-system-libraries-using-radare2-a-deep-dive-into-dyld-cache-part-1/</a></li><li><a href=https://worthdoingbadly.com/dscextract/>https://worthdoingbadly.com/dscextract/</a></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Behavior emulation, not code emulation&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>The term VM can be confusing but are still talking about dynamic binary
instrumentation like Intel PIN not emulation:)&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script><script src=/vendor/headroom.js/dist/headroom.min.js></script><script src=/vendor/onscreen/dist/on-screen.umd.min.js></script><script src=/vendor/jarallax/dist/jarallax.min.js></script><script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script><script src=/js/theme.bundle.js></script><script src=/vendor/@glidejs/glide/dist/glide.min.js></script><script src=/js/anime.min.js></script><script src=/vendor/img-comparison-slider/dist/index.js></script></body></html>