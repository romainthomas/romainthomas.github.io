<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="This blog post analyzes the Frida and Jailbreak detection in PokemonGO for iOS."><meta name=keywords content="iOS,reverse engineering,obfuscation"><meta property="og:type" content="article"><meta property="og:description" content="This blog post analyzes the Frida and Jailbreak detection in PokemonGO for iOS."><meta property="og:title" content="Gotta Catch 'Em All: Frida & jailbreak detection | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-07-18T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content="iOS"><meta property="article:tag" content="reverse engineering"><meta property="article:tag" content="obfuscation"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="Gotta Catch 'Em All: Frida & jailbreak detection | Romain Thomas"><meta name=twitter:description content="This blog post analyzes the Frida and Jailbreak detection in PokemonGO for iOS."><meta name=twitter:domain content="https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/post/21-07-pokemongo-anti-frida-jailbreak-bypass/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4><a href=/categories/ios/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">iOS</span>
</a><a href=/categories/reverse-engineering/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Reverse Engineering</span></a></div><h1 class="display-3 mb-4 px-lg-5">Gotta Catch 'Em All: Frida & jailbreak detection</h1><div class=post-meta><span class="fw-bold me-3">Romain Thomas</span>
<span class="post-date me-3">July 18, 2021</span>
<span class=fw-bold>13 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/21-07-pokemongo-anti-frida-jailbreak-bypass/featured.png class="rounded img-fluid" alt=featured.png></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><style>.green{color:green;font-family:fira code,monospace;font-size:87.5%}.blue{color:blue;font-family:fira code,monospace;font-size:87.5%}.orange{color:tomato;font-family:fira code,monospace;font-size:87.5%}.red{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-comment{color:#df2b04;font-family:fira code,monospace;font-size:87.5%}.hl-keyword{color:#a90d91;font-family:fira code,monospace;font-size:87.5%}.hl-literal{color:#1c01ce;font-family:fira code,monospace;font-size:87.5%}.hl-preproc{color:#633820;font-family:fira code,monospace;font-size:87.5%}.hl-strings{color:#c41a16;font-family:fira code,monospace;font-size:87.5%}.yellow{color:#cc7000;font-family:fira code,monospace;font-size:87.5%}</style><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=border:none!important;background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fas fa-circle-info" style=color:#084298></span></div></div><div class=ps-4 style=color:#084298><h3 class="h5 m-0 mb-1" style=color:#084298>Note</h3>Do not expect a <em>click & play</em> solution for PokemonGO in this blog post. This blog post is more about
the technical aspects of jailbreak detection than a bypass for this game.</div></div></div></div><h2 id=introduction>Introduction</h2><p>While working on LIEF during my vacations to support in-memory parsing for Mach-O files, I found that
PokemonGO was an interesting use case to introduce this feature. It led me to look at the jailbreak
and Frida detection implemented in this game.
Being more familiar with Android than iOS, the analysis workflow on this platform is quite different, which
is also a good opportunity to improve tooling.</p><p>The first challenge stems from jailbreaking the device. Fortunately, checkra1n eases this step.
The second difficulty lies in extracting the encrypted iOS app from the device. In contrast to Android,
iOS apps are encrypted on the disk and decrypted by the kernel when loaded. It means that one way to get
the unencrypted code is to dump the file from memory. One could also leverage the function <code>mremap_encrypted()</code>
as described in <a href=https://www.linkedin.com/pulse/decrypting-apps-ios-john-coates/>Decrypting Apps on iOS</a>.</p><h2 id=pokemongo-overview>PokemonGO Overview</h2><p>When running PokemonGO on a jailbroken device<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, the application immediately crashes with the following backtrace:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0   ???             0x000000020ac46ab8 0 + 8770579128
</span></span><span style=display:flex><span>1   libdyld.dylib   0x0000000184df8304 invocation function for block in dyld3::AllImages::runAllInitializersInImage(dyld3::closure::Image const*, dyld3::MachOLoaded const*) + 136
</span></span><span style=display:flex><span>2   libdyld.dylib   0x0000000184dea5b0 dyld3::closure::Image::forEachInitializer(void const*, void (void const*) block_pointer) const + 96
</span></span><span style=display:flex><span>3   libdyld.dylib   0x0000000184df8160 invocation function for block in dyld3::AllImages::runInitialzersBottomUp(dyld3::closure::Image const*) + 296
</span></span><span style=display:flex><span>4   libdyld.dylib   0x0000000184deae6c dyld3::closure::Image::forEachImageToInitBefore(void (unsigned int, bool&amp;) block_pointer) const + 92
</span></span><span style=display:flex><span>5   libdyld.dylib   0x0000000184df8b48 dyld3::AllImages::loadImage(Diagnostics&amp;, char const*, unsigned int, dyld3::closure::DlopenClosure const*, bool, bool, bool, bool, void const*) + 776
</span></span><span style=display:flex><span>6   libdyld.dylib   0x0000000184df8698 dyld3::AllImages::dlopen(Diagnostics&amp;, char const*, bool, bool, bool, bool, bool, void const*, bool) + 872
</span></span><span style=display:flex><span>7   libdyld.dylib   0x0000000184dfa2b4 dyld3::dlopen_internal(char const*, int, void*) + 368
</span></span><span style=display:flex><span>8   libdyld.dylib   0x0000000184ded5b0 dlopen_internal(char const*, int, void*) + 108
</span></span><span style=display:flex><span>9   CoreFoundation  0x00000001850ed038 _CFBundleDlfcnLoadFramework + 136
</span></span><span style=display:flex><span>10  CoreFoundation  0x00000001850be974 _CFBundleLoadExecutableAndReturnError + 376
</span></span><span style=display:flex><span>11  Foundation      0x0000000186359ba8 -[NSBundle loadAndReturnError:] + 332
</span></span><span style=display:flex><span>12  pokemongo       0x00000001041a7c5c 0x1041a0000 + 31836
</span></span><span style=display:flex><span>13  pokemongo       0x00000001041a7d50 0x1041a0000 + 32080
</span></span><span style=display:flex><span>14  libdyld.dylib   0x0000000184de9588 start + 4
</span></span></code></pre></div><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff>The full crash log is available <a href=backtrace.log>here</a>.</div><p>In this backtrace, the main <code>pokemongo</code> binary is a kind of <em>stub</em> that loads the Unity binary: <code>UnityFramework</code> which
contains the main logic of the game.</p><p>This library is loaded by the <code>dlopen_internal</code> function at index <strong>8</strong> in the backtrace as a
result of <code>-[NSBundle loadAndReturnError:]</code>.
Since <code>UnityFramework</code> depends on other libraries, they are (pre)loaded with <code>Image::forEachImageToInitBefore</code>
which processes the following files:</p><ol><li><span class=yellow>@/usr/lib/libc++.1.dylib</span></li><li>&mldr;</li><li><span class=blue>@rpath/NianticLabsPlugin.framework/NianticLabsPlugin</span></li><li>&mldr;</li><li><span class=yellow>@rpath/libswiftos.dylib</span></li></ol><p>Among those dependencies, we can notice the <span class=blue>NianticLabsPlugin</span> library which is a cross-platform
Unity plugin &ndash; also present in the Android version &ndash; that contains the main protections of the game.
These protections are used to prevent cheat, bots, GPS spoofing, in PokemonGO. The whole
being obfuscated by Digital.ai (formerly known as Arxan). <span class=blue>NianticLabsPlugin</span> communicates with the <code>UnityFramework</code> through
an exported function <code>GetN2Api</code> that returns an array of functions (pointers).</p><p>The following figure outlines these different components:</p><p><img src=overview.png alt="PokemonGO overview"></p><p>Getting back to the backtrace, if we assume that the application crashes when loading <span class=blue>NianticLabsPlugin</span>,
it precisely crashes when calling the Mach-O constructors in <code>AllImages::runAllInitializersInImage</code>.
Since the application is heavily obfuscated, a static analysis reaches quickly its limits, which forces us
to emulate or dynamically analyze the functions of interest.</p><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=border:none!important;background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fas fa-circle-info" style=color:#084298></span></div></div><div class=ps-4 style=color:#084298><h3 class="h5 m-0 mb-1" style=color:#084298>Note</h3><p>The addresses of the functions/instructions mentioned in this blog post are based on the following version of NianticLabsPlugin:</p><p><i class="fas fa-shield-alt"></i> <a href=NianticLabsPlugin.bin>NianticLabsPlugin - 2140426ccdfdfb2529f454697cb5cc83</a></p><p><i class="fas fa-code-branch"></i> PokemonGO v0.211.2 - June 2021</p></div></div></div></div><h2 id=analyzing-mach-o-constructors-with-frida>Analyzing Mach-O constructors with Frida</h2><p>From the previous section, we surmised that the application crashed because of the <span class=blue>NianticLabsPlugin</span>&rsquo;s constructors.
Since these functions are called before <strong>any other functions</strong> of the library, it raises the question of finding
a way to perform actions (or hook) before they are executed.</p><p>On Android, when we need to analyse a library&rsquo;s constructors, we can hook the <code>call_array</code> function from
<a href=https://github.com/aosp-mirror/platform_bionic/blob/c44b1d0676ded732df4b3b21c5f798eacae93228/linker/linker_soinfo.cpp#L488>Bionic&rsquo;s linker (ELF loader)</a>:</p><script src=https://gist.github.com/romainthomas/c10298387a921df730c1556c2ee9cecb.js></script><p>If we try to apply the same approach on iOS, the mirror of the ELF loader on iOS is <code>dyld</code> which contains
most of the logic to load Mach-O files.
It turns out that at some points, the Mach-O&rsquo;s constructors are processed in the <code>doModInitFunctions</code> function
(from <a href=https://github.com/apple-opensource/dyld/blob/1128192c016372ae94793d88530bc5978c1fce93/src/ImageLoaderMachO.cpp#L2290>ImageLoaderMachO.cpp</a>).</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#b00040>void</span> ImageLoaderMachO<span style=color:#666>::</span>doModInitFunctions(<span style=color:green;font-weight:700>const</span> LinkContext<span style=color:#666>&amp;</span> context) {
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>for</span> (<span style=color:green;font-weight:700>const</span> <span style=color:green;font-weight:700>struct</span> <span style=color:#00f;font-weight:700>macho_section</span><span style=color:#666>*</span> sect<span style=color:#666>=</span>sectionsStart; sect <span style=color:#666>&lt;</span> sectionsEnd; <span style=color:#666>++</span>sect) {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>uint8_t</span> type <span style=color:#666>=</span> sect<span style=color:#666>-&gt;</span>flags <span style=color:#666>&amp;</span> SECTION_TYPE;
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> ( type <span style=color:#666>==</span> S_MOD_INIT_FUNC_POINTERS ) {
</span></span><span style=display:flex><span>      Initializer<span style=color:#666>*</span> inits <span style=color:#666>=</span> (Initializer<span style=color:#666>*</span>)(sect<span style=color:#666>-&gt;</span>addr <span style=color:#666>+</span> fSlide);
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      <span style=color:green;font-weight:700>if</span> (<span style=color:#666>!</span><span style=color:green;font-weight:700>this</span><span style=color:#666>-&gt;</span>containsAddress(stripPointer((<span style=color:#b00040>void</span><span style=color:#666>*</span>)func)) ) {
</span></span><span style=display:flex><span>        dyld<span style=color:#666>::</span>throwf(<span style=color:#ba2121>&#34;initializer function %p not in mapped image for %s</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#ba2121>&#34;</span>, func, <span style=color:green;font-weight:700>this</span><span style=color:#666>-&gt;</span>getPath());
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      func(context.argc, context.argv, context.envp, context.apple, <span style=color:#666>&amp;</span>context.programVars);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From this code, we can notice that <strong>all</strong> constructor addresses are checked <strong>beforehand</strong> by the
<code>containsAddress</code> function. Therefore, it makes this function a good hooking spot as it is executed before
calling the constructor itself. One can use the native SDK of <a href=https://github.com/frida/frida-gum>frida-gum</a>
to perform this action:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// Address of ImageLoader::containsAddress in /usr/lib/dyld
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>const</span> uintptr_t containsAddress_ptr <span style=color:#666>=</span> ...;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// Setup hooks with gum_interceptor_attach
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>GumAttachReturn attach_ret <span style=color:#666>=</span> gum_interceptor_attach(
</span></span><span style=display:flex><span>    listener_<span style=color:#666>-&gt;</span>interceptor,
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* target */</span> <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span><span style=color:#b00040>void</span><span style=color:#666>*&gt;</span>(containsAddress_ptr),
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span>GumInvocationListener<span style=color:#666>*&gt;</span>(listener_),
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* ID */</span> <span style=color:green;font-weight:700>reinterpret_cast</span><span style=color:#666>&lt;</span><span style=color:#b00040>void</span><span style=color:#666>*&gt;</span>(containsAddress_ptr)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>....
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>// Equivalent of onEnter in Javascript
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>void</span> native_listener_on_enter(GumInvocationListener<span style=color:#666>*</span> listener, GumInvocationContext<span style=color:#666>*</span> ic) {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> uintptr_t ctor_function_addr <span style=color:#666>=</span> ic<span style=color:#666>-&gt;</span>cpu_context<span style=color:#666>-&gt;</span>x[<span style=color:#666>1</span>];
</span></span><span style=display:flex><span>  <span style=color:#408080;font-style:italic>// Do stuff with ctor_function_addr
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}
</span></span></code></pre></div><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff><code>containsAddress</code> is a member function, therefore <code>x0</code> contains a pointer on <code>this</code> and the address
to check is located in <code>x1</code>.</div><p>By hooking <code>containsAddress()</code>, we get the <strong>control before</strong> the execution of the constructors.
It gives us the ability to perform the following actions that can help to identify the constructor involved in the crash:</p><ol><li>Trace the constructors (see: <a href=constructors_trace.log>constructors_trace.log</a>)</li><li>Replace/disable a constructor (<code>gum_interceptor_replace</code>)</li><li>Detect the <strong>first</strong> constructor and hook the next ones (<code>gum_interceptor_attach</code>)</li></ol><p><span class=blue>NianticLabsPlugin</span> embeds no less than 120 constructors
among those, 6<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> are involved in detecting Frida, jailbroken devices, anti-debug, etc:</p><table><thead><tr><th>Index</th><th>Offset</th><th>Description</th></tr></thead><tbody><tr><td>15</td><td>0x4369e0</td><td>Anti-debug & anti-emulation</td></tr><tr><td>16</td><td>0x00e0d8</td><td>Frida detection</td></tr><tr><td>17</td><td>0x26bd5c</td><td>Anti-bypass?</td></tr><tr><td>18</td><td>0x449b84</td><td>Anti-jailbreak, anti-Frida</td></tr><tr><td>19</td><td>0x731b90</td><td>Anti-jailbreak, anti-debug, anti-frida</td></tr><tr><td>20</td><td>0x359194</td><td>Anti-jailbreak</td></tr></tbody></table><p>Once we reduced the set of functions involved in the crash, we can combine dynamic analysis with Frida
and emulation with Unicorn.</p><h2 id=anti-debug>Anti-debug</h2><p>One of the redundant checks we can find in many functions (not only the constructors) are the
anti-debugs. They always come in two parts:</p><ol><li>Try to <em>&ldquo;kill&rdquo;</em> its own pid with the 0-signal</li><li>Check if PTRACE is flagged</li></ol><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>try_kill</span>() {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>int</span> pid <span style=color:#666>=</span> getpid(); <span style=color:#408080;font-style:italic>// syscall@0x436cdc
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  <span style=color:#b00040>int</span> ret <span style=color:#666>=</span> kill(pid, <span style=color:#666>0</span>);   <span style=color:#408080;font-style:italic>// syscall@0x436d28
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}
</span></span></code></pre></div><p>According to the man page of kill (<code>man 2 kill</code>), the signal <code>0</code> is used to check
that the <code>pid</code> given in the first parameter really exists.</p><blockquote><p>[&mldr;] A value of 0, however, will cause error checking to be performed (with no signal being sent). This can be used
to check the validity of pid.</p></blockquote><p>This <em>kill</em> operation is followed by three <code>PTRACE</code> checks:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// Done three times
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>inline</span> <span style=color:#b00040>bool</span> <span style=color:#00f>ptrace_detect</span>() {
</span></span><span style=display:flex><span>  <span style=color:#b00040>int32_t</span> opt[<span style=color:#666>4</span>] <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    CTL_KERN,
</span></span><span style=display:flex><span>    KERN_PROC,
</span></span><span style=display:flex><span>    KERN_PROC_PID,
</span></span><span style=display:flex><span>    getpid(),
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  kinfo_proc info;
</span></span><span style=display:flex><span>  sysctl(opt, <span style=color:#666>4</span>, <span style=color:#666>&amp;</span>info, <span style=color:green;font-weight:700>sizeof</span>(kinfo_proc), <span style=color:green;font-weight:700>nullptr</span>, <span style=color:#666>0</span>);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> info.kp_proc.p_flag <span style=color:#666>&amp;</span> P_TRACED;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>These three <code>P_TRACED</code> checks <strong>always</strong> come together:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x436cdc: getpid(): 6015
</span></span><span style=display:flex><span>0x436d28: kill(6015, 0): 0
</span></span><span style=display:flex><span>0x4374b0: sysctl(CTL_KERN, KERN_PROC, KERN_PROC_PID, 6015)
</span></span><span style=display:flex><span>0x4371e8: sysctl(CTL_KERN, KERN_PROC, KERN_PROC_PID, 6015)
</span></span><span style=display:flex><span>0x437398: sysctl(CTL_KERN, KERN_PROC, KERN_PROC_PID, 6015)
</span></span></code></pre></div><h2 id=frida-detection>Frida Detection</h2><p>Frida is detected by the application through its client-server mode, which binds the localhost on the port <code>27042</code>.
When PokemonGO is starting, it tries to open a socket on this port and if it manages to connect, it tests the Frida handshake.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x00e3b8: getifaddrs(0x16b7fb518): 0x0
</span></span><span style=display:flex><span>0x016990: socket(&#39;IPV4&#39;, &#39;TCP&#39;, &#39;0&#39;): 0x8
</span></span><span style=display:flex><span>0x019d60: bind(&#39;PF_INET&#39;, 0x8, &#39;127.0.0.1:27042&#39;)
</span></span><span style=display:flex><span>0x01805c: close(0x8)
</span></span><span style=display:flex><span>0x016990: socket(&#39;IPV4&#39;, &#39;TCP&#39;, &#39;0&#39;): 0x8
</span></span><span style=display:flex><span>0x019d60: bind(&#39;PF_INET&#39;, 0x8, &#39;192.168.0.26:27042&#39;)
</span></span><span style=display:flex><span>0x01805c: close(0x8)
</span></span><span style=display:flex><span>0x00e3ec: freeifaddrs(0x10601ac00): 0x105360a00
</span></span></code></pre></div><p>The application also iterates over the list of the libraries loaded in memory with the
<code>_dyld_image_count</code>/<code>_dyld_get_image_name</code> functions. Nevertheless, it seems that they are not used to detect
Frida libraries artifacts (like <code>FridaGadget.dylib</code>).</p><h2 id=jailbreak-detection>Jailbreak Detection</h2><p>The application implements jailbreak detection by checking if some files are accessible or not on the device.
Most of the checks are done by using the <code>access()</code> syscalls that are inlined in different places:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x44c390: access(&#39;/bin/grep&#39;, 0x0)
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>0x7326b0: access(&#39;/private/var/checkra1n.dmg&#39;, 0x0)
</span></span></code></pre></div><p>The list of the checked files is given in the <a href=#annexes>annexes of the blog post</a>.</p><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff>This list is very close to <a href=https://github.com/XsF1re/vnodebypass/blob/870b21fd3566736cca285355b4faf7f289baa4d5/layout/usr/share/vnodebypass/hidePathList.plist>vnodebypass/hidePathList.plist</a></div><p>In addition to <em>raw</em> <code>access</code> syscall, the application enhances its detection by creating a symbolic link of the
root directory in a temporary app data directory:</p><pre tabindex=0><code>0x734e08: symlink(&#39;/Applications/..&#39;, &#39;/private/var/mobile/Containers/Data/Application/D933FBC9-90E7-4584-851E-CE2D5E900446/tmp/WCH38bnM0x101a9e7d0&#39;)
</code></pre><p>Then, it performs the same checks with the app data directory as prefix: <code>[...]/tmp/WCH38bnM0x101a9e7d0</code>:</p><pre tabindex=0><code>0x7376d8: access(&#39;/private/var/mobile/Containers/Data/Application/D933FBC9-90E7-4584-851E-CE2D5E900446/tmp/3Odis0x101a9dfd0/usr/bin/passwd&#39;, 0x0)
</code></pre><h2 id=signature-check>Signature Check</h2><p>At some point, one function checks the integrity of the signature of the <code>pokemongo</code> binary.
This check starts by opening the main <code>pokemongo</code> binary from <strong>the disk</strong>:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x7392ec: add  x0, x19, #6,lsl#12
</span></span><span style=display:flex><span>0x7392f0: add  x0, x0, #0x540
</span></span><span style=display:flex><span>0x7392f4: mov  w1, #0x1000000
</span></span><span style=display:flex><span>0x7392f8: mov  x2, #0
</span></span><span style=display:flex><span>0x7392fc: svc  0x80               ; x16 -&gt; SYS_open = 5
</span></span><span style=display:flex><span>// open(&#39;/private/var/containers/Bundle/Application/[...]/pokemongo.app/pokemongo&#39;): fd_pgo
</span></span></code></pre></div><p>Then, it reads the beginning of the file in a stack buffer:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>0x74b494: ldr  x0, [x19, #0xc0]  ; fd
</span></span><span style=display:flex><span>0x74b498: ldr  x1, [x19, #0x130] ; buff
</span></span><span style=display:flex><span>0x74b49c: ldr  x2, [x19, #0xb8]  ; buff_size
</span></span><span style=display:flex><span>0x74b4a0: svc  0x80              ; x16 -&gt; SYS_read = 3
</span></span><span style=display:flex><span>// uint8_t macho_head[0x4167];
</span></span><span style=display:flex><span>// 0x74b4a0: read(fd_pgo, macho_header, 0x4167);
</span></span></code></pre></div><p>to iterate over the Mach-O load commands:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>; x8 points to the read&#39;s buffer
</span></span><span style=display:flex><span>0x73942c: ldr w8, [x8, #0x10]  ; Number of LC_COMMANDS
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for (size_t i = 0; i &lt; nb_cmds; ++i) {
</span></span><span style=display:flex><span>  0x74bc40: ldr w10, [x9, #4] ; Command&#39;s size
</span></span><span style=display:flex><span>  0x74ade4: ldr w9,  [x9]     ; command&#39;s type
</span></span><span style=display:flex><span>  if (cmd.type == LC_CODE_SIGNATURE) {
</span></span><span style=display:flex><span>    0x74b1b8: ldr w10, [x10, #8]  ; read signature offset -&gt; 0xc3d0
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With the offset of the Mach-O <code>LC_CODE_SIGNATURE</code> command, it reads the raw signature using the
<code>lseek/read</code> syscalls:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>uint8_t sig_header[0x205];
</span></span><span style=display:flex><span>0x73a978: lseek(fd_pgo, LC_CODE_SIGNATURE offset, 0x0)
</span></span><span style=display:flex><span>0x73aecc: read(fd_pgo, &amp;sig_header, 0x205);
</span></span></code></pre></div><p>The raw signature buffer is processed by chunks of 10 bytes in
a function that looks like a checksum:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>[...]
</span></span><span style=display:flex><span>0x73ad58:  ldrsb w13, [x12]
</span></span><span style=display:flex><span>0x73ad5c:  mov w14, #83
</span></span><span style=display:flex><span>0x73ad60:  sub w13, w14, w13
</span></span><span style=display:flex><span>0x73ad64:  ldrsb w14, [x12, #1]
</span></span><span style=display:flex><span>0x73ad68:  mov w15, #87
</span></span><span style=display:flex><span>0x73ad6c:  sub w14, w15, w14
</span></span><span style=display:flex><span>0x73ad70:  ldrsb w16, [x12, #2]
</span></span><span style=display:flex><span>0x73ad74:  mov w17, #53
</span></span><span style=display:flex><span>0x73ad78:  sub w16, w17, w16
</span></span><span style=display:flex><span>0x73ad7c:  ldrsb w17, [x12, #3]
</span></span><span style=display:flex><span>0x73ad80:  mov w0, #52
</span></span><span style=display:flex><span>0x73ad84:  sub w17, w0, w17
</span></span><span style=display:flex><span>0x73ad88:  ldrsb w0, [x12, #4]
</span></span><span style=display:flex><span>0x73ad8c:  sub w0, w15, w0
</span></span><span style=display:flex><span>0x73ad90:  ldrsb w1, [x12, #5]
</span></span><span style=display:flex><span>0x73ad94:  mov w2, #51
</span></span><span style=display:flex><span>0x73ad98:  sub w1, w2, w1
</span></span><span style=display:flex><span>0x73ad9c:  ldrsb w2, [x12, #6]
</span></span><span style=display:flex><span>0x73ada0:  mov w3, #54
</span></span><span style=display:flex><span>0x73ada4:  sub w2, w3, w2
</span></span><span style=display:flex><span>0x73ada8:  ldrsb w3, [x12, #7]
</span></span><span style=display:flex><span>0x73adac:  sub w15, w15, w3
</span></span><span style=display:flex><span>0x73adb0:  ldrsb w3, [x12, #8]
</span></span><span style=display:flex><span>0x73adb4:  mov w4, #78
</span></span><span style=display:flex><span>0x73adb8:  sub w3, w4, w3
</span></span><span style=display:flex><span>0x73adbc:  ldrsb w12, [x12, #9]
</span></span><span style=display:flex><span>0x73adc0:  mov w4, #70
</span></span><span style=display:flex><span>0x73adc4:  sub w4, w4, w12
</span></span><span style=display:flex><span>[...]
</span></span></code></pre></div><p>I did not manage to identify the underlying checksum algorithm, but it involves square multiplications and
the key(?): <code>SW5436NF</code></p><h2 id=control-fault-injection>Control-Fault Injection</h2><p>Once we determined the functions involved in the detections, we might want to disable them in order to
run the game smoothly.
Actually, PokemonGO is protected against such bypass with global variables that assert if a function
ran successfully or not.</p><p>This protection is equivalent to the following piece of code:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>constexpr</span> uintptr_t GOOD <span style=color:#666>=</span> <span style=color:#666>0x00627178</span>; <span style=color:#408080;font-style:italic>// bqx ?
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>static</span> uintptr_t MAGIC_CFI <span style=color:#666>=</span> <span style=color:#666>0xdeadc0de</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__attribute__((constructor))
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> frida_detect() {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (is_frida_running()) {
</span></span><span style=display:flex><span>    crash();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  MAGIC_CFI <span style=color:#666>=</span> GOOD;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__attribute__((constructor))
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> control_fault_check() {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (MAGIC_CFI <span style=color:#666>!=</span> GOOD) {
</span></span><span style=display:flex><span>    crash();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we only disable <code>frida_detect()</code>, the application will crash because of <code>control_fault_check()</code>.</p><p>We could bypass this protection by identifying the address of the
<code>MAGIC_CFI</code> in the <code>__data</code> section, or by disabling the <code>control_fault_check()</code>.</p><h2 id=what-about-lief>What about LIEF?</h2><p>As mentioned in the introduction, it started with an ongoing feature to parse Mach-O files from memory.
Basically, LIEF will<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> enable to parse Mach-O files<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> from an absolute address with this kind of API:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// 0x10234400 -&gt; start of the Mach-O file
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>auto</span> bin <span style=color:#666>=</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Parser<span style=color:#666>::</span>parse_from_memory(<span style=color:#666>0x10234400</span>);
</span></span></code></pre></div><p>Depending on the user&rsquo;s needs, the <code>write()</code> operation will optionally undo all the relocations and the symbol bindings.
This could be useful if we aim at (re)running the file dumped (on a Apple M1?).</p><p>As expected, the strings used within the <span class=blue>NianticLabsPlugin</span> library are encoded
by the obfuscator. We could statically analyze the decoding routine (cf. Tim Blazytko&rsquo;s <a href=https://synthesis.to/2021/06/30/automating_string_decryption.html>blog post</a>)
,but another technique consists in using a property of the obfuscator&rsquo;s string encoding mechanism.</p><p>It seems that the obfuscator put <strong>all</strong> the strings<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> in the data section and decrypts <strong>all of them</strong>
in a <strong>single</strong> constructor function.</p><p>For instance, if we have the string &ldquo;TOKEN&rdquo; to protect in the following functions:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>protect_me</span>() {
</span></span><span style=display:flex><span>  sensitive(<span style=color:#ba2121>&#34;TOKEN&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>protect_me_2</span>() {
</span></span><span style=display:flex><span>  sensitive(<span style=color:#ba2121>&#34;TOKEN2&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The obfuscator transforms and decodes the strings into something like:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// __data section
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:green;font-weight:700>static</span> <span style=color:#b00040>char</span> var_TOKEN[]   <span style=color:#666>=</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\x00\x1D\xDD\xEE\xAB</span><span style=color:#ba2121>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>static</span> <span style=color:#b00040>char</span> var_TOKEN_2[] <span style=color:#666>=</span> <span style=color:#ba2121>&#34;</span><span style=color:#b62;font-weight:700>\x00\x1D\xDD\xEE\xAF</span><span style=color:#ba2121>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__attribute__((constructor))
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> decode_strings() {
</span></span><span style=display:flex><span>  decode(var_TOKEN);
</span></span><span style=display:flex><span>  decode(var_TOKEN_2);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>protect_me</span>() {
</span></span><span style=display:flex><span>  sensitive(var_TOKEN);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span> <span style=color:#00f>protect_me_2</span>() {
</span></span><span style=display:flex><span>  sensitive(var_TOKEN_2);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Since <strong>all</strong> the strings are decoded at once in one of the first constructors, if we manage to dump the binary
right after this constructor,
we can recover the original strings for free.</p><p>Programmatically, it can be done using (again) frida-gum SDK with the following pseudocode:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#408080;font-style:italic>// Hook associated with ImageLoader::containsAddress
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span><span style=color:#b00040>void</span> <span style=color:#00f>native_listener_on_enter</span>(GumInvocationListener<span style=color:#666>*</span> listener,
</span></span><span style=display:flex><span>                              GumInvocationContext<span style=color:#666>*</span> ic) {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>static</span> size_t CTOR_ID <span style=color:#666>=</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> uintptr_t ctor_function_addr <span style=color:#666>=</span> ic<span style=color:#666>-&gt;</span>cpu_context<span style=color:#666>-&gt;</span>x[<span style=color:#666>1</span>];
</span></span><span style=display:flex><span>  std<span style=color:#666>::</span>string libname <span style=color:#666>=</span> module_from_addr(ctor_function_addr);
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>if</span> (libname <span style=color:#666>==</span> <span style=color:#ba2121>&#34;NianticLabsPlugin&#34;</span> <span style=color:#666>&amp;&amp;</span> CTOR_ID<span style=color:#666>++</span> <span style=color:#666>==</span> <span style=color:#666>3</span>) {
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>const</span> uintptr_t base_address <span style=color:#666>=</span> base_addr_from_ptr(ctor_function_addr);
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>auto</span> bin <span style=color:#666>=</span> LIEF<span style=color:#666>::</span>MachO<span style=color:#666>::</span>Parser<span style=color:#666>::</span>parse_from_memory(base_address);
</span></span><span style=display:flex><span>    bin<span style=color:#666>-&gt;</span>write(<span style=color:#ba2121>&#34;/tmp/pokemongo_after_ctor.bin&#34;</span>); <span style=color:#408080;font-style:italic>// /tmp on the iPhone
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the end, the dumped file contains the decoded strings:</p><p><img src=strings.png alt="Data area after LIEF dump"></p><p>If we skim the <code>__data</code> section, we can also observe the following changes:</p><p><img src=data_dump.png alt="Data area after LIEF dump"></p><p>A practiced eye might notice<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup> that some strings of the section are actually
embedded in protobuf structures. We can confirm this observation by trying to infer the data as protobuf
types:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>from</span> <span style=color:#00f;font-weight:700>.</span> <span style=color:green;font-weight:700>import</span> proto_dump
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>import</span> <span style=color:#00f;font-weight:700>lief</span>
</span></span><span style=display:flex><span>pgo <span style=color:#666>=</span> lief<span style=color:#666>.</span>parse(<span style=color:#ba2121>&#34;pokemongo_after_ctor.bin&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start <span style=color:#666>=</span> <span style=color:#666>0x12A51A7</span>
</span></span><span style=display:flex><span>end   <span style=color:#666>=</span> <span style=color:#666>0x12A51E2</span>
</span></span><span style=display:flex><span>raw_proto <span style=color:#666>=</span> pgo<span style=color:#666>.</span>get_content_from_virtual_address(start, end <span style=color:#666>-</span> start)
</span></span><span style=display:flex><span><span style=color:green>print</span>(proto_dump(raw_proto))
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>{
</span></span><span style=display:flex><span>  #3 = 4
</span></span><span style=display:flex><span>  #4 (repeated) = 1 {
</span></span><span style=display:flex><span>    #1 = &#34;CheatReputation&#34;
</span></span><span style=display:flex><span>    #2 (repeated) = {
</span></span><span style=display:flex><span>      #1 = &#34;UNSET&#34;
</span></span><span style=display:flex><span>      #2 = 0
</span></span><span style=display:flex><span>    } {
</span></span><span style=display:flex><span>      #1 = &#34;BOT&#34;
</span></span><span style=display:flex><span>      #2 = 1
</span></span><span style=display:flex><span>    } {
</span></span><span style=display:flex><span>      #1 = &#34;SPOOFER&#34;
</span></span><span style=display:flex><span>      #2 = 2
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  #5 = 8
</span></span><span style=display:flex><span>  #8 = []
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=final-words>Final Words</h2><p>The application embeds other checks in the constructors and in the functions returned by <code>GetN2Api</code>. It can
make a good exercise for those that are interested in.</p><p>Generally speaking, the application and the protections are well designed since they slow down reverse engineers.
Nevertheless, <code>anti-{jb, frida, debug}</code> are quite difficult to protect as they need to interact with the OS
through functions or syscalls with unprotected parameters. As a result, and once identified, we can bypass them.</p><p>One technique consists in injecting a library with Frida&rsquo;s injector that aims at hooking
the <code>containsAddress()</code> to disable/patch the functions involved in the detections:</p><p><img src=jbfree.png alt="PokemonGo Jailbreak bypass"></p><video class=mb-4 controls>
<source src=pokemongo_jb_bypass.mp4 type=video/mp4></video><p>Nevertheless, this technique is <strong>not persistent</strong> and version-dependant.</p><p>After writing this post, it turned out that its structure is very close to <a href=https://hot3eed.github.io/2020/08/02/starling_p2_detections_mitigations.html>Reverse Engineering Starling Bank</a>.
In particular, we can find the same anti-debug and the same Frida detection routine. These similarities suggest
that these two application uses the same obfuscator that also provides <code>anti-{jb, frida, debug}</code> as built-in.</p><p>You might also be interested in the recent talk of <a href=https://twitter.com/elvanderb>Eloi Benoist-Vanderbeken</a> <a href=https://2021.pass-the-salt.org/>@Pass the Salt</a>
<a href=https://archives.pass-the-salt.org/Pass%20the%20SALT/2021/videos/PTS2021-Talk-01-JailBreak_detection.mp4><i class="fas fa-laptop-code pr-1 fa-fw"></i></a>
<a href=https://archives.pass-the-salt.org/Pass%20the%20SALT/2021/slides/PTS2021-Talk-01-JailBreak_detection.pdf><i class="fas fa-file-pdf pr-1 fa-fw"></i></a>
who detailed another approach to identify and bypass
jailbreak detections.</p><div class="alert alert-info" role=alert style=border:none!important;background-color:#fafcff><a href=https://lief-project.github.io>LIEF</a> is a tool developed at <a href=https://www.quarkslab.com/>Quarkslab</a> along with
<a href=https://qbdi.quarkslab.com>QBDI</a> & <a href=https://triton.quarkslab.com>Triton</a>.</div><hr><h3 id=annexes>Annexes</h3><table><thead><tr><th>Files that trigger the JB detection</th><th>Files that should be present</th></tr></thead><tbody><tr><td><code>/.bootstrapped_electra</code></td><td><code>/cores</code></td></tr><tr><td><code>/Applications/Anemone.app</code></td><td><code>/dev/null</code></td></tr><tr><td><code>/Applications/Cydia.app</code></td><td><code>/etc/hosts</code></td></tr><tr><td><code>/Applications/SafeMode.app</code></td><td><code>/etc/passwd</code></td></tr><tr><td><code>/Library/Frameworks/CydiaSubstrate.framework</code></td><td><code>/sbin</code></td></tr><tr><td><code>/Library/MobileSubstrate/DynamicLibraries/FlyJB.dylb</code></td><td><code>/sbin/launchd</code></td></tr><tr><td><code>/Library/MobileSubstrate/MobileSubstrate.dylib</code></td><td><code>/sbin/mount</code></td></tr><tr><td><code>/Library/PreferenceBundles/LaunchInSafeMode.bundle</code></td><td><code>/usr</code></td></tr><tr><td><code>/Library/PreferenceLoader/Preferences/LaunchInSafeMode.plist</code></td><td></td></tr><tr><td><code>/Library/Themes</code></td><td></td></tr><tr><td><code>/Library/dpkg/info/com.inoahdev.launchinsafemode.list</code></td><td></td></tr><tr><td><code>/Library/dpkg/info/com.inoahdev.launchinsafemode.md5sums</code></td><td></td></tr><tr><td><code>/bin/bash</code></td><td></td></tr><tr><td><code>/bin/bunzip2</code></td><td></td></tr><tr><td><code>/bin/bzip2</code></td><td></td></tr><tr><td><code>/bin/cat</code></td><td></td></tr><tr><td><code>/bin/chgrp</code></td><td></td></tr><tr><td><code>/bin/chmod</code></td><td></td></tr><tr><td><code>/bin/chown</code></td><td></td></tr><tr><td><code>/bin/cp</code></td><td></td></tr><tr><td><code>/bin/grep</code></td><td></td></tr><tr><td><code>/bin/gzip</code></td><td></td></tr><tr><td><code>/bin/kill</code></td><td></td></tr><tr><td><code>/bin/ln</code></td><td></td></tr><tr><td><code>/bin/ls</code></td><td></td></tr><tr><td><code>/bin/mkdir</code></td><td></td></tr><tr><td><code>/bin/mv</code></td><td></td></tr><tr><td><code>/bin/sed</code></td><td></td></tr><tr><td><code>/bin/sh</code></td><td></td></tr><tr><td><code>/bin/su</code></td><td></td></tr><tr><td><code>/bin/tar</code></td><td></td></tr><tr><td><code>/binpack</code></td><td></td></tr><tr><td><code>/bootstrap</code></td><td></td></tr><tr><td><code>/chimera</code></td><td></td></tr><tr><td><code>/electra</code></td><td></td></tr><tr><td><code>/etc/apt</code></td><td></td></tr><tr><td><code>/etc/profile</code></td><td></td></tr><tr><td><code>/jb</code></td><td></td></tr><tr><td><code>/private/var/binpack</code></td><td></td></tr><tr><td><code>/private/var/checkra1n.dmg</code></td><td></td></tr><tr><td><code>/private/var/lib/apt</code></td><td></td></tr><tr><td><code>/usr/bin/diff</code></td><td></td></tr><tr><td><code>/usr/bin/hostinfo</code></td><td></td></tr><tr><td><code>/usr/bin/killall</code></td><td></td></tr><tr><td><code>/usr/bin/passwd</code></td><td></td></tr><tr><td><code>/usr/bin/recache</code></td><td></td></tr><tr><td><code>/usr/bin/tar</code></td><td></td></tr><tr><td><code>/usr/bin/which</code></td><td></td></tr><tr><td><code>/usr/bin/xargs</code></td><td></td></tr><tr><td><code>/usr/lib/SBInject</code></td><td></td></tr><tr><td><code>/usr/lib/SBInject.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/TweakInject</code></td><td></td></tr><tr><td><code>/usr/lib/TweakInject.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/TweakInjectMapsCheck.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/libjailbreak.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/libsubstitute.0.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/libsubstitute.dylib</code></td><td></td></tr><tr><td><code>/usr/lib/libsubstrate.dylib</code></td><td></td></tr><tr><td><code>/usr/libexec/sftp-server</code></td><td></td></tr><tr><td><code>/usr/sbin/sshd</code></td><td></td></tr><tr><td><code>/usr/share/terminfo</code></td><td></td></tr><tr><td><code>/var/mobile/Library/.sbinjectSafeMode</code></td><td></td></tr><tr><td><code>/var/mobile/Library/Preferences/jp.akusio.kernbypass.plist</code></td><td></td></tr></tbody></table><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>iPhone 6 running on iOS 14.2 with checkra1n.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>We can identify them by trial and error.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>ETA: likely by the end of the year&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>The Mach-O format is very suitable for this feature as
the header in mapped in memory. Therefore, it eases the parsing.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>More generally, it can encode local data (strings, bytes arrays, &mldr;)&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>Protobuf strings can be identified as they usually start with <code>0xA</code>, <code>0xB</code>, followed by their lengths
and the string itself (see: <a href=https://developers.google.com/protocol-buffers/docs/encoding#strings>protocol-buffers/docs/encoding</a>)&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script></body></html>