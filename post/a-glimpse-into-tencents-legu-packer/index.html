<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=manifest href=manifest.webmanifest><link rel=icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_32x32_fill_box_center_3.png><link rel=apple-touch-icon type=image/png href=/img/favicon/favicon_hu2a60c33e6cc729e53465c846fe50d8b2_13867_192x192_fill_box_center_3.png><meta name=description content="Analysis of Tencent Legu: a packer for Android applications."><meta name=keywords content="android,reverse engineering,packer"><meta property="og:type" content="article"><meta property="og:description" content="Analysis of Tencent Legu: a packer for Android applications."><meta property="og:title" content="A Glimpse Into Tencent's Legu Packer | Romain Thomas"><meta property="og:site_name" content="Romain Thomas"><meta property="og:image" content="https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/featured.png"><meta property="og:url" content="https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2019-11-26T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-14T15:55:15+02:00"><meta property="article:tag" content="android"><meta property="article:tag" content="reverse engineering"><meta property="article:tag" content="packer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@rh0main"><meta name=twitter:creator content="@rh0main"><meta name=twitter:title content="A Glimpse Into Tencent's Legu Packer | Romain Thomas"><meta name=twitter:description content="Analysis of Tencent Legu: a packer for Android applications."><meta name=twitter:domain content="https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/"><meta property="twitter:image" content="https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/featured.png"><title>Romain Thomas</title><link rel=canonical href=https://www.romainthomas.fr/post/a-glimpse-into-tencents-legu-packer/><link rel=stylesheet href=/css/fa-all.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.core.min.css><link rel=stylesheet href=/vendor/@glidejs/glide/dist/css/glide.theme.min.css><link rel=stylesheet href=/css/theme.bundle.css><style>.hide{opacity:0}</style><noscript><style>.hide{opacity:1;!important}</style></noscript><style>.hero_background{position:relative;overflow:hidden}.hero_background:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:90%;z-index:1;opacity:.2;background-image:url(/img/bg_home.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.project_bg{position:relative;overflow:hidden}.project_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_project.svg);background-repeat:repeat;background-position:50%;background-size:100%;transform:rotate(180deg)}.experience_bg{position:relative;overflow:hidden}.experience_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:100%;z-index:1;opacity:.1;background-image:url(/img/bg_experience.svg);background-position:0 0;background-size:100%}.post_bg{position:relative;overflow:hidden}.post_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.6;background-image:url(/img/bg_post.svg);background-position:0 0;background-size:100%}.contact_bg{position:relative;overflow:hidden}.contact_bg:before{pointer-events:none;content:' ';display:block;position:absolute;left:0;top:0;width:100%;height:80%;z-index:1;opacity:.2;background-image:url(/img/bg_contact.svg);background-position:0 0;background-size:100%}.footnotes p{margin-bottom:0}.highlight{padding-left:20px;border-left:1px solid rgba(0,0,0,.1);border-radius:2px 2px}</style></head><body><header class=header-global><nav id=navbar-main aria-label="Primary navigation" class="navbar navbar-main navbar-expand-lg navbar-theme-primary headroom navbar-dark"><div class="container position-relative"><a class="navbar-brand me-lg-5" href=https://www.romainthomas.fr/><span class="navbar-brand-dark ft-ananda">R. T</span>
<span class="navbar-brand-light ft-ananda">R. T</span></a><div class="navbar-collapse collapse me-auto" id=navbar_global><div class=navbar-collapse-header><div class=row><div class="col-6 collapse-close"><a href=#navbar_global class="fas fa-times" data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false title=close aria-label="Toggle navigation"></a></div></div></div><ul class="navbar-nav navbar-nav-hover align-items-lg-center"><li class=nav-item><a href=https://www.romainthomas.fr/#about class="nav-link fw-bold"><span class="fa-regular fa-person-swimming"></span> About</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#posts class="nav-link fw-bold"><span class="fa-regular fa-blog"></span> Posts</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#projects class="nav-link fw-bold"><span class="fa-regular fa-terminal"></span> Projects</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#publications class="nav-link fw-bold"><span class="far fa-book-open-cover"></span> Publications</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#work-experience class="nav-link fw-bold"><span class="fa-regular fa-briefcase"></span> Work Experience</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#misc class="nav-link fw-bold"><span class="fa-regular fa-chart-network"></span> Misc</a></li><li class=nav-item><a href=https://www.romainthomas.fr/#contact class="nav-link fw-bold"><span class="fa-regular fa-binary-lock"></span> Contact</a></li></ul></div><div class="d-flex align-items-center"><button class="navbar-toggler ms-2 collapsed" type=button data-bs-toggle=collapse data-bs-target=#navbar_global aria-controls=navbar_global aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button></div></div></nav></header><main><section class="section-header pb-5 pb-sm-7 bg-primary text-white post_bg"><div class=container><div class="row justify-content-center"><div class="col-12 col-lg-10 text-center"><div class=mb-4><a href=/categories/android/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Android</span>
</a><a href=/categories/reverse-engineering/><span class="me-2 badge alert-info text-uppercase px-3 btn-outline-primary">Reverse Engineering</span></a></div><h1 class="display-3 mb-4 px-lg-5">A Glimpse Into Tencent's Legu Packer</h1><div class=post-meta><span class="fw-bold me-3">Romain Thomas</span>
<span class="post-date me-3">November 26, 2019</span>
<span class=fw-bold>5 min read</span></div></div></div></div><figure class="position-absolute bottom-0 left-0 w-100 d-none d-md-block mb-n2"><svg class="fill-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 3e3 185.4"><path d="M3e3.0v185.4H0V0c496.4 115.6 996.4 173.4 15e2 173.4S2503.6 115.6 3e3.0z"/></svg></figure></section><section class="section section-lg pt-0 pb-0" id=featured><div class="container mt-n8 mt-lg-n10 z-2 pb-0"><div class="row mt-7 mx-10"><img src=/post/a-glimpse-into-tencents-legu-packer/featured.png class="rounded img-fluid" alt=featured.png></div></div></section><div class="section section-sm bg-white pt-4 pt-lg-4 text-black"><article class=container><div class="row justify-content-center"><div class="col-12 col-lg-9"><p><style>.packedfile{color:green;font-family:lucida console,monospace}.keyfile{color:blue;font-family:lucida console,monospace}.libshell{color:tomato;font-family:lucida console,monospace}.tencentclass{color:#df2b04;font-family:lucida console,monospace}</style><div class="col-12 col-md-12 mb-4 mb-lg-4 mt-4"><div class="p-4 rounded col-12 alert alert-info" style=background-color:#fafcff><div class="d-flex px-3"><div><div class="icon icon-sm icon-secondary"><span class="fa-duotone fa-link-horizontal" style=color:#084298></span></div></div><div class=ps-4><span class="h6 m-0 mb-1" style=color:#084298>This post has been originally posted on the <a href=https://blog.quarkslab.com/a-glimpse-into-tencents-legu-packer.html>Quarkslab&rsquo;s Blog</a></span></div></div></div></div><h2 id=introduction>Introduction</h2><p>This blog post deals with the Legu packer, an Android protector developed by Tencent that is currently one of the
state-of-the-art solutions to protect APK DEX files. The packer is updated frequently and this blog post focuses on
versions <code>4.1.0.15</code> and <code>4.1.0.18</code>.</p><h2 id=overview>Overview</h2><p>An application protected with Legu is composed of two native libraries: <span class=libshell>libshell-super.2019.so</span>
and <code>libshella-4.1.0.XY.so</code> as well as raw binary files embedded in the resources of the APK:</p><ul><li><span class=keyfile>tosversion</span></li><li><span class=packedfile>0OO00l111l1l</span></li><li><code>0OO00oo01l1l</code></li><li><code>o0oooOO0ooOo.dat</code></li></ul><p>The main logic of the packer is located in the native library <span class=libshell>libshell-super.2019.so</span> which basically
unpacks and loads the protected DEX files from the resources.</p><p>Some functions of the library are obfuscated but thanks to Frida/QBDI their analysis is not a big deal.</p><h2 id=internals>Internals</h2><p>Basically, the original DEX files are located in the <span class=packedfile>assets/0OO00l111l1l</span> file along with the information required to
unpack them.</p><p>The following figure lays out the structure of this file.</p><p><img src=packed_file.png alt></p><p>In the <span class=packedfile>assets/0OO00l111l1l</span> file, the first part contains the original DEX files with the same number of <code>classes&lt;N>.dex</code> according to the multi-DEX feature of the original APK. These
DEX files are not exactly the original ones, as their Dalvik bytecode have been <em>NOP-ed</em> by Legu.
Therefore, a dump of these files only gives information about the classes&rsquo; names, not the code logic:</p><p><img src=noped.png alt></p><p>Then follows what we called a <em>hashmap</em> that is used to link a class name (e.g. <span class=tencentclass>Lcom/tencent/mmkv/MMKV;</span>) to an offset in
the data block located in the third part of the file.
This data block contains the original Dalvik bytecode of the methods.</p><p>Actually, the first part that contains the altered DEX files, is compressed with <strong>NRV</strong> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.
The second part — the hashmap — is also compressed with NRV but the packer adds a layer of
encryption through a slightly modified version of <strong>XTEA</strong> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. Finally, the last part is compressed and encrypted with the
same algorithms as the previous one.</p><p>Regarding the <em>hashmap</em>, it uses a custom structure that has been reversed and lead to a Kaitai structure available
here: <a href=https://github.com/quarkslab/legu_unpacker_2019/blob/master/legu_packed_file.ksy>legu_packed_file.ksy</a>, <a href=https://github.com/quarkslab/legu_unpacker_2019/blob/master/legu_hashmap.ksy>legu_hashmap.ksy</a></p><p>Its overall layout is exposed in the next figure:</p><p><img src=hashmap.png alt></p><h2 id=unpacking-process>Unpacking process</h2><p>Let&rsquo;s say that the application needs to use the packed Java class <span class=tencentclass>Lcom/tencent/mmkv/MMKV;</span>.</p><p>First, the packer&rsquo;s runtime transforms the class name into an integer with the <code>dvmComputeUtf8Hash()</code> hash function <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. This integer is then used
as an index into the <em>hashmap</em> whose value is a structure that contains information about the class in the packed data (blue area in
the figure). The first attribute of this structure — <code>utf8_hash</code> — is a copy of the hash value which is used to check that it is the right key/value association.</p><p>The <code>class_info</code> structure (blue block in the figure) next contains the packed method information (yellow area in the figure) whose size is the same as the original number of
methods in the class. This structure makes the relationship between the NOP-ed bytecode offset in the altered DEX
files and the offset in the original bytecode (red block).
Finally, the packer copies the original bytecode into the altered DEX files.</p><p>To summarize, the first part contains the original DEX files with the Dalvik bytecode removed (<em>NOP-ed</em>).
The last part contains the missing Dalvik bytecode and the second part makes the
bridge between the altered DEX files and the Dalvik bytecode.</p><h1 id=compression--encryption>Compression & Encryption</h1><p>To decrypt the hashmap and the Dalvik bytecode, the packer uses the first 16 bytes of <span class=keyfile>assets/tosversion</span>
xored with a hard-coded key: <code>^hHc7Ql]N9Z4:+1m~nTcA&3a7|?GB1z@</code>.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>LIB_KEY <span style=color:#666>=</span> <span style=color:#ba2121>b</span><span style=color:#ba2121>&#34;^hHc7Ql]N9Z4:+1m~nTcA&amp;3a7|?GB1z@&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>key_derivation</span>(key: <span style=color:green>bytes</span>) <span style=color:#666>-&gt;</span> <span style=color:green>bytes</span>:
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:green>bytes</span>(x1 <span style=color:#666>^</span> x2 <span style=color:green;font-weight:700>for</span> x1, x2 <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>zip</span>(LIB_KEY, cycle(key)))
</span></span></code></pre></div><p>Then, it uses a slightly modified version of XTEA that is given in the next listing:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#b00040>int</span> <span style=color:#00f>xtea_decrypt</span>(<span style=color:#b00040>uint32_t</span><span style=color:#666>*</span> key, <span style=color:#b00040>uint32_t</span><span style=color:#666>*</span> buf, size_t ilen, size_t nb_round) {
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> size_t count <span style=color:#666>=</span> ilen <span style=color:#666>/</span> <span style=color:#666>8</span>;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> size_t key_off <span style=color:#666>=</span> (ilen <span style=color:#666>&amp;</span> <span style=color:#666>8</span>) <span style=color:#666>/</span> <span style=color:#666>4</span>;
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>static</span> <span style=color:green;font-weight:700>constexpr</span> <span style=color:#b00040>uint32_t</span> DELTA <span style=color:#666>=</span> <span style=color:#666>0x9e3779b9</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>uint32_t</span> key_0 <span style=color:#666>=</span> key[key_off <span style=color:#666>+</span> <span style=color:#666>0</span>];
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>const</span> <span style=color:#b00040>uint32_t</span> key_1 <span style=color:#666>=</span> key[key_off <span style=color:#666>+</span> <span style=color:#666>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>for</span> (size_t i <span style=color:#666>=</span> <span style=color:#666>0</span>; i <span style=color:#666>&lt;</span> count <span style=color:#666>*</span> <span style=color:#666>2</span>; i <span style=color:#666>+=</span> <span style=color:#666>2</span>) {
</span></span><span style=display:flex><span>    buf[i <span style=color:#666>+</span> <span style=color:#666>0</span>] <span style=color:#666>^=</span> key_0;
</span></span><span style=display:flex><span>    buf[i <span style=color:#666>+</span> <span style=color:#666>1</span>] <span style=color:#666>^=</span> key_1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>uint32_t</span> sum <span style=color:#666>=</span> DELTA <span style=color:#666>*</span> nb_round;
</span></span><span style=display:flex><span>    <span style=color:#b00040>uint32_t</span> temp0 <span style=color:#666>=</span> buf[i <span style=color:#666>+</span> <span style=color:#666>0</span>];
</span></span><span style=display:flex><span>    <span style=color:#b00040>uint32_t</span> temp1 <span style=color:#666>=</span> buf[i <span style=color:#666>+</span> <span style=color:#666>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> (size_t j <span style=color:#666>=</span> <span style=color:#666>0</span>; j <span style=color:#666>&lt;</span> nb_round; <span style=color:#666>++</span>j) {
</span></span><span style=display:flex><span>      temp1 <span style=color:#666>-=</span> (key[<span style=color:#666>2</span>] <span style=color:#666>+</span> (temp0 <span style=color:#666>&lt;&lt;</span> <span style=color:#666>4</span>)) <span style=color:#666>^</span> (key[<span style=color:#666>3</span>] <span style=color:#666>+</span> (temp0 <span style=color:#666>&gt;&gt;</span> <span style=color:#666>5</span>)) <span style=color:#666>^</span> (temp0 <span style=color:#666>+</span> sum);
</span></span><span style=display:flex><span>      temp0 <span style=color:#666>-=</span> (key[<span style=color:#666>0</span>] <span style=color:#666>+</span> (temp1 <span style=color:#666>&lt;&lt;</span> <span style=color:#666>4</span>)) <span style=color:#666>^</span> (key[<span style=color:#666>1</span>] <span style=color:#666>+</span> (temp1 <span style=color:#666>&gt;&gt;</span> <span style=color:#666>5</span>)) <span style=color:#666>^</span> (temp1 <span style=color:#666>+</span> sum);
</span></span><span style=display:flex><span>      sum <span style=color:#666>-=</span> DELTA;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    buf[i <span style=color:#666>+</span> <span style=color:#666>0</span>] <span style=color:#666>=</span> temp0;
</span></span><span style=display:flex><span>    buf[i <span style=color:#666>+</span> <span style=color:#666>1</span>] <span style=color:#666>=</span> temp1;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>return</span> <span style=color:#666>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After the decryption routine, the packer decompresses the data with <code>NRV</code>, the same algorithm used to compress the altered DEX
files:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>key <span style=color:#666>=</span> key_derivation(<span style=color:green>open</span>(<span style=color:#ba2121>&#34;assets/tosversion&#34;</span>, <span style=color:#ba2121>&#34;rb&#34;</span>)<span style=color:#666>.</span>read()[:<span style=color:#666>16</span>])
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>for</span> i <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>range</span>(nb_dex_files):
</span></span><span style=display:flex><span>  hashmap[i]          <span style=color:#666>=</span> nrv_decompress(xtea_decrypt(blob1, key))
</span></span><span style=display:flex><span>  dalvik_bytecodes[i] <span style=color:#666>=</span> nrv_decompress(xtea_decrypt(blob2, key))
</span></span></code></pre></div><h2 id=unpacking>Unpacking</h2><p>Putting all the pieces together, we can <strong>statically</strong> unpack protected APKs and recover the original bytecode:</p><p><img src=unpacked.png alt></p><p>Hence, as we can automatically unpack such APKs, the unpacking process could be integrated into an automatic analysis pipeline.</p><p>The script and the Kaitai structures are available on the Quarkslab&rsquo;s repository: <a href=https://github.com/quarkslab/legu_unpacker_2019>legu_unpacker_2019</a>,
along with a suspicious application <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>, <a href=https://github.com/quarkslab/legu_unpacker_2019/blob/master/samples/com.intotherain.voicechange.apk>packed</a> and <a href=https://github.com/quarkslab/legu_unpacker_2019/blob/master/samples/com.intotherain.voicechange_unpacked.apk>unpacked</a>.</p><h2 id=acknowledgments>Acknowledgments</h2><p>Thanks to my colleagues who proofread this article.</p><h3 id=references>References</h3><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=http://www.oberhumer.com/opensource/ucl/>http://www.oberhumer.com/opensource/ucl/</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/XTEA>https://en.wikipedia.org/wiki/XTEA</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=http://androidxref.com/4.4.4_r1/xref/dalvik/vm/UtfString.cpp#88>http://androidxref.com/4.4.4_r1/xref/dalvik/vm/UtfString.cpp#88</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://www.virustotal.com/gui/file/708e6967920dcf2789b7183d714e73ab79a2f8b3ca71929b12aadeb2c58c2867/detection>https://www.virustotal.com/gui/file/708e6967920dcf2789b7183d714e73ab79a2f8b3ca71929b12aadeb2c58c2867/detection</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></p></div></div></div></div></main><script src=/vendor/bootstrap/dist/js/bootstrap.min.js></script>
<script src=/vendor/headroom.js/dist/headroom.min.js></script>
<script src=/vendor/onscreen/dist/on-screen.umd.min.js></script>
<script src=/vendor/jarallax/dist/jarallax.min.js></script>
<script src=/vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js></script>
<script src=/js/theme.bundle.js></script>
<script src=/vendor/@glidejs/glide/dist/glide.min.js></script>
<script src=/js/anime.min.js></script></body></html>